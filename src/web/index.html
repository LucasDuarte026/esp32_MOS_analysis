<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coleta - MOSFET Analysis</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="dashboard.css">
</head>

<body>
    <!-- Main Container -->
    <div class="app-container">

        <!-- Vertical Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <rect width="32" height="32" rx="8" fill="white" opacity="0.1" />
                        <path d="M16 8L24 12V20L16 24L8 20V12L16 8Z" stroke="white" stroke-width="2" fill="none" />
                        <circle cx="16" cy="16" r="3" fill="white" />
                    </svg>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="/" class="nav-btn active" title="Coleta de Dados">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18" />
                        <path d="M18 17V9" />
                        <path d="M13 17V5" />
                        <path d="M8 17v-3" />
                    </svg>
                </a>

                <a href="/visualization" class="nav-btn" title="Visualização de Dados">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" />
                        <path d="M8 21h8" />
                        <path d="M12 17v4" />
                    </svg>
                </a>

                <a href="/email" class="nav-btn" title="Enviar Relatório">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
                    </svg>
                </a>
            </nav>

            <div class="sidebar-footer">
                <button class="sidebar-settings" id="btn-open-logs">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">

            <!-- Data Collection Section -->
            <section id="page-collection" class="page-content">
                <header class="page-header">
                    <div class="header-text">
                        <h1>Coleta de Dados</h1>
                        <p class="subtitle">Sweep VDS/VGS para caracterização de MOSFET</p>
                    </div>
                    <div class="header-actions">
                        <div class="status-indicator" id="header-status-indicator">
                            <span class="status-dot" id="header-status-dot"></span>
                            <span id="header-status-text">Verificando...</span>
                        </div>
                    </div>
                </header>

                <div class="content-grid">
                    <!-- Configuration Card -->
                    <div class="card card-large">
                        <div class="card-header">
                            <h2>Configurações de Medida</h2>
                        </div>
                        <div class="card-body">
                            <!-- Sweep Mode Toggle -->
                            <div class="sweep-mode-section"
                                style="margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);">
                                <h3 style="margin-bottom: var(--spacing-md);">Modo de Varredura</h3>
                                <div class="sweep-mode-toggle">
                                    <span class="mode-label mode-active" id="mode-vgs-label">Curva Id × Vgs</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sweep-mode-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="mode-label mode-dimmed" id="mode-vds-label">Curva Id × Vds</span>
                                </div>
                                <small class="helper-text"
                                    style="display: block; margin-top: var(--spacing-sm); text-align: center;">
                                    <span id="sweep-mode-desc">Varia VGS para cada VDS fixo (padrão)</span>
                                </small>
                            </div>

                            <!-- VDS Configuration Section -->
                            <div
                                style="margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);">
                                <h3 style="margin-bottom: var(--spacing-md); color: var(--accent-cyan);">VDS -
                                    Configuração
                                    VDS (Tensão Dreno-Source)</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="vds-start">Tensão Inicial VDS (V)</label>
                                        <input type="number" id="vds-start" class="input-field" min="0" max="5"
                                            step="0.01" value="0">
                                        <small class="helper-text">Início do sweep VDS (padrão: 0V)</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="vds-end">Tensão Final VDS (V)</label>
                                        <input type="number" id="vds-end" class="input-field" min="0" max="5"
                                            step="0.01" value="5.0">
                                        <small class="helper-text">Limite superior VDS (máximo: VDD)</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="vds-step">Passo VDS (V)</label>
                                        <select id="vds-step" class="select-field">
                                            <option value="0.010">0.010V (alta precisão)</option>
                                            <option value="0.050" selected>0.050V (alta resolução)</option>
                                            <option value="0.100">0.100V (balanceado)</option>
                                            <option value="0.150">0.150V</option>
                                            <option value="0.200">0.200V (rápido)</option>
                                        </select>
                                        <small class="helper-text">Incremento de tensão VDS no sweep</small>
                                    </div>
                                </div>
                            </div>

                            <!-- VGS Configuration Section -->
                            <div
                                style="margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);">
                                <h3 style="margin-bottom: var(--spacing-md); color: var(--accent-blue);">VGS -
                                    Configuração
                                    VGS (Tensão Porta-Source)</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="vgs-start">Tensão Inicial VGS (V)</label>
                                        <input type="number" id="vgs-start" class="input-field" min="0" max="5"
                                            step="0.01" value="0">
                                        <small class="helper-text">Início do sweep VGS (padrão: 0V)</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="vgs-end">Tensão Final VGS (V)</label>
                                        <input type="number" id="vgs-end" class="input-field" min="0" max="5"
                                            step="0.01" value="4.5">
                                        <small class="helper-text">Limite superior VGS (máximo: VDD, típico:
                                            0-5V)</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="vgs-step">Passo VGS (V)</label>
                                        <select id="vgs-step" class="select-field">
                                            <option value="0.010">0.010V (alta precisão)</option>
                                            <option value="0.050" selected>0.050V (padrão)</option>
                                            <option value="0.100">0.100V</option>
                                            <option value="0.150">0.150V</option>
                                            <option value="0.200">0.200V</option>
                                            <option value="0.250">0.250V (rápido)</option>
                                        </select>
                                        <small class="helper-text">Incremento de tensão VGS (recomendado: 0.05V)</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Hardware & Timing Configuration -->
                            <div style="margin-bottom: var(--spacing-lg);">
                                <h3 style="margin-bottom: var(--spacing-md);">Configuração de Hardware</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="rshunt">Resistor Shunt (Ω)</label>
                                        <input type="number" id="rshunt" class="input-field" min="0.1" max="1000"
                                            step="0.1" placeholder="Ex: 100">
                                        <small class="helper-text">Resistor na source para medição de corrente (Ids =
                                            Vsh / R)</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="settling-time">Tempo de Estabilização (ms)</label>
                                        <input type="number" id="settling-time" class="input-field" min="1" max="1000"
                                            step="1" value="5">
                                        <small class="helper-text">Tempo entre escrita DAC e leitura ADC (recomendado:
                                            5ms)</small>
                                    </div>

                                    <!-- Oversampling Toggle -->
                                    <div class="form-group">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <label for="oversampling-toggle" style="margin: 0;">Oversampling ADC</label>
                                            <span class="tooltip-trigger" tabindex="0">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                    stroke="#888" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10" />
                                                    <path d="M12 16v-4M12 8h.01" />
                                                </svg>
                                                <div class="tooltip-content">
                                                    <strong>O que é Oversampling?</strong><br><br>
                                                    Técnica que melhora a precisão do ADC fazendo múltiplas leituras
                                                    (64x) e calculando a média.<br><br>
                                                    <strong>Vantagens:</strong><br>
                                                    • Reduz ruído nas medições<br>
                                                    • Aumenta resolução efetiva de ~10 para ~15 bits<br>
                                                    • Leituras mais estáveis e reproduzíveis<br><br>
                                                    <strong>Desvantagem:</strong><br>
                                                    • Cada ponto leva ~10ms (mais lento)<br><br>
                                                    <strong>⚠️ Recomendado:</strong> Manter ativado ao usar ADC/DAC
                                                    nativos do ESP32, que são mais ruidosos que conversores externos.
                                                </div>
                                            </span>
                                        </div>
                                        <div class="sweep-mode-toggle" style="justify-content: flex-start;">
                                            <span class="mode-label mode-dimmed"
                                                id="oversampling-off-label">Desativado</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="oversampling-toggle" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                            <span class="mode-label mode-active" id="oversampling-on-label">Ativado
                                                (64x)</span>
                                        </div>
                                        <small class="helper-text">Desative para medições mais rápidas (menos
                                            precisas)</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="filename">Nome do Arquivo CSV</label>
                                        <input type="text" id="filename" class="input-field"
                                            placeholder="mosfet_caracterizacao_2024.csv">
                                        <small class="helper-text">Arquivo com timestamps, VDS, VGS, Vsh, Ids, Gm,
                                            parâmetros</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-secondary" id="btn-reset-fields">
                                    Resetar Campos
                                </button>
                                <button class="btn btn-primary" id="btn-start-collection">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M8 5v14l11-7z" />
                                    </svg>
                                    Iniciar Coleta
                                </button>
                            </div>

                            <!-- Progress Indicator -->
                            <div class="progress-section" id="progress-section" style="display: none;">
                                <div class="progress-info">
                                    <span id="progress-text">Coletando dados...</span>
                                    <span id="progress-percent">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Status Card -->
                    <div class="card card-compact">
                        <div class="card-header">
                            <h3>Status do Sistema</h3>
                        </div>
                        <div class="card-body">
                            <div class="info-row">
                                <span class="info-label">Comunicação USB</span>
                                <span class="info-value" id="connection-status">Verificando...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ID do ESP32</span>
                                <span class="info-value" id="sensor-id"
                                    style="font-family: monospace; font-size: 12px;">Carregando...</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Temperatura do Chip</span>
                                <span class="info-value" id="temperature">--°C</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Memória Livre</span>
                                <span class="info-value" id="free-heap">-- KB</span>
                            </div>
                        </div>
                    </div>

                    <!-- File Management Card (Delete All) -->
                    <div class="card card-compact" style="border-color: rgba(244, 67, 54, 0.3);">
                        <div class="card-header">
                            <h3 style="color: var(--danger-color, #F44336);">Gerenciamento de Dados</h3>
                        </div>
                        <div class="card-body">
                            <p style="margin-bottom: 12px; font-size: 14px; color: #bbb;">
                                Ações críticas de armazenamento. Tenha cuidado.
                            </p>
                            <button class="btn btn-danger" id="btn-delete-all" style="width: 100%;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                DELETAR TUDO
                            </button>
                        </div>
                    </div>

                </div>
            </section>

        </main>
    </div>

    <!-- Floating Logs Window -->
    <div id="floating-logs-window" class="floating-window" style="display: none;">
        <div class="floating-window-header" id="logs-window-header">
            <h3>System Logs</h3>
            <div class="floating-window-controls">
                <button class="btn-link" id="btn-clear-logs-float">Limpar</button>
                <button class="floating-window-close" id="btn-close-logs">×</button>
            </div>
        </div>
        <div class="floating-window-body">
            <div class="logs-container" id="logs-container"></div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Storage Full Modal -->
    <div id="storage-full-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content"
            style="max-width: 500px; background: var(--bg-card); border-radius: 16px; padding: 0; overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #f44336, #d32f2f); padding: 24px; text-align: center;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="white" style="margin-bottom: 12px;">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                </svg>
                <h2 style="color: white; margin: 0; font-size: 24px;">Armazenamento Cheio</h2>
            </div>

            <!-- Body -->
            <div style="padding: 24px;">
                <p style="color: var(--text-primary); font-size: 16px; margin-bottom: 16px; line-height: 1.6;">
                    O limite de armazenamento (<strong>80%</strong>) foi atingido.
                    Para iniciar uma nova medição, libere espaço removendo arquivos antigos.
                </p>

                <div
                    style="background: rgba(255, 152, 0, 0.1); border-left: 4px solid #FF9800; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #FF9800; margin: 0 0 8px 0; font-size: 14px;">⚠️ ATENÇÃO</h4>
                    <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">
                        Faça <strong>download</strong> dos arquivos importantes antes de apagá-los.
                        Esta ação é <strong>irreversível</strong> e os dados não poderão ser recuperados.
                    </p>
                </div>

                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">
                    <strong>O que fazer:</strong><br>
                    1. Vá para a aba <em>Visualização</em> para baixar e remover arquivos individualmente<br>
                    2. Ou use o botão abaixo para apagar todos os arquivos de uma vez
                </p>

                <!-- Actions -->
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <a href="/visualization" class="btn btn-primary"
                        style="flex: 1; text-decoration: none; text-align: center; min-width: 140px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                        </svg>
                        Gerenciar Arquivos
                    </a>
                    <button class="btn btn-danger" id="btn-modal-delete-all" style="flex: 1; min-width: 140px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="margin-right: 6px;">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                        </svg>
                        Apagar Tudo
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 16px 24px; border-top: 1px solid var(--border-color); text-align: center;">
                <button class="btn btn-secondary" id="btn-close-storage-modal" style="min-width: 120px;">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script src="core.js"></script>
    <script src="collection.js"></script>
</body>

</html>