#pragma once
#include <pgmspace.h>

namespace webui {
static const char kIndexHtml[] PROGMEM = "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Coleta - MOSFET Analysis</title>\n    <script src=\"https://cdn.plot.ly/plotly-2.27.0.min.js\"></script>\n    <link rel=\"stylesheet\" href=\"dashboard.css\">\n</head>\n\n<body>\n    <!-- Main Container -->\n    <div class=\"app-container\">\n\n        <!-- Vertical Sidebar -->\n        <aside class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"logo\">\n                    <svg width=\"32\" height=\"32\" viewBox=\"0 0 32 32\" fill=\"none\">\n                        <rect width=\"32\" height=\"32\" rx=\"8\" fill=\"white\" opacity=\"0.1\" />\n                        <path d=\"M16 8L24 12V20L16 24L8 20V12L16 8Z\" stroke=\"white\" stroke-width=\"2\" fill=\"none\" />\n                        <circle cx=\"16\" cy=\"16\" r=\"3\" fill=\"white\" />\n                    </svg>\n                </div>\n            </div>\n\n            <nav class=\"sidebar-nav\">\n                <a href=\"/\" class=\"nav-btn active\" title=\"Coleta de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <path d=\"M3 3v18h18\" />\n                        <path d=\"M18 17V9\" />\n                        <path d=\"M13 17V5\" />\n                        <path d=\"M8 17v-3\" />\n                    </svg>\n                </a>\n\n                <a href=\"/visualization\" class=\"nav-btn\" title=\"Visualiza\u00e7\u00e3o de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" />\n                        <path d=\"M8 21h8\" />\n                        <path d=\"M12 17v4\" />\n                    </svg>\n                </a>\n\n                <a href=\"/email\" class=\"nav-btn\" title=\"Enviar Relat\u00f3rio\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z\" />\n                    </svg>\n                </a>\n            </nav>\n\n            <div class=\"sidebar-footer\">\n                <button class=\"sidebar-settings\" id=\"btn-open-logs\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z\" />\n                    </svg>\n                </button>\n            </div>\n        </aside>\n\n        <!-- Main Content Area -->\n        <main class=\"main-content\">\n\n            <!-- Data Collection Section -->\n            <section id=\"page-collection\" class=\"page-content\">\n                <header class=\"page-header\">\n                    <div class=\"header-text\">\n                        <h1>Coleta de Dados</h1>\n                        <p class=\"subtitle\">Sweep VDS/VGS para caracteriza\u00e7\u00e3o de MOSFET</p>\n                    </div>\n                    <div class=\"header-actions\">\n                        <div class=\"status-indicator\" id=\"header-status-indicator\">\n                            <span class=\"status-dot\" id=\"header-status-dot\"></span>\n                            <span id=\"header-status-text\">Verificando...</span>\n                        </div>\n                    </div>\n                </header>\n\n                <div class=\"content-grid\">\n                    <!-- Configuration Card -->\n                    <div class=\"card card-large\">\n                        <div class=\"card-header\">\n                            <h2>Configura\u00e7\u00f5es de Medida</h2>\n                        </div>\n                        <div class=\"card-body\">\n                            <!-- Sweep Mode Toggle -->\n                            <div class=\"sweep-mode-section\"\n                                style=\"margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);\">\n                                <h3 style=\"margin-bottom: var(--spacing-md);\">Modo de Varredura</h3>\n                                <div class=\"sweep-mode-toggle\">\n                                    <span class=\"mode-label mode-active\" id=\"mode-vgs-label\">Curva Id \u00d7 Vgs</span>\n                                    <label class=\"toggle-switch\">\n                                        <input type=\"checkbox\" id=\"sweep-mode-toggle\">\n                                        <span class=\"toggle-slider\"></span>\n                                    </label>\n                                    <span class=\"mode-label mode-dimmed\" id=\"mode-vds-label\">Curva Id \u00d7 Vds</span>\n                                </div>\n                                <small class=\"helper-text\"\n                                    style=\"display: block; margin-top: var(--spacing-sm); text-align: center;\">\n                                    <span id=\"sweep-mode-desc\">Varia VGS para cada VDS fixo (padr\u00e3o)</span>\n                                </small>\n                            </div>\n\n                            <!-- VDS Configuration Section -->\n                            <div\n                                style=\"margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);\">\n                                <h3 style=\"margin-bottom: var(--spacing-md); color: var(--accent-cyan);\">VDS -\n                                    Configura\u00e7\u00e3o\n                                    VDS (Tens\u00e3o Dreno-Source)</h3>\n                                <div class=\"form-grid\">\n                                    <div class=\"form-group\">\n                                        <label for=\"vds-start\">Tens\u00e3o Inicial VDS (V)</label>\n                                        <input type=\"number\" id=\"vds-start\" class=\"input-field\" min=\"0\" max=\"5\"\n                                            step=\"0.01\" value=\"0\">\n                                        <small class=\"helper-text\">In\u00edcio do sweep VDS (padr\u00e3o: 0V)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"vds-end\">Tens\u00e3o Final VDS (V)</label>\n                                        <input type=\"number\" id=\"vds-end\" class=\"input-field\" min=\"0\" max=\"5\"\n                                            step=\"0.01\" value=\"5.0\">\n                                        <small class=\"helper-text\">Limite superior VDS (m\u00e1ximo: VDD)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"vds-step\">Passo VDS (V)</label>\n                                        <select id=\"vds-step\" class=\"select-field\">\n                                            <option value=\"0.05\" selected>0.05V (alta resolu\u00e7\u00e3o)</option>\n                                            <option value=\"0.10\">0.10V (balanceado)</option>\n                                            <option value=\"0.15\">0.15V</option>\n                                            <option value=\"0.20\">0.20V (r\u00e1pido)</option>\n                                        </select>\n                                        <small class=\"helper-text\">Incremento de tens\u00e3o VDS no sweep</small>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- VGS Configuration Section -->\n                            <div\n                                style=\"margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);\">\n                                <h3 style=\"margin-bottom: var(--spacing-md); color: var(--accent-blue);\">VGS -\n                                    Configura\u00e7\u00e3o\n                                    VGS (Tens\u00e3o Porta-Source)</h3>\n                                <div class=\"form-grid\">\n                                    <div class=\"form-group\">\n                                        <label for=\"vgs-start\">Tens\u00e3o Inicial VGS (V)</label>\n                                        <input type=\"number\" id=\"vgs-start\" class=\"input-field\" min=\"0\" max=\"5\"\n                                            step=\"0.01\" value=\"0\">\n                                        <small class=\"helper-text\">In\u00edcio do sweep VGS (padr\u00e3o: 0V)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"vgs-end\">Tens\u00e3o Final VGS (V)</label>\n                                        <input type=\"number\" id=\"vgs-end\" class=\"input-field\" min=\"0\" max=\"5\"\n                                            step=\"0.01\" value=\"4.5\">\n                                        <small class=\"helper-text\">Limite superior VGS (m\u00e1ximo: VDD, t\u00edpico:\n                                            0-5V)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"vgs-step\">Passo VGS (V)</label>\n                                        <select id=\"vgs-step\" class=\"select-field\">\n                                            <option value=\"0.01\">0.01V (precis\u00e3o)</option>\n                                            <option value=\"0.05\" selected>0.05V (padr\u00e3o)</option>\n                                            <option value=\"0.1\">0.10V</option>\n                                            <option value=\"0.15\">0.15V</option>\n                                            <option value=\"0.2\">0.20V</option>\n                                            <option value=\"0.25\">0.25V</option>\n                                        </select>\n                                        <small class=\"helper-text\">Incremento de tens\u00e3o VGS (recomendado: 0.05V)</small>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- Hardware & Timing Configuration -->\n                            <div style=\"margin-bottom: var(--spacing-lg);\">\n                                <h3 style=\"margin-bottom: var(--spacing-md);\">Configura\u00e7\u00e3o de Hardware</h3>\n                                <div class=\"form-grid\">\n                                    <div class=\"form-group\">\n                                        <label for=\"rshunt\">Resistor Shunt (\u03a9)</label>\n                                        <input type=\"number\" id=\"rshunt\" class=\"input-field\" min=\"0.1\" max=\"1000\"\n                                            step=\"0.1\" placeholder=\"Ex: 100\">\n                                        <small class=\"helper-text\">Resistor na source para medi\u00e7\u00e3o de corrente (Ids =\n                                            Vsh / R)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"settling-time\">Tempo de Estabiliza\u00e7\u00e3o (ms)</label>\n                                        <input type=\"number\" id=\"settling-time\" class=\"input-field\" min=\"1\" max=\"1000\"\n                                            step=\"1\" value=\"5\">\n                                        <small class=\"helper-text\">Tempo entre escrita DAC e leitura ADC (recomendado:\n                                            5ms)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"filename\">Nome do Arquivo CSV</label>\n                                        <input type=\"text\" id=\"filename\" class=\"input-field\"\n                                            placeholder=\"mosfet_caracterizacao_2024.csv\">\n                                        <small class=\"helper-text\">Arquivo com timestamps, VDS, VGS, Vsh, Ids, Gm,\n                                            par\u00e2metros</small>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class=\"form-actions\">\n                                <button class=\"btn btn-secondary\" id=\"btn-reset-fields\">\n                                    Resetar Campos\n                                </button>\n                                <button class=\"btn btn-primary\" id=\"btn-start-collection\">\n                                    <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                        <path d=\"M8 5v14l11-7z\" />\n                                    </svg>\n                                    Iniciar Coleta\n                                </button>\n                            </div>\n\n                            <!-- Progress Indicator -->\n                            <div class=\"progress-section\" id=\"progress-section\" style=\"display: none;\">\n                                <div class=\"progress-info\">\n                                    <span id=\"progress-text\">Coletando dados...</span>\n                                    <span id=\"progress-percent\">0%</span>\n                                </div>\n                                <div class=\"progress-bar\">\n                                    <div class=\"progress-fill\" id=\"progress-fill\"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- System Status Card -->\n                    <div class=\"card card-compact\">\n                        <div class=\"card-header\">\n                            <h3>Status do Sistema</h3>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"info-row\">\n                                <span class=\"info-label\">Comunica\u00e7\u00e3o USB</span>\n                                <span class=\"info-value\" id=\"connection-status\">Verificando...</span>\n                            </div>\n                            <div class=\"info-row\">\n                                <span class=\"info-label\">ID do ESP32</span>\n                                <span class=\"info-value\" id=\"sensor-id\"\n                                    style=\"font-family: monospace; font-size: 12px;\">Carregando...</span>\n                            </div>\n                            <div class=\"info-row\">\n                                <span class=\"info-label\">Temperatura do Chip</span>\n                                <span class=\"info-value\" id=\"temperature\">--\u00b0C</span>\n                            </div>\n                            <div class=\"info-row\">\n                                <span class=\"info-label\">Mem\u00f3ria Livre</span>\n                                <span class=\"info-value\" id=\"free-heap\">-- KB</span>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- File Management Card (Delete All) -->\n                    <div class=\"card card-compact\" style=\"border-color: rgba(244, 67, 54, 0.3);\">\n                        <div class=\"card-header\">\n                            <h3 style=\"color: var(--danger-color, #F44336);\">Gerenciamento de Dados</h3>\n                        </div>\n                        <div class=\"card-body\">\n                            <p style=\"margin-bottom: 12px; font-size: 14px; color: #bbb;\">\n                                A\u00e7\u00f5es cr\u00edticas de armazenamento. Tenha cuidado.\n                            </p>\n                            <button class=\"btn btn-danger\" id=\"btn-delete-all\" style=\"width: 100%;\">\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"\n                                    stroke-width=\"2\">\n                                    <path\n                                        d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                                </svg>\n                                DELETAR TUDO\n                            </button>\n                        </div>\n                    </div>\n\n                </div>\n            </section>\n\n        </main>\n    </div>\n\n    <!-- Floating Logs Window -->\n    <div id=\"floating-logs-window\" class=\"floating-window\" style=\"display: none;\">\n        <div class=\"floating-window-header\" id=\"logs-window-header\">\n            <h3>System Logs</h3>\n            <div class=\"floating-window-controls\">\n                <button class=\"btn-link\" id=\"btn-clear-logs-float\">Limpar</button>\n                <button class=\"floating-window-close\" id=\"btn-close-logs\">\u00d7</button>\n            </div>\n        </div>\n        <div class=\"floating-window-body\">\n            <div class=\"logs-container\" id=\"logs-container\"></div>\n        </div>\n    </div>\n\n    <!-- Toast Notification Container -->\n    <div id=\"toast-container\" class=\"toast-container\"></div>\n\n    <!-- Storage Full Modal -->\n    <div id=\"storage-full-modal\" class=\"modal-overlay\" style=\"display: none;\">\n        <div class=\"modal-content\"\n            style=\"max-width: 500px; background: var(--bg-card); border-radius: 16px; padding: 0; overflow: hidden;\">\n            <!-- Header -->\n            <div style=\"background: linear-gradient(135deg, #f44336, #d32f2f); padding: 24px; text-align: center;\">\n                <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"white\" style=\"margin-bottom: 12px;\">\n                    <path\n                        d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z\" />\n                </svg>\n                <h2 style=\"color: white; margin: 0; font-size: 24px;\">Armazenamento Cheio</h2>\n            </div>\n\n            <!-- Body -->\n            <div style=\"padding: 24px;\">\n                <p style=\"color: var(--text-primary); font-size: 16px; margin-bottom: 16px; line-height: 1.6;\">\n                    O limite de armazenamento (<strong>80%</strong>) foi atingido.\n                    Para iniciar uma nova medi\u00e7\u00e3o, libere espa\u00e7o removendo arquivos antigos.\n                </p>\n\n                <div\n                    style=\"background: rgba(255, 152, 0, 0.1); border-left: 4px solid #FF9800; padding: 16px; border-radius: 8px; margin-bottom: 20px;\">\n                    <h4 style=\"color: #FF9800; margin: 0 0 8px 0; font-size: 14px;\">\u26a0\ufe0f ATEN\u00c7\u00c3O</h4>\n                    <p style=\"color: var(--text-secondary); margin: 0; font-size: 13px;\">\n                        Fa\u00e7a <strong>download</strong> dos arquivos importantes antes de apag\u00e1-los.\n                        Esta a\u00e7\u00e3o \u00e9 <strong>irrevers\u00edvel</strong> e os dados n\u00e3o poder\u00e3o ser recuperados.\n                    </p>\n                </div>\n\n                <p style=\"color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;\">\n                    <strong>O que fazer:</strong><br>\n                    1. V\u00e1 para a aba <em>Visualiza\u00e7\u00e3o</em> para baixar e remover arquivos individualmente<br>\n                    2. Ou use o bot\u00e3o abaixo para apagar todos os arquivos de uma vez\n                </p>\n\n                <!-- Actions -->\n                <div style=\"display: flex; gap: 12px; flex-wrap: wrap;\">\n                    <a href=\"/visualization\" class=\"btn btn-primary\"\n                        style=\"flex: 1; text-decoration: none; text-align: center; min-width: 140px;\">\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\" style=\"margin-right: 6px;\">\n                            <path d=\"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z\" />\n                        </svg>\n                        Gerenciar Arquivos\n                    </a>\n                    <button class=\"btn btn-danger\" id=\"btn-modal-delete-all\" style=\"flex: 1; min-width: 140px;\">\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"\n                            stroke-width=\"2\" style=\"margin-right: 6px;\">\n                            <path d=\"M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2\" />\n                        </svg>\n                        Apagar Tudo\n                    </button>\n                </div>\n            </div>\n\n            <!-- Footer -->\n            <div style=\"padding: 16px 24px; border-top: 1px solid var(--border-color); text-align: center;\">\n                <button class=\"btn btn-secondary\" id=\"btn-close-storage-modal\" style=\"min-width: 120px;\">\n                    Fechar\n                </button>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"core.js\"></script>\n    <script src=\"collection.js\"></script>\n</body>\n\n</html>";
static const char kVisualizationHtml[] PROGMEM = "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Visualiza\u00e7\u00e3o - MOSFET Analysis</title>\n    <script src=\"https://cdn.plot.ly/plotly-2.27.0.min.js\"></script>\n    <link rel=\"stylesheet\" href=\"dashboard.css\">\n</head>\n\n<body>\n    <!-- Main Container -->\n    <div class=\"app-container\">\n\n        <!-- Vertical Sidebar -->\n        <aside class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"logo\">\n                    <svg width=\"32\" height=\"32\" viewBox=\"0 0 32 32\" fill=\"none\">\n                        <rect width=\"32\" height=\"32\" rx=\"8\" fill=\"white\" opacity=\"0.1\" />\n                        <path d=\"M16 8L24 12V20L16 24L8 20V12L16 8Z\" stroke=\"white\" stroke-width=\"2\" fill=\"none\" />\n                        <circle cx=\"16\" cy=\"16\" r=\"3\" fill=\"white\" />\n                    </svg>\n                </div>\n            </div>\n\n            <nav class=\"sidebar-nav\">\n                <a href=\"/\" class=\"nav-btn\" title=\"Coleta de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <path d=\"M3 3v18h18\" />\n                        <path d=\"M18 17V9\" />\n                        <path d=\"M13 17V5\" />\n                        <path d=\"M8 17v-3\" />\n                    </svg>\n                </a>\n\n                <a href=\"/visualization\" class=\"nav-btn active\" title=\"Visualiza\u00e7\u00e3o de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" />\n                        <path d=\"M8 21h8\" />\n                        <path d=\"M12 17v4\" />\n                    </svg>\n                </a>\n\n                <a href=\"/email\" class=\"nav-btn\" title=\"Enviar Relat\u00f3rio\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z\" />\n                    </svg>\n                </a>\n            </nav>\n\n            <div class=\"sidebar-footer\">\n                <button class=\"sidebar-settings\" id=\"btn-open-logs\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z\" />\n                    </svg>\n                </button>\n            </div>\n        </aside>\n\n        <!-- Main Content Area -->\n        <main class=\"main-content\">\n\n            <!-- Data Visualization Section -->\n            <section id=\"page-visualization\" class=\"page-content\">\n                <header class=\"page-header\">\n                    <div class=\"header-text\">\n                        <h1>Visualiza\u00e7\u00e3o de Dados</h1>\n                        <p class=\"subtitle\">An\u00e1lise interativa de curvas MOSFET</p>\n                    </div>\n                </header>\n\n                <!-- File Selector Card - Reorganized -->\n                <div class=\"card\" style=\"margin-bottom: var(--spacing-lg);\">\n                    <div class=\"card-body\">\n                        <!-- Row 1: File Select + Download Button -->\n                        <div style=\"display: flex; gap: 16px; align-items: flex-end; margin-bottom: 16px;\">\n                            <div class=\"form-group\" style=\"flex: 2;\">\n                                <label for=\"file-select\">Selecionar Medida</label>\n                                <select id=\"file-select\" class=\"select-field\">\n                                    <option value=\"\">-- Selecione uma medida --</option>\n                                </select>\n                            </div>\n                            <button class=\"btn btn-secondary\" id=\"btn-download-measurement\" disabled>\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                    <path d=\"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z\" />\n                                </svg>\n                                Download CSV\n                            </button>\n                            <button class=\"btn btn-danger\" id=\"btn-delete-measurement\" disabled\n                                title=\"Deletar arquivo permanentemente\" style=\"margin-left: 8px;\">\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"\n                                    stroke-width=\"2\">\n                                    <path d=\"M3 6h18\" />\n                                    <path\n                                        d=\"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2\" />\n                                </svg>\n                            </button>\n                        </div>\n\n                        <!-- Row 2: VDS/VGS Curve Selector -->\n                        <div class=\"form-group\">\n                            <label for=\"vds-select\" id=\"curve-select-label\">Selecionar Curva VDS</label>\n                            <select id=\"vds-select\" class=\"select-field\" disabled>\n                                <option value=\"\">Aguardando arquivo...</option>\n                            </select>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Plot and Controls Layout - Plot on left (larger), controls on right -->\n                <div class=\"viz-layout\" style=\"display: flex; gap: 16px;\">\n                    <!-- Main Plot Card - Takes most of the space -->\n                    <div class=\"card viz-plot-card\" style=\"flex: 3; min-width: 0;\">\n                        <div class=\"card-header\">\n                            <h2>Curvas Caracter\u00edsticas MOSFET</h2>\n                        </div>\n                        <div class=\"card-body\">\n                            <div id=\"plot-container\" class=\"plot-area\" style=\"min-height: 500px;\"></div>\n                        </div>\n                    </div>\n\n                    <!-- Toggle Controls Sidebar - Compact on right -->\n                    <div class=\"card viz-controls-card\" style=\"flex: 2; min-width: 220px; max-width: 280px;\">\n                        <div class=\"card-header\">\n                            <h3>Curvas Vis\u00edveis</h3>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"toggle-group\">\n                                <button class=\"toggle-btn active\" id=\"toggle-ids\" data-curve=\"ids\">\n                                    <span class=\"toggle-indicator\" style=\"background: #2196F3;\"></span>\n                                    <span class=\"toggle-label\">IDs (Corrente)</span>\n                                </button>\n                                <button class=\"toggle-btn\" id=\"toggle-gm\" data-curve=\"gm\">\n                                    <span class=\"toggle-indicator\" style=\"background: #FF9800;\"></span>\n                                    <span class=\"toggle-label\">Gm (Transcondut\u00e2ncia)</span>\n                                </button>\n                                <button class=\"toggle-btn\" id=\"toggle-ss\" data-curve=\"ss\">\n                                    <span class=\"toggle-indicator\" style=\"background: #F44336;\"></span>\n                                    <span class=\"toggle-label\">SS (Subthreshold)</span>\n                                </button>\n                                <button class=\"toggle-btn\" id=\"toggle-vt\" data-curve=\"vt\">\n                                    <span class=\"toggle-indicator\" style=\"background: #4CAF50;\"></span>\n                                    <span class=\"toggle-label\">Vt (Limiar)</span>\n                                </button>\n                            </div>\n\n                            <!-- Log/Linear Scale Toggle -->\n                            <div\n                                style=\"margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);\">\n                                <h4 style=\"font-size: 12px; color: #888; margin-bottom: 8px;\">Escala Ids</h4>\n                                <div class=\"sweep-mode-toggle\" style=\"justify-content: center;\">\n                                    <span class=\"mode-label mode-active\" id=\"scale-linear-label\">Linear</span>\n                                    <label class=\"toggle-switch\">\n                                        <input type=\"checkbox\" id=\"scale-toggle\">\n                                        <span class=\"toggle-slider\"></span>\n                                    </label>\n                                    <span class=\"mode-label mode-dimmed\" id=\"scale-log-label\">Log</span>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Metrics Cards -->\n                <div class=\"metrics-grid\">\n                    <div class=\"card card-metric\">\n                        <div class=\"metric-icon\" style=\"background: rgba(76, 175, 80, 0.1);\">\n                            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#4CAF50\"\n                                stroke-width=\"2\">\n                                <path d=\"M3 12h18M3 6h18M3 18h18\" />\n                            </svg>\n                        </div>\n                        <div class=\"metric-content\">\n                            <h4>Threshold Voltage</h4>\n                            <div class=\"metric-value\" id=\"metric-vt\">--</div>\n                            <small class=\"metric-label\">Tens\u00e3o de Limiar</small>\n                        </div>\n                    </div>\n\n                    <div class=\"card card-metric\">\n                        <div class=\"metric-icon\" style=\"background: rgba(255, 152, 0, 0.1);\">\n                            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#FF9800\"\n                                stroke-width=\"2\">\n                                <path d=\"M13 2L3 14h9l-1 8 10-12h-9l1-8z\" />\n                            </svg>\n                        </div>\n                        <div class=\"metric-content\">\n                            <h4>Max Transconductance</h4>\n                            <div class=\"metric-value\" id=\"metric-gm\">--</div>\n                            <small class=\"metric-label\">Pico de Gm</small>\n                        </div>\n                    </div>\n\n                    <div class=\"card card-metric\">\n                        <div class=\"metric-icon\" style=\"background: rgba(244, 67, 54, 0.1);\">\n                            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#F44336\"\n                                stroke-width=\"2\">\n                                <path d=\"M18 20V10M12 20V4M6 20v-6\" />\n                            </svg>\n                        </div>\n                        <div class=\"metric-content\">\n                            <h4>Subthreshold Swing</h4>\n                            <div class=\"metric-value\" id=\"metric-ss\">--</div>\n                            <small class=\"metric-label\">Inclina\u00e7\u00e3o SS</small>\n                        </div>\n                    </div>\n                </div>\n            </section>\n\n        </main>\n    </div>\n\n    <!-- Floating Logs Window -->\n    <div id=\"floating-logs-window\" class=\"floating-window\" style=\"display: none;\">\n        <div class=\"floating-window-header\" id=\"logs-window-header\">\n            <h3>System Logs</h3>\n            <div class=\"floating-window-controls\">\n                <button class=\"btn-link\" id=\"btn-clear-logs-float\">Limpar</button>\n                <button class=\"floating-window-close\" id=\"btn-close-logs\">\u00d7</button>\n            </div>\n        </div>\n        <div class=\"floating-window-body\">\n            <div class=\"logs-container\" id=\"logs-container\"></div>\n        </div>\n    </div>\n\n    <!-- Toast Notification Container -->\n    <div id=\"toast-container\" class=\"toast-container\"></div>\n\n    <script src=\"core.js\"></script>\n    <script src=\"collection.js\"></script>\n    <script src=\"visualization.js\"></script>\n</body>\n\n</html>";
static const char kEmailHtml[] PROGMEM = "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Email - MOSFET Analysis</title>\n    <script src=\"https://cdn.plot.ly/plotly-2.27.0.min.js\"></script>\n    <link rel=\"stylesheet\" href=\"dashboard.css\">\n</head>\n\n<body>\n    <!-- Main Container -->\n    <div class=\"app-container\">\n\n        <!-- Vertical Sidebar -->\n        <aside class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"logo\">\n                    <svg width=\"32\" height=\"32\" viewBox=\"0 0 32 32\" fill=\"none\">\n                        <rect width=\"32\" height=\"32\" rx=\"8\" fill=\"white\" opacity=\"0.1\" />\n                        <path d=\"M16 8L24 12V20L16 24L8 20V12L16 8Z\" stroke=\"white\" stroke-width=\"2\" fill=\"none\" />\n                        <circle cx=\"16\" cy=\"16\" r=\"3\" fill=\"white\" />\n                    </svg>\n                </div>\n            </div>\n\n            <nav class=\"sidebar-nav\">\n                <a href=\"/\" class=\"nav-btn\" title=\"Coleta de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <path d=\"M3 3v18h18\" />\n                        <path d=\"M18 17V9\" />\n                        <path d=\"M13 17V5\" />\n                        <path d=\"M8 17v-3\" />\n                    </svg>\n                </a>\n\n                <a href=\"/visualization\" class=\"nav-btn\" title=\"Visualiza\u00e7\u00e3o de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" />\n                        <path d=\"M8 21h8\" />\n                        <path d=\"M12 17v4\" />\n                    </svg>\n                </a>\n\n                <a href=\"/email\" class=\"nav-btn active\" title=\"Enviar Relat\u00f3rio\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z\" />\n                    </svg>\n                </a>\n            </nav>\n\n            <div class=\"sidebar-footer\">\n                <button class=\"sidebar-settings\" id=\"btn-open-logs\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z\" />\n                    </svg>\n                </button>\n            </div>\n        </aside>\n\n        <!-- Main Content Area -->\n        <main class=\"main-content\">\n\n            <!-- Email Sending Section -->\n            <section id=\"page-email\" class=\"page-content\">\n                <header class=\"page-header\">\n                    <div class=\"header-text\">\n                        <h1>Enviar Relat\u00f3rio</h1>\n                        <p class=\"subtitle\">Compartilhe dados e an\u00e1lises por email</p>\n                    </div>\n                </header>\n\n                <div class=\"content-grid\">\n                    <!-- Email Form Card -->\n                    <div class=\"card card-large\">\n                        <div class=\"card-header\">\n                            <h2>Compor Email</h2>\n                        </div>\n                        <div class=\"card-body\">\n                            <form id=\"email-form\">\n                                <div class=\"form-group\">\n                                    <label for=\"email-recipients\">Email do Destinat\u00e1rio</label>\n                                    <input type=\"email\" id=\"email-recipients\" class=\"input-field\"\n                                        placeholder=\"email@exemplo.com\" required>\n                                    <small class=\"helper-text\">Separe m\u00faltiplos emails com v\u00edrgula</small>\n                                </div>\n\n                                <div class=\"form-group\">\n                                    <label for=\"email-subject\">Assunto</label>\n                                    <input type=\"text\" id=\"email-subject\" class=\"input-field\"\n                                        placeholder=\"Relat\u00f3rio de An\u00e1lise MOSFET\">\n                                </div>\n\n                                <div class=\"form-group\">\n                                    <label for=\"email-message\">Mensagem</label>\n                                    <textarea id=\"email-message\" class=\"textarea-field\" rows=\"5\"\n                                        placeholder=\"Digite sua mensagem aqui...\"></textarea>\n                                    <small class=\"helper-text\"><span id=\"char-count\">0</span> / 1000 caracteres</small>\n                                </div>\n\n                                <div class=\"form-row\">\n                                    <div class=\"form-group\">\n                                        <label for=\"email-format\">Formato do Arquivo</label>\n                                        <select id=\"email-format\" class=\"select-field\">\n                                            <option value=\"csv\">CSV (Excel)</option>\n                                            <option value=\"json\">JSON (Dados brutos)</option>\n                                            <option value=\"pdf\">PDF (Relat\u00f3rio completo)</option>\n                                        </select>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"email-measurement\">Medida</label>\n                                        <select id=\"email-measurement\" class=\"select-field\">\n                                            <option value=\"\">-- Selecione --</option>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class=\"form-group\">\n                                    <label class=\"checkbox-label\">\n                                        <input type=\"checkbox\" id=\"include-plots\" checked>\n                                        <span>Incluir gr\u00e1ficos (PNG)</span>\n                                    </label>\n                                </div>\n\n                                <div class=\"form-actions\">\n                                    <button type=\"button\" class=\"btn btn-secondary\">Salvar Rascunho</button>\n                                    <button type=\"submit\" class=\"btn btn-primary\" id=\"btn-send-email\">\n                                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\"\n                                            stroke=\"currentColor\" stroke-width=\"2\">\n                                            <path d=\"M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z\" />\n                                        </svg>\n                                        Enviar Relat\u00f3rio\n                                    </button>\n                                </div>\n                            </form>\n                        </div>\n                    </div>\n\n                    <!-- Sent Reports Card -->\n                    <div class=\"card card-compact\">\n                        <div class=\"card-header\">\n                            <h3>Relat\u00f3rios Enviados</h3>\n                            <button class=\"btn-link\">Ver Todos</button>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"reports-list\" id=\"reports-list\">\n                                <div class=\"report-item\">\n                                    <div class=\"report-info\">\n                                        <strong>Relat\u00f3rio para joao@lab.com</strong>\n                                        <small>Hoje 16:36</small>\n                                    </div>\n                                    <span class=\"badge badge-success\">Enviado</span>\n                                </div>\n                                <div class=\"report-item\">\n                                    <div class=\"report-info\">\n                                        <strong>Dados NMOS L=1.5\u03bcm</strong>\n                                        <small>Hoje 14:22</small>\n                                    </div>\n                                    <span class=\"badge badge-success\">Enviado</span>\n                                </div>\n                                <div class=\"report-item\">\n                                    <div class=\"report-info\">\n                                        <strong>An\u00e1lise completa Set 3</strong>\n                                        <small>Ontem 18:45</small>\n                                    </div>\n                                    <span class=\"badge badge-success\">Enviado</span>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </section>\n\n        </main>\n    </div>\n\n    <!-- Floating Logs Window -->\n    <div id=\"floating-logs-window\" class=\"floating-window\" style=\"display: none;\">\n        <div class=\"floating-window-header\" id=\"logs-window-header\">\n            <h3>System Logs</h3>\n            <div class=\"floating-window-controls\">\n                <button class=\"btn-link\" id=\"btn-clear-logs-float\">Limpar</button>\n                <button class=\"floating-window-close\" id=\"btn-close-logs\">\u00d7</button>\n            </div>\n        </div>\n        <div class=\"floating-window-body\">\n            <div class=\"logs-container\" id=\"logs-container\"></div>\n        </div>\n    </div>\n\n    <!-- Toast Notification Container -->\n    <div id=\"toast-container\" class=\"toast-container\"></div>\n\n    <script src=\"core.js\"></script>\n    <script src=\"collection.js\"></script>\n</body>\n\n</html>";
static const char kDashboardCss[] PROGMEM = "* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\n:root {\n    --bg-primary: #0a0e1a;\n    --bg-secondary: #131826;\n    --bg-card: #1a1f33;\n    --bg-hover: #232940;\n    --accent-blue: #4A90E2;\n    --accent-cyan: #50C9CE;\n    --accent-purple: #9B7EDE;\n    --text-primary: #E8EAF0;\n    --text-secondary: #A0A8C0;\n    --border-color: #2a3147;\n    --spacing-sm: 8px;\n    --spacing-md: 16px;\n    --spacing-lg: 24px;\n    --spacing-xl: 32px;\n    --radius-sm: 8px;\n    --radius-md: 12px;\n    --radius-lg: 16px;\n}\n\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;\n    background: var(--bg-primary);\n    color: var(--text-primary);\n    line-height: 1.6;\n    overflow-x: hidden;\n}\n\n.app-container {\n    display: flex;\n    min-height: 100vh;\n}\n\n/* Sidebar */\n.sidebar {\n    width: 80px;\n    background: var(--bg-secondary);\n    border-right: 1px solid var(--border-color);\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: var(--spacing-lg) 0;\n    position: fixed;\n    height: 100vh;\n    z-index: 100;\n}\n\n.sidebar-header {\n    margin-bottom: var(--spacing-xl);\n}\n\n.sidebar-nav {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-md);\n}\n\n.nav-btn {\n    width: 48px;\n    height: 48px;\n    border: none;\n    background: transparent;\n    color: var(--text-secondary);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.nav-btn:hover {\n    background: var(--bg-hover);\n    color: var(--accent-cyan);\n}\n\n.nav-btn.active {\n    background: var(--accent-blue);\n    color: white;\n}\n\n.sidebar-footer {\n    margin-top: auto;\n}\n\n.sidebar-settings {\n    width: 40px;\n    height: 40px;\n    border: none;\n    background: transparent;\n    color: var(--text-secondary);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.sidebar-settings:hover {\n    background: var(--bg-hover);\n    color: var(--text-primary);\n}\n\n/* Main Content */\n.main-content {\n    flex: 1;\n    margin-left: 80px;\n    padding: var(--spacing-xl);\n    max-width: 1600px;\n}\n\n.page-header {\n    margin-bottom: var(--spacing-xl);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.page-header h1 {\n    font-size: 32px;\n    font-weight: 700;\n    margin-bottom: 4px;\n}\n\n.subtitle {\n    color: var(--text-secondary);\n    font-size: 14px;\n}\n\n.status-indicator {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 8px 16px;\n    background: var(--bg-card);\n    border-radius: var(--radius-sm);\n    border: 1px solid var(--border-color);\n}\n\n.status-dot {\n    width: 8px;\n    height: 8px;\n    background: #4CAF50;\n    border-radius: 50%;\n    animation: pulse 2s infinite;\n}\n\n@keyframes pulse {\n\n    0%,\n    100% {\n        opacity: 1;\n    }\n\n    50% {\n        opacity: 0.5;\n    }\n}\n\n/* Cards */\n.card {\n    background: var(--bg-card);\n    border-radius: var(--radius-md);\n    border: 1px solid var(--border-color);\n    overflow: hidden;\n}\n\n.card-header {\n    padding: var(--spacing-lg);\n    border-bottom: 1px solid var(--border-color);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.card-header h2 {\n    font-size: 20px;\n    font-weight: 600;\n}\n\n.card-header h3 {\n    font-size: 16px;\n    font-weight: 600;\n}\n\n.card-body {\n    padding: var(--spacing-lg);\n}\n\n/* Form Elements */\n.form-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: var(--spacing-lg);\n}\n\n.form-group {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n}\n\n.form-group label {\n    font-size: 14px;\n    font-weight: 500;\n    color: var(--text-primary);\n}\n\n.input-field,\n.select-field,\n.textarea-field {\n    padding: 12px 16px;\n    background: var(--bg-secondary);\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-sm);\n    color: var(--text-primary);\n    font-size: 14px;\n    transition: all 0.3s ease;\n}\n\n/* Enable scrolling for long dropdown lists (VDS, measurements) */\n.select-field {\n    max-height: 300px;\n    overflow-y: auto;\n}\n\n/* For Firefox - native select scrolling */\nselect.select-field {\n    scrollbar-width: thin;\n    scrollbar-color: var(--accent-blue) var(--bg-secondary);\n}\n\n/* For Webkit browsers (Chrome, Safari, Edge) */\nselect.select-field::-webkit-scrollbar {\n    width: 8px;\n}\n\nselect.select-field::-webkit-scrollbar-track {\n    background: var(--bg-secondary);\n    border-radius: 4px;\n}\n\nselect.select-field::-webkit-scrollbar-thumb {\n    background: var(--accent-blue);\n    border-radius: 4px;\n}\n\nselect.select-field::-webkit-scrollbar-thumb:hover {\n    background: var(--accent-cyan);\n}\n\n.input-field:focus,\n.select-field:focus,\n.textarea-field:focus {\n    outline: none;\n    border-color: var(--accent-blue);\n    background: var(--bg-hover);\n}\n\n.helper-text {\n    font-size: 12px;\n    color: var(--text-secondary);\n}\n\n/* Buttons */\n.btn {\n    padding: 12px 24px;\n    border: none;\n    border-radius: var(--radius-sm);\n    font-size: 14px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: inline-flex;\n    align-items: center;\n    gap: 8px;\n}\n\n.btn-primary {\n    background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));\n    color: white;\n}\n\n.btn-primary:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);\n}\n\n.btn-secondary {\n    background: var(--bg-secondary);\n    color: var(--text-primary);\n    border: 1px solid var(--border-color);\n}\n\n.btn-secondary:hover {\n    background: var(--bg-hover);\n}\n\n/* Content Grid */\n.content-grid {\n    display: grid;\n    grid-template-columns: 2fr 1fr;\n    gap: var(--spacing-lg);\n}\n\n.card-large {\n    grid-column: 1 / -1;\n}\n\n/* Tab System */\n.tab-content {\n    display: none !important;\n}\n\n.tab-content.active {\n    display: block !important;\n}\n\n/* ... existing styles ... */\n\n/* Metrics Grid */\n.metrics-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: var(--spacing-lg);\n    margin-top: var(--spacing-lg);\n}\n\n/* Info Rows */\n.info-row {\n    display: flex;\n    justify-content: space-between;\n    padding: 12px 0;\n    border-bottom: 1px solid var(--border-color);\n}\n\n.info-row:last-child {\n    border-bottom: none;\n}\n\n.info-label {\n    color: var(--text-secondary);\n    font-size: 14px;\n}\n\n.info-value {\n    color: var(--text-primary);\n    font-weight: 500;\n    font-size: 14px;\n}\n\n/* Battery Indicator */\n.battery-indicator {\n    width: 60px;\n    height: 20px;\n    border: 2px solid var(--border-color);\n    border-radius: 4px;\n    padding: 2px;\n    position: relative;\n    display: inline-block;\n}\n\n.battery-indicator::after {\n    content: '';\n    position: absolute;\n    right: -6px;\n    top: 6px;\n    width: 4px;\n    height: 8px;\n    background: var(--border-color);\n    border-radius: 0 2px 2px 0;\n}\n\n.battery-level {\n    height: 100%;\n    background: linear-gradient(90deg, #4CAF50, #8BC34A);\n    border-radius: 2px;\n    transition: width 0.3s ease;\n}\n\n/* Logs */\n.logs-container {\n    max-height: 200px;\n    overflow-y: auto;\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n}\n\n.log-entry {\n    padding: 8px 12px;\n    background: var(--bg-secondary);\n    border-radius: var(--radius-sm);\n    border-left: 3px solid transparent;\n    font-size: 13px;\n}\n\n.log-info {\n    border-left-color: var(--accent-blue);\n    background: rgba(74, 144, 226, 0.05);\n}\n\n.log-success {\n    border-left-color: #4CAF50;\n}\n\n.log-error {\n    border-left-color: #F44336;\n    background: rgba(244, 67, 54, 0.05);\n}\n\n.log-warn {\n    border-left-color: #FF9800;\n    background: rgba(255, 152, 0, 0.05);\n}\n\n.log-debug {\n    border-left-color: #9E9E9E;\n    background: rgba(158, 158, 158, 0.03);\n}\n\n.log-level {\n    margin-right: 12px;\n    font-size: 11px;\n    font-weight: 600;\n    font-family: 'Courier New', monospace;\n    opacity: 0.8;\n}\n\n.log-message {\n    flex: 1;\n}\n\n.log-time {\n    color: var(--text-secondary);\n    margin-right: 12px;\n}\n\n/* Progress Bar */\n.progress-section {\n    margin-top: var(--spacing-lg);\n    padding-top: var(--spacing-lg);\n    border-top: 1px solid var(--border-color);\n}\n\n.progress-info {\n    display: flex;\n    justify-content: space-between;\n    margin-bottom: 8px;\n    font-size: 14px;\n}\n\n.progress-bar {\n    height: 8px;\n    background: var(--bg-secondary);\n    border-radius: 4px;\n    overflow: hidden;\n}\n\n.progress-fill {\n    height: 100%;\n    background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));\n    transition: width 0.3s ease;\n    width: 0%;\n}\n\n.form-actions {\n    display: flex;\n    gap: var(--spacing-md);\n    justify-content: flex-end;\n    margin-top: var(--spacing-lg);\n}\n\n/* Visualization Layout */\n.viz-layout {\n    display: grid;\n    grid-template-columns: 1fr 300px;\n    gap: var(--spacing-lg);\n}\n\n.viz-plot-card {\n    min-height: 500px;\n}\n\n.plot-area {\n    width: 100%;\n    height: 500px;\n}\n\n/* Toggle Buttons */\n.toggle-group {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-sm);\n}\n\n.toggle-btn {\n    padding: 12px 16px;\n    background: var(--bg-secondary);\n    border: 2px solid var(--border-color);\n    border-radius: var(--radius-sm);\n    color: var(--text-secondary);\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    font-size: 14px;\n    font-weight: 500;\n}\n\n.toggle-btn:hover {\n    background: var(--bg-hover);\n    border-color: rgba(255, 255, 255, 0.2);\n}\n\n.toggle-btn.active {\n    background: var(--bg-hover);\n    border-color: var(--accent-cyan);\n    color: var(--text-primary);\n    box-shadow: 0 0 12px rgba(80, 201, 206, 0.2);\n}\n\n.toggle-indicator {\n    width: 20px;\n    height: 20px;\n    border-radius: 4px;\n    position: relative;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    flex-shrink: 0;\n    transition: all 0.3s ease;\n}\n\n/* Inactive state: show color faded with border */\n.toggle-btn:not(.active) .toggle-indicator {\n    opacity: 0.4;\n    border: 2px solid currentColor;\n}\n\n/* Active state: solid color background */\n.toggle-btn.active .toggle-indicator {\n    opacity: 1;\n}\n\n.toggle-btn.active .toggle-indicator::after {\n    content: '\u2713';\n    color: white;\n    font-size: 12px;\n    font-weight: bold;\n    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n}\n\n.toggle-label {\n    flex: 1;\n}\n\n/* Metrics Grid styles are now handled above with conditional display */\n\n.card-metric {\n    padding: var(--spacing-lg);\n    display: flex;\n    gap: var(--spacing-md);\n    align-items: flex-start;\n}\n\n.metric-icon {\n    width: 48px;\n    height: 48px;\n    border-radius: var(--radius-sm);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.metric-content h4 {\n    font-size: 12px;\n    font-weight: 500;\n    color: var(--text-secondary);\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n}\n\n.metric-value {\n    font-size: 28px;\n    font-weight: 700;\n    margin: 8px 0;\n}\n\n.metric-label {\n    font-size: 12px;\n    color: var(--text-secondary);\n}\n\n/* Utilities */\n.btn-link {\n    background: none;\n    border: none;\n    color: var(--accent-blue);\n    cursor: pointer;\n    font-size: 14px;\n}\n\n.btn-link:hover {\n    text-decoration: underline;\n}\n\n.icon-btn {\n    background: transparent;\n    border: none;\n    color: var(--text-secondary);\n    cursor: pointer;\n    padding: 4px;\n}\n\n.icon-btn:hover {\n    color: var(--text-primary);\n}\n\n.form-row {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--spacing-lg);\n}\n\n.checkbox-label {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    cursor: pointer;\n}\n\n.checkbox-label input[type=\"checkbox\"] {\n    width: 18px;\n    height: 18px;\n    cursor: pointer;\n}\n\n/* Reports List */\n.reports-list {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-sm);\n}\n\n.report-item {\n    padding: 12px;\n    background: var(--bg-secondary);\n    border-radius: var(--radius-sm);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.report-info strong {\n    display: block;\n    margin-bottom: 4px;\n}\n\n.report-info small {\n    color: var(--text-secondary);\n    font-size: 12px;\n}\n\n.badge {\n    padding: 4px 12px;\n    border-radius: 12px;\n    font-size: 12px;\n    font-weight: 500;\n}\n\n.badge-success {\n    background: rgba(76, 175, 80, 0.2);\n    color: #4CAF50;\n}\n\n/* Toast Container */\n.toast-container {\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    z-index: 1000;\n}\n\n/* Floating Logs Window */\n.floating-window {\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    width: 600px;\n    height: 400px;\n    background: var(--bg-card);\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-md);\n    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n    z-index: 2000;\n    display: flex;\n    flex-direction: column;\n    resize: both;\n    overflow: hidden;\n    min-width: 400px;\n    min-height: 300px;\n}\n\n.floating-window-header {\n    padding: 16px;\n    background: var(--bg-secondary);\n    border-bottom: 1px solid var(--border-color);\n    cursor: move;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    user-select: none;\n}\n\n.floating-window-header h3 {\n    margin: 0;\n    font-size: 16px;\n    font-weight: 600;\n    color: var(--text-primary);\n}\n\n.floating-window-controls {\n    display: flex;\n    gap: 12px;\n    align-items: center;\n}\n\n.floating-window-close {\n    background: none;\n    border: none;\n    color: var(--text-secondary);\n    font-size: 24px;\n    line-height: 1;\n    cursor: pointer;\n    padding: 0;\n    width: 24px;\n    height: 24px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: color 0.2s;\n}\n\n.floating-window-close:hover {\n    color: #F44336;\n}\n\n.floating-window-body {\n    flex: 1;\n    padding: 16px;\n    overflow-y: auto;\n    overflow-x: hidden;\n}\n\n.floating-window .logs-container {\n    max-height: none;\n    height: 100%;\n}\n\n/* Compact card variant for tighter spacing */\n.card-compact .card-body {\n    padding: 16px !important;\n}\n\n/* Danger button variant */\n.btn-danger {\n    background: linear-gradient(135deg, #e53935 0%, #d32f2f 100%);\n    color: white;\n    border: none;\n}\n\n.btn-danger:hover:not(:disabled) {\n    background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);\n    transform: translateY(-2px);\n}\n\n.btn-danger:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n}\n\n/* Sweep Mode Toggle Switch */\n.sweep-mode-toggle {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--spacing-md);\n}\n\n.mode-label {\n    font-size: 16px;\n    font-weight: 600;\n    transition: all 0.3s ease;\n    cursor: pointer;\n}\n\n.mode-label.mode-active {\n    color: var(--accent-cyan);\n}\n\n.mode-label.mode-dimmed {\n    color: var(--text-secondary);\n    opacity: 0.5;\n}\n\n.toggle-switch {\n    position: relative;\n    width: 60px;\n    height: 30px;\n    cursor: pointer;\n}\n\n.toggle-switch input {\n    opacity: 0;\n    width: 0;\n    height: 0;\n}\n\n.toggle-slider {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: var(--bg-secondary);\n    border: 2px solid var(--accent-cyan);\n    border-radius: 30px;\n    transition: all 0.3s ease;\n}\n\n.toggle-slider::before {\n    content: '';\n    position: absolute;\n    width: 20px;\n    height: 20px;\n    left: 3px;\n    top: 50%;\n    transform: translateY(-50%);\n    background: var(--accent-cyan);\n    border-radius: 50%;\n    transition: all 0.3s ease;\n    box-shadow: 0 2px 8px rgba(80, 201, 206, 0.4);\n}\n\n.toggle-switch input:checked+.toggle-slider::before {\n    left: calc(100% - 23px);\n}\n\n/* Modal Overlay */\n.modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.75);\n    backdrop-filter: blur(4px);\n    z-index: 3000;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    animation: fadeIn 0.3s ease;\n}\n\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n    }\n\n    to {\n        opacity: 1;\n    }\n}\n\n.modal-content {\n    animation: slideUp 0.3s ease;\n    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n}\n\n@keyframes slideUp {\n    from {\n        opacity: 0;\n        transform: translateY(20px);\n    }\n\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}";
static const char kCoreJs[] PROGMEM = "/**\n * core.js - Global utilities, state management, and shared UI helpers\n * Part of ESP32 MOSFET Analysis Tool\n */\n\n// =============================================================================\n// Global Variables & State\n// =============================================================================\nlet currentVDD = 5.0; // Default VDD voltage\nlet usbConnected = false;\n\n// Debug Configuration\nconst DEBUG_FLAGS = {\n    ENABLED: true,       // Master switch\n    CSV: true,           // CSV parsing details\n    PLOT: true,          // Plotting data and traces\n    API: true,           // API calls and responses\n    UI: true,            // UI events (clicks, toggles)\n    MATH: true           // Math calculations (Gm, SS)\n};\n\n// Debug helper\nfunction dbg(flag, ...args) {\n    if (DEBUG_FLAGS.ENABLED && DEBUG_FLAGS[flag]) {\n        console.log(`[DBG:${flag}]`, ...args);\n    }\n}\n\n// =============================================================================\n// System Info & Monitoring\n// =============================================================================\n\n// Fetch system info and update display\nasync function updateSystemInfo() {\n    try {\n        dbg('API', 'Fetching /api/system_info');\n        const response = await fetch('/api/system_info');\n        const data = await response.json();\n\n        // Update temperature\n        const tempEl = document.getElementById('temperature');\n        if (tempEl) tempEl.textContent = `${data.temperature.toFixed(1)}\u00b0C`;\n\n        // Update USB status\n        usbConnected = data.usb_connected;\n        const connStatusEl = document.getElementById('connection-status');\n        if (connStatusEl) {\n            connStatusEl.textContent = data.usb_connected ? 'Serial USB Ativa \u2713' : 'Inativa';\n            connStatusEl.style.color = data.usb_connected ? '#4CAF50' : '#F44336';\n        }\n\n        // Update header status indicator\n        const headerStatusText = document.getElementById('header-status-text');\n        const headerStatusDot = document.getElementById('header-status-dot');\n        if (headerStatusText && headerStatusDot) {\n            headerStatusText.textContent = data.usb_connected ? 'Comunica\u00e7\u00e3o USB Ativa' : 'Apenas WiFi';\n            headerStatusDot.style.background = data.usb_connected ? '#4CAF50' : '#FFA726';\n        }\n\n        // Update chip ID\n        const sensorIdEl = document.getElementById('sensor-id');\n        if (sensorIdEl) sensorIdEl.textContent = data.chip_id;\n\n        // Update Version (Dynamically add if missing)\n        let versionEl = document.getElementById('fw-version');\n        if (!versionEl && data.version && sensorIdEl) {\n            const container = sensorIdEl.parentElement.parentElement;\n            const row = document.createElement('div');\n            row.className = 'info-row';\n            row.innerHTML = `<span class=\"info-label\">Vers\u00e3o FW</span><span class=\"info-value\" id=\"fw-version\" style=\"font-family: monospace;\">${data.version}</span>`;\n            if (container) container.appendChild(row);\n        } else if (versionEl && data.version) {\n            versionEl.textContent = data.version;\n        }\n\n        // Update free heap\n        const freeHeapEl = document.getElementById('free-heap');\n        if (freeHeapEl) {\n            const heapKB = (data.free_heap / 1024).toFixed(1);\n            freeHeapEl.textContent = `${heapKB} KB`;\n        }\n\n        // Update Debug Mode status\n        let debugEl = document.getElementById('debug-status');\n        if (!debugEl && freeHeapEl) {\n            // Create debug status row dynamically if not exists\n            const container = freeHeapEl.parentElement.parentElement;\n            const row = document.createElement('div');\n            row.className = 'info-row';\n            row.innerHTML = `<span class=\"info-label\">Debug Log <small style=\"color:#888\">(GPIO12\u2192GND)</small></span><span class=\"info-value\" id=\"debug-status\"></span>`;\n            if (container) container.appendChild(row);\n            debugEl = document.getElementById('debug-status');\n        }\n        if (debugEl) {\n            if (data.debug_mode) {\n                debugEl.innerHTML = `<span style=\"color:#4CAF50\">\u2713 Ativo</span>`;\n            } else {\n                debugEl.innerHTML = `<span style=\"color:#F44336\">\u2717 Inativo</span>`;\n            }\n        }\n\n        // Update VDD if USB is connected\n        if (data.usb_connected) {\n            currentVDD = 5.0;\n        }\n    } catch (error) {\n        // console.error('Error fetching system info:', error); // Suppress frequent errors\n    }\n}\n\n// Start monitoring\ndocument.addEventListener('DOMContentLoaded', () => {\n    updateSystemInfo();\n    setInterval(updateSystemInfo, 1000);\n});\n\n// =============================================================================\n// UI Helpers (Toasts, Validation, Formatting)\n// =============================================================================\n\n// Helper for Toast Notifications\nfunction showToast(message, type = 'info') {\n    const container = document.getElementById('toast-container');\n    if (!container) {\n        alert(message);\n        return;\n    }\n\n    const toast = document.createElement('div');\n    toast.className = `toast toast-${type}`;\n    toast.style.cssText = `\n        padding: 12px 24px;\n        margin-bottom: 10px;\n        border-radius: 4px;\n        color: white;\n        font-weight: 500;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n        animation: slideIn 0.3s ease;\n        background: ${type === 'error' ? '#f44336' : (type === 'success' ? '#4caf50' : '#2196f3')};\n    `;\n\n    toast.textContent = message;\n    container.appendChild(toast);\n\n    setTimeout(() => {\n        toast.style.animation = 'slideOut 0.3s ease forwards';\n        setTimeout(() => toast.remove(), 300);\n    }, 4000);\n}\n\n// Add CSS keyframes for toast via JS if not present\nconst style = document.createElement('style');\nstyle.textContent = `\n    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }\n    @keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }\n`;\ndocument.head.appendChild(style);\n\nfunction escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n}\n\n// Validate voltage limits\nfunction validateVoltageLimit(inputElement) {\n    const value = parseFloat(inputElement.value);\n    if (value > currentVDD) {\n        alert(`\u26a0\ufe0f Aten\u00e7\u00e3o: A tens\u00e3o m\u00e1xima \u00e9 limitada pela alimenta\u00e7\u00e3o VDD (${currentVDD}V${usbConnected ? ' via USB' : ''})`);\n        inputElement.value = currentVDD.toFixed(1);\n    }\n}\n\n// Add validation listeners to voltage inputs\ndocument.addEventListener('DOMContentLoaded', () => {\n    ['vds-start', 'vds-end', 'vgs-start', 'vgs-end'].forEach(id => {\n        const input = document.getElementById(id);\n        if (input) {\n            input.addEventListener('change', () => validateVoltageLimit(input));\n        }\n    });\n});\n\n// =============================================================================\n// Logs System\n// =============================================================================\n\n// Fetch and display logs from ESP32\nasync function updateLogs() {\n    try {\n        const response = await fetch('/api/logs');\n        const logs = await response.json();\n\n        const logsContainer = document.getElementById('logs-container');\n        if (!logsContainer) return;\n\n        logsContainer.innerHTML = '';\n\n        logs.forEach(log => {\n            const logEntry = document.createElement('div');\n            logEntry.className = 'log-entry';\n\n            let levelClass = '';\n            let levelLabel = '';\n            switch (log.level) {\n                case 'error':\n                    levelClass = 'log-error';\n                    levelLabel = '[ERROR]';\n                    break;\n                case 'warn':\n                    levelClass = 'log-warn';\n                    levelLabel = '[WARN]';\n                    break;\n                case 'info':\n                    levelClass = 'log-info';\n                    levelLabel = '[INFO]';\n                    break;\n                case 'debug':\n                    levelClass = 'log-debug';\n                    levelLabel = '[DEBUG]';\n                    break;\n            }\n\n            logEntry.classList.add(levelClass);\n\n            const time = new Date(log.timestamp).toLocaleTimeString('pt-BR');\n\n            const timeSpan = document.createElement('span');\n            timeSpan.className = 'log-time';\n            timeSpan.textContent = time;\n\n            const levelSpan = document.createElement('span');\n            levelSpan.className = 'log-level';\n            levelSpan.textContent = levelLabel;\n\n            const messageSpan = document.createElement('span');\n            messageSpan.className = 'log-message';\n            messageSpan.textContent = log.message;\n\n            logEntry.appendChild(timeSpan);\n            logEntry.appendChild(levelSpan);\n            logEntry.appendChild(messageSpan);\n\n            logsContainer.appendChild(logEntry);\n        });\n    } catch (error) {\n        // console.error('Error fetching logs:', error);\n    }\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n    updateLogs();\n    setInterval(updateLogs, 2000);\n\n    // Logs Window Controls\n    const logsWindow = document.getElementById('floating-logs-window');\n    const logsHeader = document.getElementById('logs-window-header');\n\n    if (logsWindow && logsHeader) {\n        let isDragging = false;\n        let currentX, currentY, initialX, initialY;\n\n        // Open logs window\n        document.getElementById('btn-open-logs')?.addEventListener('click', () => {\n            logsWindow.style.display = 'flex';\n        });\n\n        // Close logs window\n        document.getElementById('btn-close-logs')?.addEventListener('click', () => {\n            logsWindow.style.display = 'none';\n        });\n\n        // Make window draggable\n        logsHeader.addEventListener('mousedown', (e) => {\n            if (e.target.closest('.floating-window-controls')) return;\n\n            isDragging = true;\n            initialX = e.clientX - logsWindow.offsetLeft;\n            initialY = e.clientY - logsWindow.offsetTop;\n            logsWindow.style.transform = 'none';\n        });\n\n        document.addEventListener('mousemove', (e) => {\n            if (!isDragging) return;\n\n            e.preventDefault();\n            currentX = e.clientX - initialX;\n            currentY = e.clientY - initialY;\n\n            logsWindow.style.left = `${currentX}px`;\n            logsWindow.style.top = `${currentY}px`;\n        });\n\n        document.addEventListener('mouseup', () => {\n            isDragging = false;\n        });\n\n        // Clear logs button (floating)\n        document.getElementById('btn-clear-logs-float')?.addEventListener('click', () => {\n            document.getElementById('logs-container').innerHTML = '';\n        });\n    }\n});\n\n// =============================================================================\n// Scroll-to-change functionality\n// =============================================================================\nfunction enableScrollOnSelect(selectElement) {\n    if (!selectElement) return;\n\n    selectElement.addEventListener('wheel', (e) => {\n        if (selectElement.disabled) return;\n        e.preventDefault();\n\n        const options = selectElement.options;\n        const currentIndex = selectElement.selectedIndex;\n        const direction = e.deltaY > 0 ? 1 : -1;\n        let newIndex = currentIndex + direction;\n\n        while (newIndex >= 0 && newIndex < options.length && options[newIndex].value === \"\") {\n            newIndex += direction;\n        }\n\n        if (newIndex < 0) newIndex = 0;\n        if (newIndex >= options.length) newIndex = options.length - 1;\n\n        if (options[newIndex].value === \"\" && currentIndex !== newIndex) return;\n\n        if (newIndex !== currentIndex && options[newIndex].value !== \"\") {\n            selectElement.selectedIndex = newIndex;\n            selectElement.dispatchEvent(new Event('change', { bubbles: true }));\n        }\n    }, { passive: false });\n\n    selectElement.addEventListener('mouseenter', () => {\n        selectElement.style.cursor = 'ns-resize';\n    });\n    selectElement.addEventListener('mouseleave', () => {\n        selectElement.style.cursor = '';\n    });\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n    document.querySelectorAll('.select-field').forEach(select => {\n        enableScrollOnSelect(select);\n    });\n\n    const selectObserver = new MutationObserver((mutations) => {\n        mutations.forEach((mutation) => {\n            mutation.addedNodes.forEach((node) => {\n                if (node.nodeType === 1) {\n                    if (node.classList?.contains('select-field')) {\n                        enableScrollOnSelect(node);\n                    }\n                    node.querySelectorAll?.('.select-field').forEach(select => {\n                        enableScrollOnSelect(select);\n                    });\n                }\n            });\n        });\n    });\n    selectObserver.observe(document.body, { childList: true, subtree: true });\n});\n";
static const char kCollectionJs[] PROGMEM = "/**\n * collection.js - Logic for data collection, API control, and file management\n * Part of ESP32 MOSFET Analysis Tool\n */\n\n// =============================================================================\n// Measurement List Management\n// =============================================================================\n\n// Load available measurements from ESP32\nasync function loadMeasurementList() {\n    // Note: file-select might be present on multiple pages or sections.\n    // We try to find it, but don't error if missing (e.g. if running in isolation)\n    const select = document.getElementById('file-select');\n    if (!select) return;\n\n    // Remember current selection to prevent annoying resets\n    const previousSelection = select.value;\n\n    try {\n        const response = await fetch(`/api/files?t=${Date.now()}`);\n        const data = await response.json();\n\n        select.innerHTML = '<option value=\"\">-- Selecione uma medida --</option>';\n\n        const sortedFiles = data.files.slice().reverse();\n        sortedFiles.forEach(file => {\n            const option = document.createElement('option');\n            option.value = file.name;\n            const date = new Date(file.timestamp * 1000).toLocaleString('pt-BR');\n            option.textContent = `${file.name.replace('.csv', '')} (${date})`;\n            select.appendChild(option);\n        });\n\n        // Restore previous selection if it still exists\n        if (previousSelection && [...select.options].some(opt => opt.value === previousSelection)) {\n            select.value = previousSelection;\n        }\n\n        if (data.warning) {\n            console.warn(`\u26a0\ufe0f ${data.count}/200 arquivos armazenados`);\n        }\n    } catch (error) {\n        console.error('Error loading measurements:', error);\n    }\n}\n\n// Auto-refresh list\ndocument.addEventListener('DOMContentLoaded', () => {\n    loadMeasurementList();\n    setInterval(loadMeasurementList, 10000);\n});\n\n// =============================================================================\n// Collection Control (Start, Stop, Poll)\n// =============================================================================\n\ndocument.addEventListener('DOMContentLoaded', () => {\n    const btnStart = document.getElementById('btn-start-collection');\n    if (!btnStart) return; // Not on collection page\n\n    // Start measurement button\n    btnStart.addEventListener('click', async (e) => {\n        console.log(\"Start button clicked\");\n        const btn = e.currentTarget;\n\n        // Check if we are in cancel mode\n        if (btn.dataset.action === 'cancel') {\n            if (!confirm('Deseja cancelar a medi\u00e7\u00e3o atual? O arquivo ser\u00e1 EXCLU\u00cdDO.')) return;\n\n            try {\n                btn.disabled = true;\n                btn.textContent = \"Cancelando...\";\n                await fetch('/api/cancel', { method: 'POST' });\n                showToast(\"Cancelando medi\u00e7\u00e3o...\", \"warning\");\n            } catch (error) {\n                showToast(\"Erro ao cancelar: \" + error.message, \"error\");\n                btn.disabled = false;\n            }\n            return;\n        }\n\n        // Get form values\n        const vgsStart = parseFloat(document.getElementById('vgs-start').value);\n        const vgsEnd = parseFloat(document.getElementById('vgs-end').value);\n        const vgsStep = parseFloat(document.getElementById('vgs-step').value);\n        const vdsStart = parseFloat(document.getElementById('vds-start').value);\n        const vdsEnd = parseFloat(document.getElementById('vds-end').value);\n        const vdsStep = parseFloat(document.getElementById('vds-step').value);\n        const rshunt = parseFloat(document.getElementById('rshunt').value);\n        const settlingTime = parseInt(document.getElementById('settling-time').value);\n        const filename = document.getElementById('filename').value;\n\n        // Validate inputs\n        let errorMsg = '';\n\n        // Filename Validation (Strict)\n        const validFilenameRegex = /^[a-zA-Z0-9_\\-\\.]+$/;\n        if (filename && !validFilenameRegex.test(filename)) {\n            errorMsg += '- Nome do arquivo inv\u00e1lido (use apenas letras, n\u00fameros, _, - e .)\\n';\n        }\n\n        // VGS Validations\n        if (isNaN(vgsStart) || isNaN(vgsEnd) || isNaN(vgsStep)) errorMsg += '- Par\u00e2metros VGS inv\u00e1lidos\\n';\n        else if (vgsStep <= 0) errorMsg += '- Passo VGS deve ser positivo\\n';\n\n        // VDS Validations\n        if (isNaN(vdsStart) || isNaN(vdsEnd) || isNaN(vdsStep)) errorMsg += '- Par\u00e2metros VDS inv\u00e1lidos\\n';\n        else if (vdsStep <= 0) errorMsg += '- Passo VDS deve ser positivo\\n';\n\n        // Hardware Validations\n        if (isNaN(rshunt) || rshunt <= 0) errorMsg += '- Resistor Shunt inv\u00e1lido\\n';\n\n        if (errorMsg) {\n            console.warn(\"Validation failed:\", errorMsg);\n            alert('\u26a0\ufe0f Erro na configura\u00e7\u00e3o:\\n' + errorMsg);\n            return;\n        }\n\n        // Get sweep mode from toggle\n        const sweepModeToggle = document.getElementById('sweep-mode-toggle');\n        const sweepMode = sweepModeToggle && sweepModeToggle.checked ? 'VDS' : 'VGS';\n\n        const config = {\n            vgs_start: vgsStart,\n            vgs_end: vgsEnd,\n            vgs_step: vgsStep,\n            vds_start: vdsStart,\n            vds_end: vdsEnd,\n            vds_step: vdsStep,\n            rshunt: rshunt,\n            settling_ms: settlingTime || 5,\n            filename: filename || 'mosfet_data.csv',\n            sweep_mode: sweepMode,\n            timestamp: Math.floor(Date.now() / 1000)\n        };\n\n        try {\n            console.log(\"Sending start request\", config);\n            // Disable button\n            btn.disabled = true;\n            btn.innerHTML = '<span class=\"status-dot\" style=\"background:white;width:8px;height:8px;\"></span> Inicializando...';\n\n            const progressSection = document.getElementById('progress-section');\n            if (progressSection) {\n                progressSection.style.display = 'block';\n                document.getElementById('progress-text').textContent = \"Iniciando...\";\n                document.getElementById('progress-fill').style.width = '0%';\n            }\n\n            const response = await fetch('/api/start', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify(config)\n            });\n\n            if (response.status === 202) { // Accepted/Started\n                // Start Polling\n                pollProgress();\n            } else if (response.status === 507) {\n                // Storage Full - show modal\n                if (typeof showStorageFullModal === 'function') {\n                    showStorageFullModal();\n                } else {\n                    alert('\u26a0\ufe0f Armazenamento Cheio! (Erro 507)');\n                }\n                resetCollectionButton();\n            } else {\n                const result = await response.json();\n                throw new Error(result.error || 'Falha ao iniciar');\n            }\n\n        } catch (error) {\n            console.error(\"Start error:\", error);\n            showToast(`\u274c Falha: ${error.message}`, \"error\");\n            resetCollectionButton();\n        }\n    });\n});\n\n// Poll Progress Function\nasync function pollProgress() {\n    try {\n        const response = await fetch('/api/progress');\n        const data = await response.json();\n\n        const progressSection = document.getElementById('progress-section');\n        if (progressSection) {\n            document.getElementById('progress-text').textContent = data.message || \"Coletando...\";\n            document.getElementById('progress-percent').textContent = `${data.progress}%`;\n            document.getElementById('progress-fill').style.width = `${data.progress}%`;\n        }\n\n        // Update button text with VDS if available\n        const btn = document.getElementById('btn-start-collection');\n        if (btn && data.running) {\n            btn.disabled = false; // Make sure it's clickable for cancel\n            btn.dataset.action = 'cancel'; // Set action flag\n            btn.style.backgroundColor = '#f44336'; // Red color\n            btn.innerHTML = `\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                    <path d=\"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z\"/>\n                </svg>\n                Cancelar (${data.progress}%)\n            `;\n        }\n\n        if (data.running) {\n            // Keep polling\n            setTimeout(pollProgress, 500);\n        } else {\n            // Finished - check for errors first\n            if (data.error && data.error_msg) {\n                showToast(\"\u274c ERRO: \" + data.error_msg, \"error\");\n                if (progressSection) {\n                    document.getElementById('progress-text').textContent = \"ERRO: \" + data.error_msg;\n                    document.getElementById('progress-fill').style.backgroundColor = '#f44336';\n                }\n            } else if (data.progress >= 100) {\n                showToast(\"\u2705 Medi\u00e7\u00e3o conclu\u00edda!\", \"success\");\n                if (progressSection) document.getElementById('progress-text').textContent = \"Conclu\u00eddo!\";\n                // Refresh list\n                loadMeasurementList();\n            } else {\n                showToast(\"\u26a0\ufe0f Medi\u00e7\u00e3o finalizada\", \"warning\");\n            }\n            resetCollectionButton();\n        }\n    } catch (e) {\n        // console.error(\"Polling error\", e);\n        setTimeout(pollProgress, 2000); // Retry slower\n    }\n}\n\nfunction resetCollectionButton() {\n    const btn = document.getElementById('btn-start-collection');\n    if (btn) {\n        btn.disabled = false;\n        btn.dataset.action = ''; // Clear cancel action\n        btn.style.backgroundColor = ''; // Reset color\n        btn.innerHTML = `\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                <path d=\"M8 5v14l11-7z\" />\n            </svg>\n            Iniciar Coleta\n        `;\n    }\n}\n\n// =============================================================================\n// Helper Controls\n// =============================================================================\n\n// Clear logs button\ndocument.getElementById('btn-clear-logs')?.addEventListener('click', () => {\n    // Clear local display\n    document.getElementById('logs-container').innerHTML = '';\n\n    // Clear backend logs\n    fetch('/api/logs/clear', { method: 'POST' }).catch(console.error);\n});\n\n// Reset fields button\ndocument.getElementById('btn-reset-fields')?.addEventListener('click', () => {\n    // VDS fields\n    document.getElementById('vds-start').value = '0';\n    document.getElementById('vds-end').value = '5.0';\n    document.getElementById('vds-step').value = '0.05';\n\n    // VGS fields\n    document.getElementById('vgs-start').value = '0';\n    document.getElementById('vgs-end').value = '3.5';\n    document.getElementById('vgs-step').value = '0.05';\n\n    // Hardware fields\n    document.getElementById('rshunt').value = '';\n    document.getElementById('settling-time').value = '5';\n    document.getElementById('filename').value = '';\n});\n\n// Character count for email\ndocument.getElementById('email-message')?.addEventListener('input', (e) => {\n    document.getElementById('char-count').textContent = e.target.value.length;\n});\n\n// Real-time Filename Validation\ndocument.getElementById('filename')?.addEventListener('input', (e) => {\n    const input = e.target;\n    const infoText = input.nextElementSibling; // helper-text\n    const validRegex = /^[a-zA-Z0-9_\\-\\.]+$/;\n\n    if (input.value && !validRegex.test(input.value)) {\n        input.style.borderColor = \"#F44336\"; // Red\n        if (infoText) {\n            infoText.style.color = \"#F44336\";\n            infoText.textContent = \"Nome inv\u00e1lido! Use apenas letras, n\u00fameros, _ . ou -\";\n        }\n    } else {\n        input.style.borderColor = \"\"; // Reset\n        if (infoText) {\n            infoText.style.color = \"\";\n            infoText.textContent = \"Arquivo com timestamps, VDS, VGS, Vsh, Ids, Gm, par\u00e2metros\";\n        }\n    }\n});\n\n// Sweep Mode Toggle - update visual state and description\ndocument.getElementById('sweep-mode-toggle')?.addEventListener('change', (e) => {\n    const vgsLabel = document.getElementById('mode-vgs-label');\n    const vdsLabel = document.getElementById('mode-vds-label');\n    const descEl = document.getElementById('sweep-mode-desc');\n\n    if (e.target.checked) {\n        // VDS mode (Curva Id x Vds)\n        vgsLabel.classList.remove('mode-active');\n        vgsLabel.classList.add('mode-dimmed');\n        vdsLabel.classList.remove('mode-dimmed');\n        vdsLabel.classList.add('mode-active');\n        if (descEl) descEl.textContent = 'Varia VDS para cada VGS fixo';\n    } else {\n        // VGS mode (Curva Id x Vgs) - default\n        vgsLabel.classList.add('mode-active');\n        vgsLabel.classList.remove('mode-dimmed');\n        vdsLabel.classList.add('mode-dimmed');\n        vdsLabel.classList.remove('mode-active');\n        if (descEl) descEl.textContent = 'Varia VGS para cada VDS fixo (padr\u00e3o)';\n    }\n});\n\n// =============================================================================\n// Storage & Delete All Logic\n// =============================================================================\n\nfunction showStorageFullModal() {\n    const modal = document.getElementById('storage-full-modal');\n    if (modal) {\n        modal.style.display = 'flex';\n    } else {\n        alert('\u26a0\ufe0f Armazenamento Cheio!\\n\\nO limite de 80% foi atingido.');\n    }\n}\n\nfunction hideStorageFullModal() {\n    const modal = document.getElementById('storage-full-modal');\n    if (modal) modal.style.display = 'none';\n}\n\ndocument.getElementById('btn-close-storage-modal')?.addEventListener('click', hideStorageFullModal);\ndocument.getElementById('storage-full-modal')?.addEventListener('click', (e) => {\n    if (e.target.id === 'storage-full-modal') hideStorageFullModal();\n});\n\n// Delete All (Main Page)\ndocument.getElementById('btn-delete-all')?.addEventListener('click', async () => {\n    if (!confirm(\"\u26a0\ufe0f ATEN\u00c7\u00c3O \u26a0\ufe0f\\n\\nTem certeza que deseja DELETAR TODOS os arquivos?\")) return;\n    if (!confirm(\"\u26d4 CONFIRMA\u00c7\u00c3O FINAL \u26d4\\n\\nEsta a\u00e7\u00e3o \u00e9 IRREVERS\u00cdVEL.\")) return;\n\n    try {\n        const response = await fetch('/api/files/delete-all', { method: 'POST' });\n        if (!response.ok) throw new Error(\"Falha ao deletar todos os arquivos\");\n        showToast(\"Todos os arquivos foram deletados.\", 'success');\n        loadMeasurementList();\n    } catch (error) {\n        showToast(\"Erro ao limpar armazenamento: \" + error.message, 'error');\n    }\n});\n\n// Delete All (Modal)\ndocument.getElementById('btn-modal-delete-all')?.addEventListener('click', async () => {\n    if (!confirm(\"\u26a0\ufe0f ATEN\u00c7\u00c3O \u26a0\ufe0f\\n\\nTem certeza que deseja DELETAR TODOS os arquivos?\")) return;\n    if (!confirm(\"\u26d4 CONFIRMA\u00c7\u00c3O FINAL \u26d4\\n\\nEsta a\u00e7\u00e3o \u00e9 IRREVERS\u00cdVEL.\")) return;\n\n    try {\n        const response = await fetch('/api/files/delete-all', { method: 'POST' });\n        if (!response.ok) throw new Error(\"Falha ao deletar todos os arquivos\");\n        showToast(\"Todos os arquivos foram deletados.\", 'success');\n        hideStorageFullModal();\n        loadMeasurementList();\n    } catch (error) {\n        showToast(\"Erro ao limpar armazenamento: \" + error.message, 'error');\n    }\n});\n\n// Close modal with Escape key\ndocument.addEventListener('keydown', (e) => {\n    if (e.key === 'Escape') hideStorageFullModal();\n});\n";
static const char kVisualizationJs[] PROGMEM = "/**\n * visualization.js - Plotting, CSV parsing, and mathematical analysis\n * Part of ESP32 MOSFET Analysis Tool\n * Dependencies: core.js, Plotly.js\n */\n\n// =============================================================================\n// Visualization State\n// =============================================================================\nlet currentCSVData = []; // Store full parsed CSV data\nlet uniqueVDSValues = []; // Store unique VDS values found in CSV\nlet currentSweepMode = 'VGS'; // Sweep mode: 'VGS' (default) or 'VDS'\nlet fileAnalysisMap = {}; // Global map for metadata (Vt, SS, Tangents)\nlet scaleType = 'linear'; // 'linear' or 'log' for Ids axis\n\n// Visible curves state\nlet visibleCurves = {\n    ids: true,\n    gm: false,\n    ss: false,\n    vt: false\n};\n\n// UI Elements (assigned in init)\nlet vizFileSelect = null;\n\n// =============================================================================\n// Initialization & Event Listeners\n// =============================================================================\n\nfunction initVisualization() {\n    vizFileSelect = document.getElementById('file-select');\n\n    // File Selection Logic (Visualization Tab)\n    if (vizFileSelect) {\n        vizFileSelect.addEventListener('change', handleFileSelection);\n    }\n\n    // Toggle Buttons (Curve Visibility)\n    document.querySelectorAll('.toggle-btn[data-curve]').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const curveType = btn.dataset.curve;\n            btn.classList.toggle('active');\n            const isActive = btn.classList.contains('active');\n\n            visibleCurves[curveType] = isActive;\n\n            // Auto-switch scale based on SS curve (User Request)\n            if (curveType === 'ss') {\n                dbg('UI', `SS toggled: ${isActive ? 'ON \u2192 Log Scale' : 'OFF \u2192 Linear Scale'}`);\n                setScale(isActive ? 'log' : 'linear');\n            }\n\n            updatePlotsMultiCurve();\n        });\n    });\n\n    // Metric Selector Injection\n    initMetricSelector();\n\n    // Download & Delete Buttons (Contextual)\n    document.getElementById('btn-download-measurement')?.addEventListener('click', handleDownload);\n    document.getElementById('btn-delete-measurement')?.addEventListener('click', handleDelete);\n\n    // VDS/Curve Selector Change\n    document.getElementById('vds-select')?.addEventListener('change', updatePlotsMultiCurve);\n\n    // Scale Toggle - Passive indicator only (controlled by SS button)\n    const scaleToggle = document.getElementById('scale-toggle');\n    if (scaleToggle) {\n        scaleToggle.disabled = true; // Disable direct interaction\n        scaleToggle.parentElement.style.pointerEvents = 'none'; // Make entire toggle non-clickable\n        scaleToggle.parentElement.style.opacity = '0.9'; // Slightly dimmed to indicate passive\n    }\n}\n\ndocument.addEventListener('DOMContentLoaded', initVisualization);\n\n// =============================================================================\n// File Handling\n// =============================================================================\n\nlet currentSelectedFile = '';\n\nasync function handleFileSelection(e) {\n    const selectedFile = e.target.value;\n    currentSelectedFile = selectedFile; // Save selection\n\n    const downloadBtn = document.getElementById('btn-download-measurement');\n    const deleteBtn = document.getElementById('btn-delete-measurement');\n    const vdsSelect = document.getElementById('vds-select');\n\n    if (!selectedFile) {\n        if (downloadBtn) downloadBtn.disabled = true;\n        if (deleteBtn) deleteBtn.disabled = true;\n        if (vdsSelect) {\n            vdsSelect.disabled = true;\n            vdsSelect.innerHTML = '<option value=\"\">Selecione um arquivo primeiro...</option>';\n        }\n        currentCSVData = [];\n        resetChart();\n        return;\n    }\n\n    if (downloadBtn) downloadBtn.disabled = false;\n    if (deleteBtn) deleteBtn.disabled = false;\n    if (vdsSelect) {\n        vdsSelect.disabled = true;\n        vdsSelect.innerHTML = '<option value=\"\">Carregando dados...</option>';\n    }\n\n    document.body.style.cursor = 'wait';\n\n    try {\n        const response = await fetch(`/api/files/download?file=${encodeURIComponent(selectedFile)}&t=${Date.now()}`);\n        if (!response.ok) throw new Error('Falha ao baixar arquivo');\n\n        const csvText = await response.text();\n        dbg('API', `File content received (${csvText.length} bytes)`);\n\n        parseCSV(csvText);\n\n        // Update Labels based on Sweep Mode\n        const curveLabel = document.getElementById('curve-select-label');\n        if (curveLabel) {\n            curveLabel.textContent = (currentSweepMode === 'VDS') ? 'Selecionar Curva VGS:' : 'Selecionar Curva VDS:';\n        }\n\n        // Populate Curve Selector\n        if (vdsSelect) {\n            vdsSelect.innerHTML = '';\n            uniqueVDSValues.forEach(val => {\n                const option = document.createElement('option');\n                option.value = val;\n                const label = (currentSweepMode === 'VDS') ? `VGS = ${val.toFixed(3)} V` : `VDS = ${val.toFixed(3)} V`;\n                option.textContent = label;\n                vdsSelect.appendChild(option);\n            });\n\n            if (uniqueVDSValues.length > 0) vdsSelect.value = uniqueVDSValues[0];\n            vdsSelect.disabled = false;\n        }\n\n        updatePlotsMultiCurve();\n\n    } catch (error) {\n        console.error(\"Error loading CSV:\", error);\n        showToast(\"Erro ao carregar arquivo de dados.\", \"error\");\n        if (vdsSelect) vdsSelect.innerHTML = '<option value=\"\">Erro ao carregar</option>';\n    } finally {\n        document.body.style.cursor = 'default';\n    }\n}\n\nasync function handleDownload() {\n    const selectedValue = document.getElementById('file-select').value;\n    if (!selectedValue) {\n        alert('\u26a0\ufe0f Selecione uma medida primeiro');\n        return;\n    }\n\n    try {\n        const response = await fetch(`/api/files/download?file=${encodeURIComponent(selectedValue)}`);\n        if (!response.ok) throw new Error(`HTTP ${response.status}`);\n\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = selectedValue; // Simplistic filename usage\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n    } catch (error) {\n        alert(`\u274c Erro ao baixar CSV: ${error.message}`);\n    }\n}\n\nasync function handleDelete() {\n    const selectedValue = document.getElementById('file-select').value;\n    if (!selectedValue) return;\n\n    if (!confirm(`Tem certeza que deseja deletar \"${selectedValue}\"?\\nEsta a\u00e7\u00e3o \u00e9 irrevers\u00edvel.`)) return;\n\n    try {\n        const response = await fetch(`/api/files/delete?file=${encodeURIComponent(selectedValue)}`, { method: 'POST' });\n        if (!response.ok) throw new Error(\"Falha ao deletar arquivo\");\n\n        showToast(`Arquivo deleto com sucesso.`, 'success');\n\n        // Reset UI\n        currentCSVData = [];\n        resetChart();\n        document.getElementById('file-select').value = \"\";\n        currentSelectedFile = \"\";\n\n        // Refresh List (defined in collection.js, accessible because it's global scope)\n        if (typeof loadMeasurementList === 'function') loadMeasurementList();\n\n    } catch (error) {\n        showToast(\"Erro ao deletar arquivo: \" + error.message, 'error');\n    }\n}\n\n// =============================================================================\n// CSV Parsing & Data Processing\n// =============================================================================\n\nfunction parseCSV(csvText) {\n    dbg('CSV', `Parsing CSV data. Size: ${csvText.length} bytes`);\n    if (csvText.length < 10) {\n        showToast(\"Erro: Arquivo vazio ou inv\u00e1lido recebido.\", \"error\");\n        return;\n    }\n\n    currentCSVData = [];\n    uniqueVDSValues = [];\n    const lines = csvText.trim().split('\\n');\n    let dataStartIndex = -1;\n    const analysisMap = {};\n\n    // 1. Header & Metadata Scan\n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n\n        if (line.includes('timestamp,vds') || line.includes('time,vds')) {\n            dataStartIndex = i + 1;\n        }\n\n        if (line.startsWith('# Sweep Mode:')) {\n            const modeMatch = line.match(/# Sweep Mode:\\s*(VGS|VDS)/i);\n            if (modeMatch) currentSweepMode = modeMatch[1].toUpperCase();\n        }\n\n        if (line.startsWith('# VDS=')) {\n            // Parse Metadata (Vt, SS, Tangents)\n            try {\n                const vdsMatch = line.match(/VDS=([\\d\\.]+)V/);\n                const vtMatch = line.match(/Vt=([\\d\\.]+)V/);\n                const ssMatch = line.match(/SS=([0-9\\.]+)\\s?mV\\/dec/);\n                const gmMatch = line.match(/MaxGm=([0-9\\.eE\\-\\+]+)\\s?S/);\n                const tanVgsMatch = line.match(/SS_Tangent_VGS:([\\d\\.\\-]+),([\\d\\.\\-]+)/);\n                const tanLogMatch = line.match(/SS_Tangent_LogId:([\\d\\.\\-]+),([\\d\\.\\-]+)/);\n\n                if (vdsMatch) {\n                    const vdsVal = parseFloat(vdsMatch[1]);\n                    const vdsKey = Math.round(vdsVal * 1000) / 1000;\n\n                    const meta = {\n                        vt: vtMatch ? parseFloat(vtMatch[1]) : 0,\n                        ss: ssMatch ? parseFloat(ssMatch[1]) : 0,\n                        max_gm: gmMatch ? parseFloat(gmMatch[1]) : 0\n                    };\n\n                    if (tanVgsMatch && tanLogMatch) {\n                        meta.ssTangent = {\n                            x1: parseFloat(tanVgsMatch[1]),\n                            x2: parseFloat(tanVgsMatch[2]),\n                            y1: parseFloat(tanLogMatch[1]),\n                            y2: parseFloat(tanLogMatch[2])\n                        };\n                    }\n                    analysisMap[vdsKey] = meta;\n                }\n            } catch (e) {\n                console.warn(\"Metadata parse error:\", line);\n            }\n        }\n    }\n\n    // Fallback if no header found\n    if (dataStartIndex === -1) {\n        for (let i = 0; i < lines.length; i++) {\n            if (!lines[i].trim().startsWith('#') && lines[i].includes(',')) {\n                dataStartIndex = i;\n                break;\n            }\n        }\n    }\n    if (dataStartIndex === -1) dataStartIndex = 0;\n\n    const vdsSet = new Set();\n\n    // 2. Data Parsing\n    for (let i = dataStartIndex; i < lines.length; i++) {\n        const parts = lines[i].split(',');\n        if (parts.length < 5) continue;\n\n        const vds = parseFloat(parts[1]);\n        const vgs = parseFloat(parts[2]);\n        const vsh = parseFloat(parts[3]);\n        const ids = parseFloat(parts[4]);\n        const gm = parseFloat(parts[5]);\n\n        // Legacy format fallback\n        let vt = (parts.length > 6) ? parseFloat(parts[6]) : 0;\n        let ss = (parts.length > 7) ? parseFloat(parts[7]) : 0;\n\n        if (!isNaN(vds) && !isNaN(vgs)) {\n            const vdsRounded = Math.round(vds * 1000) / 1000;\n            vdsSet.add(vdsRounded);\n\n            if (analysisMap[vdsRounded]) {\n                vt = analysisMap[vdsRounded].vt;\n                ss = analysisMap[vdsRounded].ss;\n            }\n\n            currentCSVData.push({\n                vds: vdsRounded,\n                vgs: vgs,\n                vsh: vsh,\n                ids: isNaN(ids) ? 0 : ids,\n                gm: isNaN(gm) ? 0 : gm,\n                vt: vt,\n                ss: ss,\n                max_gm: analysisMap[vdsRounded] ? analysisMap[vdsRounded].max_gm : 0\n            });\n        }\n    }\n\n    // Sort VDS values\n    uniqueVDSValues = Array.from(vdsSet).sort((a, b) => a - b);\n\n    // Post-processing\n    calculateGmForData(currentCSVData, currentSweepMode);\n    calculateSSForData(currentCSVData);\n\n    fileAnalysisMap = analysisMap;\n    dbg('CSV', `Parsed ${currentCSVData.length} valid points.`);\n}\n\n// =============================================================================\n// Math Engine (Frontend Re-implementations needed for visualization)\n// =============================================================================\n\nfunction calculateGmForData(data, sweepMode) {\n    if (!data || data.length < 2) return;\n    const curves = {};\n    data.forEach(d => {\n        const key = sweepMode === 'VDS' ? d.vgs : d.vds;\n        if (!curves[key]) curves[key] = [];\n        curves[key].push(d);\n    });\n\n    Object.keys(curves).forEach(k => {\n        const curve = curves[k];\n        curve.sort((a, b) => (sweepMode === 'VDS' ? a.vds - b.vds : a.vgs - b.vgs));\n\n        for (let i = 1; i < curve.length - 1; i++) {\n            const prev = curve[i - 1];\n            const next = curve[i + 1];\n            const dx = sweepMode === 'VDS' ? (next.vds - prev.vds) : (next.vgs - prev.vgs);\n            const dy = next.ids - prev.ids;\n\n            if (Math.abs(dx) > 1e-6) curve[i].gm = dy / dx;\n        }\n    });\n}\n\nfunction calculateSSForData(data) {\n    // Only calculate SS if in VGS sweep mode\n    // Basic implementation for frontend consistency\n    // Complex implementation typically in backend now\n}\n\n// =============================================================================\n// Plotting\n// =============================================================================\n\nfunction setScale(scale) {\n    if (scale === scaleType) return;\n    scaleType = scale;\n    updateScaleStatus();\n    updatePlotsMultiCurve();\n}\n\nfunction updateScaleStatus() {\n    // Update toggle slider position\n    const scaleToggle = document.getElementById('scale-toggle');\n    if (scaleToggle) {\n        scaleToggle.checked = (scaleType === 'log');\n    }\n\n    // Update labels\n    const linearLabel = document.getElementById('scale-linear-label');\n    const logLabel = document.getElementById('scale-log-label');\n\n    if (linearLabel && logLabel) {\n        if (scaleType === 'log') {\n            linearLabel.classList.remove('mode-active');\n            linearLabel.classList.add('mode-dimmed');\n            logLabel.classList.remove('mode-dimmed');\n            logLabel.classList.add('mode-active');\n        } else {\n            linearLabel.classList.add('mode-active');\n            linearLabel.classList.remove('mode-dimmed');\n            logLabel.classList.add('mode-dimmed');\n            logLabel.classList.remove('mode-active');\n        }\n    }\n}\n\nfunction updatePlotsMultiCurve() {\n    const vdsSelect = document.getElementById('vds-select');\n    if (!vdsSelect || currentCSVData.length === 0) return;\n\n    dbg('PLOT', 'updatePlotsMultiCurve called');\n\n    // Colors\n    const colors = {\n        ids: '#2196F3', gm: '#FF9800', ss: '#F44336', vt: '#4CAF50', tangent: '#E91E63'\n    };\n\n    // Filter Data\n    const curveVal = parseFloat(vdsSelect.value) || (uniqueVDSValues[0] || 0);\n    let plotData;\n    if (currentSweepMode === 'VDS') {\n        plotData = currentCSVData.filter(d => Math.abs(d.vgs - curveVal) < 0.001);\n        plotData.sort((a, b) => a.vds - b.vds);\n    } else {\n        plotData = currentCSVData.filter(d => Math.abs(d.vds - curveVal) < 0.001);\n        plotData.sort((a, b) => a.vgs - b.vgs);\n    }\n\n    if (plotData.length === 0) return;\n\n    const xData = plotData.map(d => currentSweepMode === 'VDS' ? d.vds : d.vgs);\n    const traceName = currentSweepMode === 'VDS' ? `VGS=${curveVal}V` : `VDS=${curveVal}V`;\n\n    // 1. Ids Trace\n    const traces = [{\n        x: xData,\n        y: plotData.map(d => Math.abs(d.ids)),\n        mode: 'lines',\n        name: 'Ids (A)',\n        line: { color: colors.ids, width: 2 }\n    }];\n\n    // 2. Gm Trace\n    if (visibleCurves.gm) {\n        traces.push({\n            x: xData,\n            y: plotData.map(d => d.gm || 0),\n            mode: 'lines',\n            name: 'Gm (S)',\n            yaxis: 'y2',\n            line: { color: colors.gm, width: 1.5, dash: 'dot' }\n        });\n    }\n\n    const shapes = [];\n    const annotations = [];\n    const vdsKey = Math.round(curveVal * 1000) / 1000;\n    const meta = fileAnalysisMap[vdsKey];\n\n    if (meta) {\n        // Vt Line\n        if (meta.vt > 0 && visibleCurves.vt) {\n            shapes.push({\n                type: 'line',\n                x0: meta.vt, y0: 0, x1: meta.vt, y1: 1,\n                xref: 'x', yref: 'paper',\n                line: { color: colors.vt, width: 2, dash: 'dash' }\n            });\n            annotations.push({\n                x: meta.vt, y: 1, xref: 'x', yref: 'paper',\n                text: `Vt=${meta.vt.toFixed(2)}V`,\n                showarrow: false, yanchor: 'bottom', font: { color: colors.vt }\n            });\n        }\n\n        // SS Tangent (Only in Log Scale and SS curve active)\n        if (scaleType === 'log' && meta.ssTangent && visibleCurves.ss) {\n            traces.push({\n                x: [meta.ssTangent.x1, meta.ssTangent.x2],\n                y: [Math.pow(10, meta.ssTangent.y1), Math.pow(10, meta.ssTangent.y2)],\n                mode: 'lines',\n                name: `SS Slope (${meta.ss.toFixed(0)}mV/dec)`,\n                line: { color: colors.tangent, width: 2, dash: 'dash' }\n            });\n        }\n    }\n\n    // Layout\n    const layout = {\n        title: `Curva Ids x ${currentSweepMode === 'VDS' ? 'VDS' : 'VGS'} (${traceName})`,\n        xaxis: { title: currentSweepMode === 'VDS' ? 'VDS (V)' : 'VGS (V)' },\n        yaxis: {\n            title: 'Corrente Ids (A)',\n            titlefont: { color: '#2196F3' },\n            tickfont: { color: '#2196F3' },\n            type: scaleType,\n            exponentformat: 'e'\n        },\n        yaxis2: {\n            title: 'Transcondut\u00e2ncia (S)',\n            titlefont: { color: '#FF9800' },\n            tickfont: { color: '#FF9800' },\n            overlaying: 'y',\n            side: 'right',\n            showgrid: false\n        },\n        shapes: shapes,\n        annotations: annotations,\n        hovermode: 'closest',\n        paper_bgcolor: '#1e1e1e',\n        plot_bgcolor: '#1e1e1e',\n        font: { color: '#e0e0e0' }\n    };\n\n    Plotly.newPlot('plot-container', traces, layout);\n    updateMetrics(plotData, meta);\n}\n\nfunction updateMetrics(plotData, meta) {\n    const vtEl = document.getElementById('metric-vt');\n    const gmEl = document.getElementById('metric-gm');\n    const ssEl = document.getElementById('metric-ss');\n\n    if (currentSweepMode === 'VDS') {\n        const msg = \"N/A (VDS Mode)\";\n        if (vtEl) vtEl.textContent = msg;\n        if (gmEl) gmEl.textContent = msg;\n        if (ssEl) ssEl.textContent = msg;\n        return;\n    }\n\n    // Use metadata if available, else calc\n    if (meta) {\n        if (vtEl) vtEl.textContent = meta.vt ? `${meta.vt.toFixed(3)} V` : '-';\n        if (gmEl) gmEl.textContent = meta.max_gm ? `${(meta.max_gm * 1000).toFixed(3)} mS` : '-';\n        if (ssEl) ssEl.textContent = meta.ss ? `${meta.ss.toFixed(1)} mV/dec` : '-';\n    } else {\n        // Fallback calc\n        let maxGm = 0;\n        plotData.forEach(d => { if (d.gm > maxGm) maxGm = d.gm; });\n        if (gmEl) gmEl.textContent = `${(maxGm * 1000).toFixed(3)} mS`;\n    }\n}\n\nfunction resetChart() {\n    const plotDiv = document.getElementById('plot-container');\n    if (plotDiv) Plotly.purge(plotDiv);\n}\n\nfunction initMetricSelector() {\n    const controls = document.querySelector('.viz-controls');\n    if (controls && !document.getElementById('plot-type-select')) {\n        const select = document.createElement('select');\n        select.id = 'plot-type-select';\n        select.className = 'control-input';\n        select.innerHTML = `\n            <option value=\"ids\">Corrente (Ids)</option>\n            <option value=\"gm\">Transcondut\u00e2ncia (Gm)</option>\n            <option value=\"ss\">Subthreshold Swing (SS)</option>\n        `;\n        // This selector concept was in dashboard.js but not fully connected to updatePlots. \n        // Adding simplistic listener for now.\n        select.addEventListener('change', () => {\n            // Logic to switch primary trace? Currently we show all enabled.\n        });\n        controls.appendChild(select);\n    }\n}\n";
}
