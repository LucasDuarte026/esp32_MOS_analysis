#pragma once
#include <pgmspace.h>

namespace webui {
static const char kIndexHtml[] PROGMEM = "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Coleta - MOSFET Analysis</title>\n    <script src=\"https://cdn.plot.ly/plotly-2.27.0.min.js\"></script>\n    <link rel=\"stylesheet\" href=\"dashboard.css\">\n</head>\n\n<body>\n    <!-- Main Container -->\n    <div class=\"app-container\">\n\n        <!-- Vertical Sidebar -->\n        <aside class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"logo\">\n                    <svg width=\"32\" height=\"32\" viewBox=\"0 0 32 32\" fill=\"none\">\n                        <rect width=\"32\" height=\"32\" rx=\"8\" fill=\"white\" opacity=\"0.1\" />\n                        <path d=\"M16 8L24 12V20L16 24L8 20V12L16 8Z\" stroke=\"white\" stroke-width=\"2\" fill=\"none\" />\n                        <circle cx=\"16\" cy=\"16\" r=\"3\" fill=\"white\" />\n                    </svg>\n                </div>\n            </div>\n\n            <nav class=\"sidebar-nav\">\n                <a href=\"/\" class=\"nav-btn active\" title=\"Coleta de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <path d=\"M3 3v18h18\" />\n                        <path d=\"M18 17V9\" />\n                        <path d=\"M13 17V5\" />\n                        <path d=\"M8 17v-3\" />\n                    </svg>\n                </a>\n\n                <a href=\"/visualization\" class=\"nav-btn\" title=\"Visualiza\u00e7\u00e3o de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" />\n                        <path d=\"M8 21h8\" />\n                        <path d=\"M12 17v4\" />\n                    </svg>\n                </a>\n\n                <a href=\"/email\" class=\"nav-btn\" title=\"Enviar Relat\u00f3rio\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z\" />\n                    </svg>\n                </a>\n            </nav>\n\n            <div class=\"sidebar-footer\">\n                <button class=\"sidebar-settings\" id=\"btn-open-logs\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z\" />\n                    </svg>\n                </button>\n            </div>\n        </aside>\n\n        <!-- Main Content Area -->\n        <main class=\"main-content\">\n\n            <!-- Data Collection Section -->\n            <section id=\"page-collection\" class=\"page-content\">\n                <header class=\"page-header\">\n                    <div class=\"header-text\">\n                        <h1>Coleta de Dados</h1>\n                        <p class=\"subtitle\">Sweep VDS/VGS para caracteriza\u00e7\u00e3o de MOSFET</p>\n                    </div>\n                    <div class=\"header-actions\">\n                        <div class=\"status-indicator\" id=\"header-status-indicator\">\n                            <span class=\"status-dot\" id=\"header-status-dot\"></span>\n                            <span id=\"header-status-text\">Verificando...</span>\n                        </div>\n                    </div>\n                </header>\n\n                <div class=\"content-grid\">\n                    <!-- Configuration Card -->\n                    <div class=\"card card-large\">\n                        <div class=\"card-header\">\n                            <h2>Configura\u00e7\u00f5es de Medida</h2>\n                        </div>\n                        <div class=\"card-body\">\n                            <!-- Sweep Mode Toggle -->\n                            <div class=\"sweep-mode-section\"\n                                style=\"margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);\">\n                                <h3 style=\"margin-bottom: var(--spacing-md);\">Modo de Varredura</h3>\n                                <div class=\"sweep-mode-toggle\">\n                                    <span class=\"mode-label mode-active\" id=\"mode-vgs-label\">Curva Id \u00d7 Vgs</span>\n                                    <label class=\"toggle-switch\">\n                                        <input type=\"checkbox\" id=\"sweep-mode-toggle\">\n                                        <span class=\"toggle-slider\"></span>\n                                    </label>\n                                    <span class=\"mode-label mode-dimmed\" id=\"mode-vds-label\">Curva Id \u00d7 Vds</span>\n                                </div>\n                                <small class=\"helper-text\"\n                                    style=\"display: block; margin-top: var(--spacing-sm); text-align: center;\">\n                                    <span id=\"sweep-mode-desc\">Varia VGS para cada VDS fixo (padr\u00e3o)</span>\n                                </small>\n                            </div>\n\n                            <!-- VDS Configuration Section -->\n                            <div\n                                style=\"margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);\">\n                                <h3 style=\"margin-bottom: var(--spacing-md); color: var(--accent-cyan);\">VDS -\n                                    Configura\u00e7\u00e3o\n                                    VDS (Tens\u00e3o Dreno-Source)</h3>\n                                <div class=\"form-grid\">\n                                    <div class=\"form-group\">\n                                        <label for=\"vds-start\">Tens\u00e3o Inicial VDS (V)</label>\n                                        <input type=\"number\" id=\"vds-start\" class=\"input-field\" min=\"0\" max=\"5\"\n                                            step=\"0.01\" value=\"0\">\n                                        <small class=\"helper-text\">In\u00edcio do sweep VDS (padr\u00e3o: 0V)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"vds-end\">Tens\u00e3o Final VDS (V)</label>\n                                        <input type=\"number\" id=\"vds-end\" class=\"input-field\" min=\"0\" max=\"5\"\n                                            step=\"0.01\" value=\"5.0\">\n                                        <small class=\"helper-text\">Limite superior VDS (m\u00e1ximo: VDD)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"vds-step\">Passo VDS (V)</label>\n                                        <select id=\"vds-step\" class=\"select-field\">\n                                            <option value=\"0.05\" selected>0.05V (alta resolu\u00e7\u00e3o)</option>\n                                            <option value=\"0.10\">0.10V (balanceado)</option>\n                                            <option value=\"0.15\">0.15V</option>\n                                            <option value=\"0.20\">0.20V (r\u00e1pido)</option>\n                                        </select>\n                                        <small class=\"helper-text\">Incremento de tens\u00e3o VDS no sweep</small>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- VGS Configuration Section -->\n                            <div\n                                style=\"margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--border-color);\">\n                                <h3 style=\"margin-bottom: var(--spacing-md); color: var(--accent-blue);\">VGS -\n                                    Configura\u00e7\u00e3o\n                                    VGS (Tens\u00e3o Porta-Source)</h3>\n                                <div class=\"form-grid\">\n                                    <div class=\"form-group\">\n                                        <label for=\"vgs-start\">Tens\u00e3o Inicial VGS (V)</label>\n                                        <input type=\"number\" id=\"vgs-start\" class=\"input-field\" min=\"0\" max=\"5\"\n                                            step=\"0.01\" value=\"0\">\n                                        <small class=\"helper-text\">In\u00edcio do sweep VGS (padr\u00e3o: 0V)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"vgs-end\">Tens\u00e3o Final VGS (V)</label>\n                                        <input type=\"number\" id=\"vgs-end\" class=\"input-field\" min=\"0\" max=\"5\"\n                                            step=\"0.01\" value=\"4.5\">\n                                        <small class=\"helper-text\">Limite superior VGS (m\u00e1ximo: VDD, t\u00edpico:\n                                            0-5V)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"vgs-step\">Passo VGS (V)</label>\n                                        <select id=\"vgs-step\" class=\"select-field\">\n                                            <option value=\"0.01\">0.01V (precis\u00e3o)</option>\n                                            <option value=\"0.05\" selected>0.05V (padr\u00e3o)</option>\n                                            <option value=\"0.1\">0.10V</option>\n                                            <option value=\"0.15\">0.15V</option>\n                                            <option value=\"0.2\">0.20V</option>\n                                            <option value=\"0.25\">0.25V</option>\n                                        </select>\n                                        <small class=\"helper-text\">Incremento de tens\u00e3o VGS (recomendado: 0.05V)</small>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- Hardware & Timing Configuration -->\n                            <div style=\"margin-bottom: var(--spacing-lg);\">\n                                <h3 style=\"margin-bottom: var(--spacing-md);\">Configura\u00e7\u00e3o de Hardware</h3>\n                                <div class=\"form-grid\">\n                                    <div class=\"form-group\">\n                                        <label for=\"rshunt\">Resistor Shunt (\u03a9)</label>\n                                        <input type=\"number\" id=\"rshunt\" class=\"input-field\" min=\"0.1\" max=\"1000\"\n                                            step=\"0.1\" placeholder=\"Ex: 100\">\n                                        <small class=\"helper-text\">Resistor na source para medi\u00e7\u00e3o de corrente (Ids =\n                                            Vsh / R)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"settling-time\">Tempo de Estabiliza\u00e7\u00e3o (ms)</label>\n                                        <input type=\"number\" id=\"settling-time\" class=\"input-field\" min=\"1\" max=\"1000\"\n                                            step=\"1\" value=\"5\">\n                                        <small class=\"helper-text\">Tempo entre escrita DAC e leitura ADC (recomendado:\n                                            5ms)</small>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"filename\">Nome do Arquivo CSV</label>\n                                        <input type=\"text\" id=\"filename\" class=\"input-field\"\n                                            placeholder=\"mosfet_caracterizacao_2024.csv\">\n                                        <small class=\"helper-text\">Arquivo com timestamps, VDS, VGS, Vsh, Ids, Gm,\n                                            par\u00e2metros</small>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class=\"form-actions\">\n                                <button class=\"btn btn-secondary\" id=\"btn-reset-fields\">\n                                    Resetar Campos\n                                </button>\n                                <button class=\"btn btn-primary\" id=\"btn-start-collection\">\n                                    <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                        <path d=\"M8 5v14l11-7z\" />\n                                    </svg>\n                                    Iniciar Coleta\n                                </button>\n                            </div>\n\n                            <!-- Progress Indicator -->\n                            <div class=\"progress-section\" id=\"progress-section\" style=\"display: none;\">\n                                <div class=\"progress-info\">\n                                    <span id=\"progress-text\">Coletando dados...</span>\n                                    <span id=\"progress-percent\">100%</span>\n                                </div>\n                                <div class=\"progress-bar\">\n                                    <div class=\"progress-fill\" id=\"progress-fill\"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- System Status Card -->\n                    <div class=\"card card-compact\">\n                        <div class=\"card-header\">\n                            <h3>Status do Sistema</h3>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"info-row\">\n                                <span class=\"info-label\">Comunica\u00e7\u00e3o USB</span>\n                                <span class=\"info-value\" id=\"connection-status\">Verificando...</span>\n                            </div>\n                            <div class=\"info-row\">\n                                <span class=\"info-label\">ID do ESP32</span>\n                                <span class=\"info-value\" id=\"sensor-id\"\n                                    style=\"font-family: monospace; font-size: 12px;\">Carregando...</span>\n                            </div>\n                            <div class=\"info-row\">\n                                <span class=\"info-label\">Temperatura do Chip</span>\n                                <span class=\"info-value\" id=\"temperature\">--\u00b0C</span>\n                            </div>\n                            <div class=\"info-row\">\n                                <span class=\"info-label\">Mem\u00f3ria Livre</span>\n                                <span class=\"info-value\" id=\"free-heap\">-- KB</span>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- File Management Card (Delete All) -->\n                    <div class=\"card card-compact\" style=\"border-color: rgba(244, 67, 54, 0.3);\">\n                        <div class=\"card-header\">\n                            <h3 style=\"color: var(--danger-color, #F44336);\">Gerenciamento de Dados</h3>\n                        </div>\n                        <div class=\"card-body\">\n                            <p style=\"margin-bottom: 12px; font-size: 14px; color: #bbb;\">\n                                A\u00e7\u00f5es cr\u00edticas de armazenamento. Tenha cuidado.\n                            </p>\n                            <button class=\"btn btn-danger\" id=\"btn-delete-all\" style=\"width: 100%;\">\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"\n                                    stroke-width=\"2\">\n                                    <path\n                                        d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                                </svg>\n                                DELETAR TUDO\n                            </button>\n                        </div>\n                    </div>\n\n                </div>\n            </section>\n\n        </main>\n    </div>\n\n    <!-- Floating Logs Window -->\n    <div id=\"floating-logs-window\" class=\"floating-window\" style=\"display: none;\">\n        <div class=\"floating-window-header\" id=\"logs-window-header\">\n            <h3>System Logs</h3>\n            <div class=\"floating-window-controls\">\n                <button class=\"btn-link\" id=\"btn-clear-logs-float\">Limpar</button>\n                <button class=\"floating-window-close\" id=\"btn-close-logs\">\u00d7</button>\n            </div>\n        </div>\n        <div class=\"floating-window-body\">\n            <div class=\"logs-container\" id=\"logs-container\"></div>\n        </div>\n    </div>\n\n    <!-- Toast Notification Container -->\n    <div id=\"toast-container\" class=\"toast-container\"></div>\n\n    <script src=\"dashboard.js\"></script>\n</body>\n\n</html>";
static const char kVisualizationHtml[] PROGMEM = "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Visualiza\u00e7\u00e3o - MOSFET Analysis</title>\n    <script src=\"https://cdn.plot.ly/plotly-2.27.0.min.js\"></script>\n    <link rel=\"stylesheet\" href=\"dashboard.css\">\n</head>\n\n<body>\n    <!-- Main Container -->\n    <div class=\"app-container\">\n\n        <!-- Vertical Sidebar -->\n        <aside class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"logo\">\n                    <svg width=\"32\" height=\"32\" viewBox=\"0 0 32 32\" fill=\"none\">\n                        <rect width=\"32\" height=\"32\" rx=\"8\" fill=\"white\" opacity=\"0.1\" />\n                        <path d=\"M16 8L24 12V20L16 24L8 20V12L16 8Z\" stroke=\"white\" stroke-width=\"2\" fill=\"none\" />\n                        <circle cx=\"16\" cy=\"16\" r=\"3\" fill=\"white\" />\n                    </svg>\n                </div>\n            </div>\n\n            <nav class=\"sidebar-nav\">\n                <a href=\"/\" class=\"nav-btn\" title=\"Coleta de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <path d=\"M3 3v18h18\" />\n                        <path d=\"M18 17V9\" />\n                        <path d=\"M13 17V5\" />\n                        <path d=\"M8 17v-3\" />\n                    </svg>\n                </a>\n\n                <a href=\"/visualization\" class=\"nav-btn active\" title=\"Visualiza\u00e7\u00e3o de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" />\n                        <path d=\"M8 21h8\" />\n                        <path d=\"M12 17v4\" />\n                    </svg>\n                </a>\n\n                <a href=\"/email\" class=\"nav-btn\" title=\"Enviar Relat\u00f3rio\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z\" />\n                    </svg>\n                </a>\n            </nav>\n\n            <div class=\"sidebar-footer\">\n                <button class=\"sidebar-settings\" id=\"btn-open-logs\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z\" />\n                    </svg>\n                </button>\n            </div>\n        </aside>\n\n        <!-- Main Content Area -->\n        <main class=\"main-content\">\n\n            <!-- Data Visualization Section -->\n            <section id=\"page-visualization\" class=\"page-content\">\n                <header class=\"page-header\">\n                    <div class=\"header-text\">\n                        <h1>Visualiza\u00e7\u00e3o de Dados</h1>\n                        <p class=\"subtitle\">An\u00e1lise interativa de curvas MOSFET</p>\n                    </div>\n                </header>\n\n                <!-- File Selector Card - Reorganized -->\n                <div class=\"card\" style=\"margin-bottom: var(--spacing-lg);\">\n                    <div class=\"card-body\">\n                        <!-- Row 1: File Select + Download Button -->\n                        <div style=\"display: flex; gap: 16px; align-items: flex-end; margin-bottom: 16px;\">\n                            <div class=\"form-group\" style=\"flex: 2;\">\n                                <label for=\"file-select\">Selecionar Medida</label>\n                                <select id=\"file-select\" class=\"select-field\">\n                                    <option value=\"\">-- Selecione uma medida --</option>\n                                </select>\n                            </div>\n                            <button class=\"btn btn-secondary\" id=\"btn-download-measurement\" disabled>\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                    <path d=\"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z\" />\n                                </svg>\n                                Download CSV\n                            </button>\n                            <button class=\"btn btn-danger\" id=\"btn-delete-measurement\" disabled\n                                title=\"Deletar arquivo permanentemente\" style=\"margin-left: 8px;\">\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"\n                                    stroke-width=\"2\">\n                                    <path d=\"M3 6h18\" />\n                                    <path\n                                        d=\"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2\" />\n                                </svg>\n                            </button>\n                        </div>\n\n                        <!-- Row 2: VDS/VGS Curve Selector -->\n                        <div class=\"form-group\">\n                            <label for=\"vds-select\" id=\"curve-select-label\">Selecionar Curva VDS</label>\n                            <select id=\"vds-select\" class=\"select-field\" disabled>\n                                <option value=\"\">Aguardando arquivo...</option>\n                            </select>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Plot and Controls Layout - Plot on left (larger), controls on right -->\n                <div class=\"viz-layout\" style=\"display: flex; gap: 16px;\">\n                    <!-- Main Plot Card - Takes most of the space -->\n                    <div class=\"card viz-plot-card\" style=\"flex: 3; min-width: 0;\">\n                        <div class=\"card-header\">\n                            <h2>Curvas Caracter\u00edsticas MOSFET</h2>\n                        </div>\n                        <div class=\"card-body\">\n                            <div id=\"plot-container\" class=\"plot-area\" style=\"min-height: 500px;\"></div>\n                        </div>\n                    </div>\n\n                    <!-- Toggle Controls Sidebar - Compact on right -->\n                    <div class=\"card viz-controls-card\" style=\"flex: 2; min-width: 220px; max-width: 280px;\">\n                        <div class=\"card-header\">\n                            <h3>Curvas Vis\u00edveis</h3>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"toggle-group\">\n                                <button class=\"toggle-btn active\" id=\"toggle-ids\" data-curve=\"ids\">\n                                    <span class=\"toggle-indicator\" style=\"background: #2196F3;\"></span>\n                                    <span class=\"toggle-label\">IDs (Corrente)</span>\n                                </button>\n                                <button class=\"toggle-btn\" id=\"toggle-gm\" data-curve=\"gm\">\n                                    <span class=\"toggle-indicator\" style=\"background: #FF9800;\"></span>\n                                    <span class=\"toggle-label\">Gm (Transcondut\u00e2ncia)</span>\n                                </button>\n                                <button class=\"toggle-btn\" id=\"toggle-ss\" data-curve=\"ss\">\n                                    <span class=\"toggle-indicator\" style=\"background: #F44336;\"></span>\n                                    <span class=\"toggle-label\">SS (Subthreshold)</span>\n                                </button>\n                                <button class=\"toggle-btn\" id=\"toggle-vt\" data-curve=\"vt\">\n                                    <span class=\"toggle-indicator\" style=\"background: #4CAF50;\"></span>\n                                    <span class=\"toggle-label\">Vt (Limiar)</span>\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Metrics Cards -->\n                <div class=\"metrics-grid\">\n                    <div class=\"card card-metric\">\n                        <div class=\"metric-icon\" style=\"background: rgba(76, 175, 80, 0.1);\">\n                            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#4CAF50\"\n                                stroke-width=\"2\">\n                                <path d=\"M3 12h18M3 6h18M3 18h18\" />\n                            </svg>\n                        </div>\n                        <div class=\"metric-content\">\n                            <h4>Threshold Voltage</h4>\n                            <div class=\"metric-value\" id=\"metric-vt\">--</div>\n                            <small class=\"metric-label\">Tens\u00e3o de Limiar</small>\n                        </div>\n                    </div>\n\n                    <div class=\"card card-metric\">\n                        <div class=\"metric-icon\" style=\"background: rgba(255, 152, 0, 0.1);\">\n                            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#FF9800\"\n                                stroke-width=\"2\">\n                                <path d=\"M13 2L3 14h9l-1 8 10-12h-9l1-8z\" />\n                            </svg>\n                        </div>\n                        <div class=\"metric-content\">\n                            <h4>Max Transconductance</h4>\n                            <div class=\"metric-value\" id=\"metric-gm\">--</div>\n                            <small class=\"metric-label\">Pico de Gm</small>\n                        </div>\n                    </div>\n\n                    <div class=\"card card-metric\">\n                        <div class=\"metric-icon\" style=\"background: rgba(244, 67, 54, 0.1);\">\n                            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#F44336\"\n                                stroke-width=\"2\">\n                                <path d=\"M18 20V10M12 20V4M6 20v-6\" />\n                            </svg>\n                        </div>\n                        <div class=\"metric-content\">\n                            <h4>Subthreshold Swing</h4>\n                            <div class=\"metric-value\" id=\"metric-ss\">--</div>\n                            <small class=\"metric-label\">Inclina\u00e7\u00e3o SS</small>\n                        </div>\n                    </div>\n                </div>\n            </section>\n\n        </main>\n    </div>\n\n    <!-- Floating Logs Window -->\n    <div id=\"floating-logs-window\" class=\"floating-window\" style=\"display: none;\">\n        <div class=\"floating-window-header\" id=\"logs-window-header\">\n            <h3>System Logs</h3>\n            <div class=\"floating-window-controls\">\n                <button class=\"btn-link\" id=\"btn-clear-logs-float\">Limpar</button>\n                <button class=\"floating-window-close\" id=\"btn-close-logs\">\u00d7</button>\n            </div>\n        </div>\n        <div class=\"floating-window-body\">\n            <div class=\"logs-container\" id=\"logs-container\"></div>\n        </div>\n    </div>\n\n    <!-- Toast Notification Container -->\n    <div id=\"toast-container\" class=\"toast-container\"></div>\n\n    <script src=\"dashboard.js\"></script>\n</body>\n\n</html>";
static const char kEmailHtml[] PROGMEM = "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Email - MOSFET Analysis</title>\n    <script src=\"https://cdn.plot.ly/plotly-2.27.0.min.js\"></script>\n    <link rel=\"stylesheet\" href=\"dashboard.css\">\n</head>\n\n<body>\n    <!-- Main Container -->\n    <div class=\"app-container\">\n\n        <!-- Vertical Sidebar -->\n        <aside class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"logo\">\n                    <svg width=\"32\" height=\"32\" viewBox=\"0 0 32 32\" fill=\"none\">\n                        <rect width=\"32\" height=\"32\" rx=\"8\" fill=\"white\" opacity=\"0.1\" />\n                        <path d=\"M16 8L24 12V20L16 24L8 20V12L16 8Z\" stroke=\"white\" stroke-width=\"2\" fill=\"none\" />\n                        <circle cx=\"16\" cy=\"16\" r=\"3\" fill=\"white\" />\n                    </svg>\n                </div>\n            </div>\n\n            <nav class=\"sidebar-nav\">\n                <a href=\"/\" class=\"nav-btn\" title=\"Coleta de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <path d=\"M3 3v18h18\" />\n                        <path d=\"M18 17V9\" />\n                        <path d=\"M13 17V5\" />\n                        <path d=\"M8 17v-3\" />\n                    </svg>\n                </a>\n\n                <a href=\"/visualization\" class=\"nav-btn\" title=\"Visualiza\u00e7\u00e3o de Dados\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" />\n                        <path d=\"M8 21h8\" />\n                        <path d=\"M12 17v4\" />\n                    </svg>\n                </a>\n\n                <a href=\"/email\" class=\"nav-btn active\" title=\"Enviar Relat\u00f3rio\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z\" />\n                    </svg>\n                </a>\n            </nav>\n\n            <div class=\"sidebar-footer\">\n                <button class=\"sidebar-settings\" id=\"btn-open-logs\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path\n                            d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z\" />\n                    </svg>\n                </button>\n            </div>\n        </aside>\n\n        <!-- Main Content Area -->\n        <main class=\"main-content\">\n\n            <!-- Email Sending Section -->\n            <section id=\"page-email\" class=\"page-content\">\n                <header class=\"page-header\">\n                    <div class=\"header-text\">\n                        <h1>Enviar Relat\u00f3rio</h1>\n                        <p class=\"subtitle\">Compartilhe dados e an\u00e1lises por email</p>\n                    </div>\n                </header>\n\n                <div class=\"content-grid\">\n                    <!-- Email Form Card -->\n                    <div class=\"card card-large\">\n                        <div class=\"card-header\">\n                            <h2>Compor Email</h2>\n                        </div>\n                        <div class=\"card-body\">\n                            <form id=\"email-form\">\n                                <div class=\"form-group\">\n                                    <label for=\"email-recipients\">Email do Destinat\u00e1rio</label>\n                                    <input type=\"email\" id=\"email-recipients\" class=\"input-field\"\n                                        placeholder=\"email@exemplo.com\" required>\n                                    <small class=\"helper-text\">Separe m\u00faltiplos emails com v\u00edrgula</small>\n                                </div>\n\n                                <div class=\"form-group\">\n                                    <label for=\"email-subject\">Assunto</label>\n                                    <input type=\"text\" id=\"email-subject\" class=\"input-field\"\n                                        placeholder=\"Relat\u00f3rio de An\u00e1lise MOSFET\">\n                                </div>\n\n                                <div class=\"form-group\">\n                                    <label for=\"email-message\">Mensagem</label>\n                                    <textarea id=\"email-message\" class=\"textarea-field\" rows=\"5\"\n                                        placeholder=\"Digite sua mensagem aqui...\"></textarea>\n                                    <small class=\"helper-text\"><span id=\"char-count\">0</span> / 1000 caracteres</small>\n                                </div>\n\n                                <div class=\"form-row\">\n                                    <div class=\"form-group\">\n                                        <label for=\"email-format\">Formato do Arquivo</label>\n                                        <select id=\"email-format\" class=\"select-field\">\n                                            <option value=\"csv\">CSV (Excel)</option>\n                                            <option value=\"json\">JSON (Dados brutos)</option>\n                                            <option value=\"pdf\">PDF (Relat\u00f3rio completo)</option>\n                                        </select>\n                                    </div>\n\n                                    <div class=\"form-group\">\n                                        <label for=\"email-measurement\">Medida</label>\n                                        <select id=\"email-measurement\" class=\"select-field\">\n                                            <option value=\"\">-- Selecione --</option>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class=\"form-group\">\n                                    <label class=\"checkbox-label\">\n                                        <input type=\"checkbox\" id=\"include-plots\" checked>\n                                        <span>Incluir gr\u00e1ficos (PNG)</span>\n                                    </label>\n                                </div>\n\n                                <div class=\"form-actions\">\n                                    <button type=\"button\" class=\"btn btn-secondary\">Salvar Rascunho</button>\n                                    <button type=\"submit\" class=\"btn btn-primary\" id=\"btn-send-email\">\n                                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\"\n                                            stroke=\"currentColor\" stroke-width=\"2\">\n                                            <path d=\"M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z\" />\n                                        </svg>\n                                        Enviar Relat\u00f3rio\n                                    </button>\n                                </div>\n                            </form>\n                        </div>\n                    </div>\n\n                    <!-- Sent Reports Card -->\n                    <div class=\"card card-compact\">\n                        <div class=\"card-header\">\n                            <h3>Relat\u00f3rios Enviados</h3>\n                            <button class=\"btn-link\">Ver Todos</button>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"reports-list\" id=\"reports-list\">\n                                <div class=\"report-item\">\n                                    <div class=\"report-info\">\n                                        <strong>Relat\u00f3rio para joao@lab.com</strong>\n                                        <small>Hoje 16:36</small>\n                                    </div>\n                                    <span class=\"badge badge-success\">Enviado</span>\n                                </div>\n                                <div class=\"report-item\">\n                                    <div class=\"report-info\">\n                                        <strong>Dados NMOS L=1.5\u03bcm</strong>\n                                        <small>Hoje 14:22</small>\n                                    </div>\n                                    <span class=\"badge badge-success\">Enviado</span>\n                                </div>\n                                <div class=\"report-item\">\n                                    <div class=\"report-info\">\n                                        <strong>An\u00e1lise completa Set 3</strong>\n                                        <small>Ontem 18:45</small>\n                                    </div>\n                                    <span class=\"badge badge-success\">Enviado</span>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </section>\n\n        </main>\n    </div>\n\n    <!-- Floating Logs Window -->\n    <div id=\"floating-logs-window\" class=\"floating-window\" style=\"display: none;\">\n        <div class=\"floating-window-header\" id=\"logs-window-header\">\n            <h3>System Logs</h3>\n            <div class=\"floating-window-controls\">\n                <button class=\"btn-link\" id=\"btn-clear-logs-float\">Limpar</button>\n                <button class=\"floating-window-close\" id=\"btn-close-logs\">\u00d7</button>\n            </div>\n        </div>\n        <div class=\"floating-window-body\">\n            <div class=\"logs-container\" id=\"logs-container\"></div>\n        </div>\n    </div>\n\n    <!-- Toast Notification Container -->\n    <div id=\"toast-container\" class=\"toast-container\"></div>\n\n    <script src=\"dashboard.js\"></script>\n</body>\n\n</html>";
static const char kDashboardCss[] PROGMEM = "* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\n:root {\n    --bg-primary: #0a0e1a;\n    --bg-secondary: #131826;\n    --bg-card: #1a1f33;\n    --bg-hover: #232940;\n    --accent-blue: #4A90E2;\n    --accent-cyan: #50C9CE;\n    --accent-purple: #9B7EDE;\n    --text-primary: #E8EAF0;\n    --text-secondary: #A0A8C0;\n    --border-color: #2a3147;\n    --spacing-sm: 8px;\n    --spacing-md: 16px;\n    --spacing-lg: 24px;\n    --spacing-xl: 32px;\n    --radius-sm: 8px;\n    --radius-md: 12px;\n    --radius-lg: 16px;\n}\n\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;\n    background: var(--bg-primary);\n    color: var(--text-primary);\n    line-height: 1.6;\n    overflow-x: hidden;\n}\n\n.app-container {\n    display: flex;\n    min-height: 100vh;\n}\n\n/* Sidebar */\n.sidebar {\n    width: 80px;\n    background: var(--bg-secondary);\n    border-right: 1px solid var(--border-color);\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: var(--spacing-lg) 0;\n    position: fixed;\n    height: 100vh;\n    z-index: 100;\n}\n\n.sidebar-header {\n    margin-bottom: var(--spacing-xl);\n}\n\n.sidebar-nav {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-md);\n}\n\n.nav-btn {\n    width: 48px;\n    height: 48px;\n    border: none;\n    background: transparent;\n    color: var(--text-secondary);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.nav-btn:hover {\n    background: var(--bg-hover);\n    color: var(--accent-cyan);\n}\n\n.nav-btn.active {\n    background: var(--accent-blue);\n    color: white;\n}\n\n.sidebar-footer {\n    margin-top: auto;\n}\n\n.sidebar-settings {\n    width: 40px;\n    height: 40px;\n    border: none;\n    background: transparent;\n    color: var(--text-secondary);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.sidebar-settings:hover {\n    background: var(--bg-hover);\n    color: var(--text-primary);\n}\n\n/* Main Content */\n.main-content {\n    flex: 1;\n    margin-left: 80px;\n    padding: var(--spacing-xl);\n    max-width: 1600px;\n}\n\n.page-header {\n    margin-bottom: var(--spacing-xl);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.page-header h1 {\n    font-size: 32px;\n    font-weight: 700;\n    margin-bottom: 4px;\n}\n\n.subtitle {\n    color: var(--text-secondary);\n    font-size: 14px;\n}\n\n.status-indicator {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 8px 16px;\n    background: var(--bg-card);\n    border-radius: var(--radius-sm);\n    border: 1px solid var(--border-color);\n}\n\n.status-dot {\n    width: 8px;\n    height: 8px;\n    background: #4CAF50;\n    border-radius: 50%;\n    animation: pulse 2s infinite;\n}\n\n@keyframes pulse {\n\n    0%,\n    100% {\n        opacity: 1;\n    }\n\n    50% {\n        opacity: 0.5;\n    }\n}\n\n/* Cards */\n.card {\n    background: var(--bg-card);\n    border-radius: var(--radius-md);\n    border: 1px solid var(--border-color);\n    overflow: hidden;\n}\n\n.card-header {\n    padding: var(--spacing-lg);\n    border-bottom: 1px solid var(--border-color);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.card-header h2 {\n    font-size: 20px;\n    font-weight: 600;\n}\n\n.card-header h3 {\n    font-size: 16px;\n    font-weight: 600;\n}\n\n.card-body {\n    padding: var(--spacing-lg);\n}\n\n/* Form Elements */\n.form-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: var(--spacing-lg);\n}\n\n.form-group {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n}\n\n.form-group label {\n    font-size: 14px;\n    font-weight: 500;\n    color: var(--text-primary);\n}\n\n.input-field,\n.select-field,\n.textarea-field {\n    padding: 12px 16px;\n    background: var(--bg-secondary);\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-sm);\n    color: var(--text-primary);\n    font-size: 14px;\n    transition: all 0.3s ease;\n}\n\n/* Enable scrolling for long dropdown lists (VDS, measurements) */\n.select-field {\n    max-height: 300px;\n    overflow-y: auto;\n}\n\n/* For Firefox - native select scrolling */\nselect.select-field {\n    scrollbar-width: thin;\n    scrollbar-color: var(--accent-blue) var(--bg-secondary);\n}\n\n/* For Webkit browsers (Chrome, Safari, Edge) */\nselect.select-field::-webkit-scrollbar {\n    width: 8px;\n}\n\nselect.select-field::-webkit-scrollbar-track {\n    background: var(--bg-secondary);\n    border-radius: 4px;\n}\n\nselect.select-field::-webkit-scrollbar-thumb {\n    background: var(--accent-blue);\n    border-radius: 4px;\n}\n\nselect.select-field::-webkit-scrollbar-thumb:hover {\n    background: var(--accent-cyan);\n}\n\n.input-field:focus,\n.select-field:focus,\n.textarea-field:focus {\n    outline: none;\n    border-color: var(--accent-blue);\n    background: var(--bg-hover);\n}\n\n.helper-text {\n    font-size: 12px;\n    color: var(--text-secondary);\n}\n\n/* Buttons */\n.btn {\n    padding: 12px 24px;\n    border: none;\n    border-radius: var(--radius-sm);\n    font-size: 14px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: inline-flex;\n    align-items: center;\n    gap: 8px;\n}\n\n.btn-primary {\n    background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));\n    color: white;\n}\n\n.btn-primary:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);\n}\n\n.btn-secondary {\n    background: var(--bg-secondary);\n    color: var(--text-primary);\n    border: 1px solid var(--border-color);\n}\n\n.btn-secondary:hover {\n    background: var(--bg-hover);\n}\n\n/* Content Grid */\n.content-grid {\n    display: grid;\n    grid-template-columns: 2fr 1fr;\n    gap: var(--spacing-lg);\n}\n\n.card-large {\n    grid-column: 1 / -1;\n}\n\n/* Tab System */\n.tab-content {\n    display: none !important;\n}\n\n.tab-content.active {\n    display: block !important;\n}\n\n/* ... existing styles ... */\n\n/* Metrics Grid */\n.metrics-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: var(--spacing-lg);\n    margin-top: var(--spacing-lg);\n}\n\n/* Info Rows */\n.info-row {\n    display: flex;\n    justify-content: space-between;\n    padding: 12px 0;\n    border-bottom: 1px solid var(--border-color);\n}\n\n.info-row:last-child {\n    border-bottom: none;\n}\n\n.info-label {\n    color: var(--text-secondary);\n    font-size: 14px;\n}\n\n.info-value {\n    color: var(--text-primary);\n    font-weight: 500;\n    font-size: 14px;\n}\n\n/* Battery Indicator */\n.battery-indicator {\n    width: 60px;\n    height: 20px;\n    border: 2px solid var(--border-color);\n    border-radius: 4px;\n    padding: 2px;\n    position: relative;\n    display: inline-block;\n}\n\n.battery-indicator::after {\n    content: '';\n    position: absolute;\n    right: -6px;\n    top: 6px;\n    width: 4px;\n    height: 8px;\n    background: var(--border-color);\n    border-radius: 0 2px 2px 0;\n}\n\n.battery-level {\n    height: 100%;\n    background: linear-gradient(90deg, #4CAF50, #8BC34A);\n    border-radius: 2px;\n    transition: width 0.3s ease;\n}\n\n/* Logs */\n.logs-container {\n    max-height: 200px;\n    overflow-y: auto;\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n}\n\n.log-entry {\n    padding: 8px 12px;\n    background: var(--bg-secondary);\n    border-radius: var(--radius-sm);\n    border-left: 3px solid transparent;\n    font-size: 13px;\n}\n\n.log-info {\n    border-left-color: var(--accent-blue);\n    background: rgba(74, 144, 226, 0.05);\n}\n\n.log-success {\n    border-left-color: #4CAF50;\n}\n\n.log-error {\n    border-left-color: #F44336;\n    background: rgba(244, 67, 54, 0.05);\n}\n\n.log-warn {\n    border-left-color: #FF9800;\n    background: rgba(255, 152, 0, 0.05);\n}\n\n.log-debug {\n    border-left-color: #9E9E9E;\n    background: rgba(158, 158, 158, 0.03);\n}\n\n.log-level {\n    margin-right: 12px;\n    font-size: 11px;\n    font-weight: 600;\n    font-family: 'Courier New', monospace;\n    opacity: 0.8;\n}\n\n.log-message {\n    flex: 1;\n}\n\n.log-time {\n    color: var(--text-secondary);\n    margin-right: 12px;\n}\n\n/* Progress Bar */\n.progress-section {\n    margin-top: var(--spacing-lg);\n    padding-top: var(--spacing-lg);\n    border-top: 1px solid var(--border-color);\n}\n\n.progress-info {\n    display: flex;\n    justify-content: space-between;\n    margin-bottom: 8px;\n    font-size: 14px;\n}\n\n.progress-bar {\n    height: 8px;\n    background: var(--bg-secondary);\n    border-radius: 4px;\n    overflow: hidden;\n}\n\n.progress-fill {\n    height: 100%;\n    background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));\n    transition: width 0.3s ease;\n    width: 0%;\n}\n\n.form-actions {\n    display: flex;\n    gap: var(--spacing-md);\n    justify-content: flex-end;\n    margin-top: var(--spacing-lg);\n}\n\n/* Visualization Layout */\n.viz-layout {\n    display: grid;\n    grid-template-columns: 1fr 300px;\n    gap: var(--spacing-lg);\n}\n\n.viz-plot-card {\n    min-height: 500px;\n}\n\n.plot-area {\n    width: 100%;\n    height: 500px;\n}\n\n/* Toggle Buttons */\n.toggle-group {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-sm);\n}\n\n.toggle-btn {\n    padding: 12px 16px;\n    background: var(--bg-secondary);\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-sm);\n    color: var(--text-primary);\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    font-size: 14px;\n}\n\n.toggle-btn:hover {\n    background: var(--bg-hover);\n    border-color: var(--accent-blue);\n}\n\n.toggle-btn.active {\n    background: var(--accent-blue);\n    border-color: var(--accent-blue);\n    color: white;\n}\n\n.toggle-indicator {\n    width: 16px;\n    height: 16px;\n    border-radius: 4px;\n    border: 2px solid currentColor;\n    position: relative;\n}\n\n.toggle-btn.active .toggle-indicator::after {\n    content: '\u2713';\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    font-size: 10px;\n}\n\n/* Metrics Grid styles are now handled above with conditional display */\n\n.card-metric {\n    padding: var(--spacing-lg);\n    display: flex;\n    gap: var(--spacing-md);\n    align-items: flex-start;\n}\n\n.metric-icon {\n    width: 48px;\n    height: 48px;\n    border-radius: var(--radius-sm);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.metric-content h4 {\n    font-size: 12px;\n    font-weight: 500;\n    color: var(--text-secondary);\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n}\n\n.metric-value {\n    font-size: 28px;\n    font-weight: 700;\n    margin: 8px 0;\n}\n\n.metric-label {\n    font-size: 12px;\n    color: var(--text-secondary);\n}\n\n/* Utilities */\n.btn-link {\n    background: none;\n    border: none;\n    color: var(--accent-blue);\n    cursor: pointer;\n    font-size: 14px;\n}\n\n.btn-link:hover {\n    text-decoration: underline;\n}\n\n.icon-btn {\n    background: transparent;\n    border: none;\n    color: var(--text-secondary);\n    cursor: pointer;\n    padding: 4px;\n}\n\n.icon-btn:hover {\n    color: var(--text-primary);\n}\n\n.form-row {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--spacing-lg);\n}\n\n.checkbox-label {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    cursor: pointer;\n}\n\n.checkbox-label input[type=\"checkbox\"] {\n    width: 18px;\n    height: 18px;\n    cursor: pointer;\n}\n\n/* Reports List */\n.reports-list {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-sm);\n}\n\n.report-item {\n    padding: 12px;\n    background: var(--bg-secondary);\n    border-radius: var(--radius-sm);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.report-info strong {\n    display: block;\n    margin-bottom: 4px;\n}\n\n.report-info small {\n    color: var(--text-secondary);\n    font-size: 12px;\n}\n\n.badge {\n    padding: 4px 12px;\n    border-radius: 12px;\n    font-size: 12px;\n    font-weight: 500;\n}\n\n.badge-success {\n    background: rgba(76, 175, 80, 0.2);\n    color: #4CAF50;\n}\n\n/* Toast Container */\n.toast-container {\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    z-index: 1000;\n}\n\n/* Floating Logs Window */\n.floating-window {\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    width: 600px;\n    height: 400px;\n    background: var(--bg-card);\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-md);\n    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n    z-index: 2000;\n    display: flex;\n    flex-direction: column;\n    resize: both;\n    overflow: hidden;\n    min-width: 400px;\n    min-height: 300px;\n}\n\n.floating-window-header {\n    padding: 16px;\n    background: var(--bg-secondary);\n    border-bottom: 1px solid var(--border-color);\n    cursor: move;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    user-select: none;\n}\n\n.floating-window-header h3 {\n    margin: 0;\n    font-size: 16px;\n    font-weight: 600;\n    color: var(--text-primary);\n}\n\n.floating-window-controls {\n    display: flex;\n    gap: 12px;\n    align-items: center;\n}\n\n.floating-window-close {\n    background: none;\n    border: none;\n    color: var(--text-secondary);\n    font-size: 24px;\n    line-height: 1;\n    cursor: pointer;\n    padding: 0;\n    width: 24px;\n    height: 24px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: color 0.2s;\n}\n\n.floating-window-close:hover {\n    color: #F44336;\n}\n\n.floating-window-body {\n    flex: 1;\n    padding: 16px;\n    overflow-y: auto;\n    overflow-x: hidden;\n}\n\n.floating-window .logs-container {\n    max-height: none;\n    height: 100%;\n}\n\n/* Compact card variant for tighter spacing */\n.card-compact .card-body {\n    padding: 16px !important;\n}\n\n/* Danger button variant */\n.btn-danger {\n    background: linear-gradient(135deg, #e53935 0%, #d32f2f 100%);\n    color: white;\n    border: none;\n}\n\n.btn-danger:hover:not(:disabled) {\n    background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);\n    transform: translateY(-2px);\n}\n\n.btn-danger:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n}\n\n/* Sweep Mode Toggle Switch */\n.sweep-mode-toggle {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--spacing-md);\n}\n\n.mode-label {\n    font-size: 16px;\n    font-weight: 600;\n    transition: all 0.3s ease;\n    cursor: pointer;\n}\n\n.mode-label.mode-active {\n    color: var(--accent-cyan);\n}\n\n.mode-label.mode-dimmed {\n    color: var(--text-secondary);\n    opacity: 0.5;\n}\n\n.toggle-switch {\n    position: relative;\n    width: 60px;\n    height: 30px;\n    cursor: pointer;\n}\n\n.toggle-switch input {\n    opacity: 0;\n    width: 0;\n    height: 0;\n}\n\n.toggle-slider {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: var(--bg-secondary);\n    border: 2px solid var(--border-color);\n    border-radius: 30px;\n    transition: all 0.3s ease;\n}\n\n.toggle-slider::before {\n    content: '';\n    position: absolute;\n    width: 22px;\n    height: 22px;\n    left: 2px;\n    bottom: 2px;\n    background: var(--accent-cyan);\n    border-radius: 50%;\n    transition: all 0.3s ease;\n    box-shadow: 0 2px 8px rgba(80, 201, 206, 0.4);\n}\n\n.toggle-switch input:checked + .toggle-slider {\n    border-color: var(--accent-cyan);\n}\n\n.toggle-switch input:checked + .toggle-slider::before {\n    transform: translateX(30px);\n}";
static const char kDashboardJs[] PROGMEM = "// Global state\nlet currentVDD = 5.0; // Default VDD voltage\nlet usbConnected = false;\nlet currentCSVData = []; // Store full parsed CSV data\nlet uniqueVDSValues = []; // Store unique VDS values found in CSV\nlet currentSweepMode = 'VGS'; // Sweep mode from CSV header: 'VGS' or 'VDS'\n\n// Multi-page architecture. No tab navigation here.\n\n// Fetch system info and update display\nasync function updateSystemInfo() {\n    try {\n        const response = await fetch('/api/system_info');\n        const data = await response.json();\n\n        // Update temperature\n        document.getElementById('temperature').textContent = `${data.temperature.toFixed(1)}\u00b0C`;\n\n        // Update USB status\n        usbConnected = data.usb_connected;\n        document.getElementById('connection-status').textContent = data.usb_connected ? 'Serial USB Ativa \u2713' : 'Inativa';\n        document.getElementById('connection-status').style.color = data.usb_connected ? '#4CAF50' : '#F44336';\n\n        // Update header status indicator\n        const headerStatusText = document.getElementById('header-status-text');\n        const headerStatusDot = document.getElementById('header-status-dot');\n        if (headerStatusText && headerStatusDot) {\n            headerStatusText.textContent = data.usb_connected ? 'Comunica\u00e7\u00e3o USB Ativa' : 'Apenas WiFi';\n            headerStatusDot.style.background = data.usb_connected ? '#4CAF50' : '#FFA726';\n        }\n\n        // Update chip ID\n        document.getElementById('sensor-id').textContent = data.chip_id;\n\n        // Update Version (Dynamically add if missing)\n        let versionEl = document.getElementById('fw-version');\n        if (!versionEl && data.version) {\n            const container = document.querySelector('#sensor-id').parentElement.parentElement;\n            const row = document.createElement('div');\n            row.className = 'info-row';\n            row.innerHTML = `<span class=\"info-label\">Vers\u00e3o FW</span><span class=\"info-value\" id=\"fw-version\" style=\"font-family: monospace;\">${data.version}</span>`;\n            container.appendChild(row);\n        } else if (versionEl && data.version) {\n            versionEl.textContent = data.version;\n        }\n\n        // Update free heap\n        const heapKB = (data.free_heap / 1024).toFixed(1);\n        document.getElementById('free-heap').textContent = `${heapKB} KB`;\n\n        // Update Debug Mode status\n        let debugEl = document.getElementById('debug-status');\n        if (!debugEl) {\n            // Create debug status row dynamically if not exists\n            const container = document.querySelector('#free-heap').parentElement.parentElement;\n            const row = document.createElement('div');\n            row.className = 'info-row';\n            row.innerHTML = `<span class=\"info-label\">Debug Log <small style=\"color:#888\">(GPIO12\u2192GND)</small></span><span class=\"info-value\" id=\"debug-status\"></span>`;\n            container.appendChild(row);\n            debugEl = document.getElementById('debug-status');\n        }\n        if (debugEl) {\n            if (data.debug_mode) {\n                debugEl.innerHTML = `<span style=\"color:#4CAF50\">\u2713 Ativo</span>`;\n            } else {\n                debugEl.innerHTML = `<span style=\"color:#F44336\">\u2717 Inativo</span>`;\n            }\n        }\n\n        // Update VDD if USB is connected\n        if (data.usb_connected) {\n            currentVDD = 5.0;\n        }\n    } catch (error) {\n        console.error('Error fetching system info:', error);\n    }\n}\n\n// Validate voltage limits\nfunction validateVoltageLimit(inputElement) {\n    const value = parseFloat(inputElement.value);\n    if (value > currentVDD) {\n        alert(`\u26a0\ufe0f Aten\u00e7\u00e3o: A tens\u00e3o m\u00e1xima \u00e9 limitada pela alimenta\u00e7\u00e3o VDD (${currentVDD}V${usbConnected ? ' via USB' : ''})`);\n        inputElement.value = currentVDD.toFixed(1);\n    }\n}\n\n// Add validation listeners to voltage inputs\n['vds-start', 'vds-end', 'vgs-start', 'vgs-end'].forEach(id => {\n    const input = document.getElementById(id);\n    if (input) {\n        input.addEventListener('change', () => validateVoltageLimit(input));\n    }\n});\n\n// Clear logs button\ndocument.getElementById('btn-clear-logs')?.addEventListener('click', () => {\n    document.getElementById('logs-container').innerHTML = '';\n});\n\n// Reset fields button\ndocument.getElementById('btn-reset-fields')?.addEventListener('click', () => {\n    // VDS fields\n    document.getElementById('vds-start').value = '0';\n    document.getElementById('vds-end').value = '5.0';\n    document.getElementById('vds-step').value = '0.05';\n\n    // VGS fields\n    document.getElementById('vgs-start').value = '0';\n    document.getElementById('vgs-end').value = '3.5';\n    document.getElementById('vgs-step').value = '0.05';\n\n    // Hardware fields\n    document.getElementById('rshunt').value = '';\n    document.getElementById('settling-time').value = '5';\n    document.getElementById('filename').value = '';\n});\n\n// Character count for email\ndocument.getElementById('email-message')?.addEventListener('input', (e) => {\n    document.getElementById('char-count').textContent = e.target.value.length;\n});\n\n// Sweep Mode Toggle - update visual state and description\ndocument.getElementById('sweep-mode-toggle')?.addEventListener('change', (e) => {\n    const vgsLabel = document.getElementById('mode-vgs-label');\n    const vdsLabel = document.getElementById('mode-vds-label');\n    const descEl = document.getElementById('sweep-mode-desc');\n\n    if (e.target.checked) {\n        // VDS mode (Curva Id x Vds)\n        vgsLabel.classList.remove('mode-active');\n        vgsLabel.classList.add('mode-dimmed');\n        vdsLabel.classList.remove('mode-dimmed');\n        vdsLabel.classList.add('mode-active');\n        if (descEl) descEl.textContent = 'Varia VDS para cada VGS fixo';\n    } else {\n        // VGS mode (Curva Id x Vgs) - default\n        vgsLabel.classList.add('mode-active');\n        vgsLabel.classList.remove('mode-dimmed');\n        vdsLabel.classList.add('mode-dimmed');\n        vdsLabel.classList.remove('mode-active');\n        if (descEl) descEl.textContent = 'Varia VGS para cada VDS fixo (padr\u00e3o)';\n    }\n});\n\n// Visible curves state (for toggle buttons)\nlet visibleCurves = {\n    ids: true,\n    gm: false,\n    ss: false,\n    vt: false\n};\n\n// Toggle buttons for visualization - properly update curve visibility\ndocument.querySelectorAll('.toggle-btn[data-curve]').forEach(btn => {\n    btn.addEventListener('click', () => {\n        const curveType = btn.dataset.curve;\n        btn.classList.toggle('active');\n        visibleCurves[curveType] = btn.classList.contains('active');\n        updatePlotsMultiCurve();\n    });\n});\n\n// Load available measurements from ESP32 - Fixed to preserve selection\nlet currentSelectedFile = ''; // Track selection to prevent reset\n\nasync function loadMeasurementList() {\n    const select = document.getElementById('file-select');\n    if (!select) return;\n\n    // Remember current selection\n    const previousSelection = currentSelectedFile || select.value;\n\n    try {\n        const response = await fetch(`/api/files?t=${Date.now()}`);\n        const data = await response.json();\n\n        select.innerHTML = '<option value=\"\">-- Selecione uma medida --</option>';\n\n        const sortedFiles = data.files.slice().reverse();\n        sortedFiles.forEach(file => {\n            const option = document.createElement('option');\n            option.value = file.name;\n            const date = new Date(file.timestamp * 1000).toLocaleString('pt-BR');\n            option.textContent = `${file.name.replace('.csv', '')} (${date})`;\n            select.appendChild(option);\n        });\n\n        // Restore previous selection if it still exists\n        if (previousSelection && [...select.options].some(opt => opt.value === previousSelection)) {\n            select.value = previousSelection;\n        }\n\n        if (data.warning) {\n            console.warn(`\u26a0\ufe0f ${data.count}/200 arquivos armazenados`);\n        }\n    } catch (error) {\n        console.error('Error loading measurements:', error);\n    }\n}\n\n\n// Start measurement button with Real Polling (and Cancel support)\ndocument.getElementById('btn-start-collection')?.addEventListener('click', async (e) => {\n    const btn = e.currentTarget;\n\n    // Check if we are in cancel mode\n    if (btn.dataset.action === 'cancel') {\n        if (!confirm('Deseja cancelar a medi\u00e7\u00e3o atual? O arquivo ser\u00e1 EXCLU\u00cdDO.')) return;\n\n        try {\n            btn.disabled = true;\n            btn.textContent = \"Cancelando...\";\n            await fetch('/api/cancel', { method: 'POST' });\n            showToast(\"Cancelando medi\u00e7\u00e3o...\", \"warning\");\n        } catch (error) {\n            showToast(\"Erro ao cancelar: \" + error.message, \"error\");\n            btn.disabled = false;\n        }\n        return;\n    }\n\n    // Get form values\n    const vgsStart = parseFloat(document.getElementById('vgs-start').value);\n    const vgsEnd = parseFloat(document.getElementById('vgs-end').value);\n    const vgsStep = parseFloat(document.getElementById('vgs-step').value);\n    const vdsStart = parseFloat(document.getElementById('vds-start').value);\n    const vdsEnd = parseFloat(document.getElementById('vds-end').value);\n    const vdsStep = parseFloat(document.getElementById('vds-step').value);\n    const rshunt = parseFloat(document.getElementById('rshunt').value);\n    const settlingTime = parseInt(document.getElementById('settling-time').value);\n    const filename = document.getElementById('filename').value;\n\n    // Validate inputs\n    let errorMsg = '';\n\n    // Filename Validation (Strict)\n    const validFilenameRegex = /^[a-zA-Z0-9_\\-\\.]+$/;\n    if (filename && !validFilenameRegex.test(filename)) {\n        errorMsg += '- Nome do arquivo inv\u00e1lido (use apenas letras, n\u00fameros, _, - e .)\\n';\n    }\n\n    // VGS Validations\n    if (isNaN(vgsStart) || isNaN(vgsEnd) || isNaN(vgsStep)) errorMsg += '- Par\u00e2metros VGS inv\u00e1lidos\\n';\n    else if (vgsStep <= 0) errorMsg += '- Passo VGS deve ser positivo\\n';\n\n    // VDS Validations\n    if (isNaN(vdsStart) || isNaN(vdsEnd) || isNaN(vdsStep)) errorMsg += '- Par\u00e2metros VDS inv\u00e1lidos\\n';\n    else if (vdsStep <= 0) errorMsg += '- Passo VDS deve ser positivo\\n';\n\n    // Hardware Validations\n    if (isNaN(rshunt) || rshunt <= 0) errorMsg += '- Resistor Shunt inv\u00e1lido\\n';\n\n    if (errorMsg) {\n        alert('\u26a0\ufe0f Erro na configura\u00e7\u00e3o:\\n' + errorMsg);\n        return;\n    }\n\n\n    // Get sweep mode from toggle\n    const sweepModeToggle = document.getElementById('sweep-mode-toggle');\n    const sweepMode = sweepModeToggle && sweepModeToggle.checked ? 'VDS' : 'VGS';\n\n    const config = {\n        vgs_start: vgsStart,\n        vgs_end: vgsEnd,\n        vgs_step: vgsStep,\n        vds_start: vdsStart,\n        vds_end: vdsEnd,\n        vds_step: vdsStep,\n        rshunt: rshunt,\n        settling_ms: settlingTime || 5,\n        filename: filename || 'mosfet_data.csv',\n        sweep_mode: sweepMode,\n        timestamp: Math.floor(Date.now() / 1000)\n    };\n\n    try {\n        // Disable button\n        const btn = document.getElementById('btn-start-collection');\n        btn.disabled = true;\n        btn.innerHTML = '<span class=\"status-dot\" style=\"background:white;width:8px;height:8px;\"></span> Inicializando...';\n\n        const progressSection = document.getElementById('progress-section');\n        if (progressSection) {\n            progressSection.style.display = 'block';\n            document.getElementById('progress-text').textContent = \"Iniciando...\";\n            document.getElementById('progress-fill').style.width = '0%';\n        }\n\n        const response = await fetch('/api/start', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(config)\n        });\n\n        if (response.status === 202) { // Accepted/Started\n            // Start Polling\n            pollProgress();\n        } else {\n            const result = await response.json();\n            throw new Error(result.error || 'Falha ao iniciar');\n        }\n\n    } catch (error) {\n        showToast(`\u274c Falha: ${error.message}`, \"error\");\n        resetCollectionButton();\n    }\n});\n\n// Poll Progress Function\nasync function pollProgress() {\n    try {\n        const response = await fetch('/api/progress');\n        const data = await response.json();\n\n        const progressSection = document.getElementById('progress-section');\n        if (progressSection) {\n            document.getElementById('progress-text').textContent = data.message || \"Coletando...\";\n            document.getElementById('progress-fill').style.width = `${data.progress}%`;\n        }\n\n        // Update button text with VDS if available\n        const btn = document.getElementById('btn-start-collection');\n        if (btn && data.running) {\n            btn.disabled = false; // Make sure it's clickable for cancel\n            btn.dataset.action = 'cancel'; // Set action flag\n            btn.style.backgroundColor = '#f44336'; // Red color\n            btn.innerHTML = `\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                    <path d=\"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z\"/>\n                </svg>\n                Cancelar (${data.progress}%)\n            `;\n        }\n\n        if (data.running) {\n            // Keep polling\n            setTimeout(pollProgress, 500);\n        } else {\n            // Finished - check for errors first\n            if (data.error && data.error_msg) {\n                showToast(\"\u274c ERRO: \" + data.error_msg, \"error\");\n                if (progressSection) {\n                    document.getElementById('progress-text').textContent = \"ERRO: \" + data.error_msg;\n                    document.getElementById('progress-fill').style.backgroundColor = '#f44336';\n                }\n            } else if (data.progress >= 100) {\n                showToast(\"\u2705 Medi\u00e7\u00e3o conclu\u00edda!\", \"success\");\n                if (progressSection) document.getElementById('progress-text').textContent = \"Conclu\u00eddo!\";\n            } else {\n                showToast(\"\u26a0\ufe0f Medi\u00e7\u00e3o finalizada\", \"warning\");\n            }\n            resetCollectionButton();\n        }\n    } catch (e) {\n        console.error(\"Polling error\", e);\n        setTimeout(pollProgress, 2000); // Retry slower\n    }\n}\n\nfunction resetCollectionButton() {\n    const btn = document.getElementById('btn-start-collection');\n    if (btn) {\n        btn.disabled = false;\n        btn.dataset.action = ''; // Clear cancel action\n        btn.style.backgroundColor = ''; // Reset color\n        btn.innerHTML = `\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                <path d=\"M8 5v14l11-7z\" />\n            </svg>\n            Iniciar Coleta\n        `;\n    }\n}\n\n// Helper for Toast Notifications\nfunction showToast(message, type = 'info') {\n    const container = document.getElementById('toast-container');\n    if (!container) {\n        alert(message);\n        return;\n    }\n\n    const toast = document.createElement('div');\n    toast.className = `toast toast-${type}`;\n    toast.style.cssText = `\n        padding: 12px 24px;\n        margin-bottom: 10px;\n        border-radius: 4px;\n        color: white;\n        font-weight: 500;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n        animation: slideIn 0.3s ease;\n        background: ${type === 'error' ? '#f44336' : (type === 'success' ? '#4caf50' : '#2196f3')};\n    `;\n\n    toast.textContent = message;\n    container.appendChild(toast);\n\n    setTimeout(() => {\n        toast.style.animation = 'slideOut 0.3s ease forwards';\n        setTimeout(() => toast.remove(), 300);\n    }, 4000);\n}\n\n// Add CSS keyframes for toast via JS if not present\nconst style = document.createElement('style');\nstyle.textContent = `\n    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }\n    @keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }\n`;\ndocument.head.appendChild(style);\n\n// File selector for visualization tab\ndocument.getElementById('file-select')?.addEventListener('change', async (e) => {\n    const downloadBtn = document.getElementById('btn-download-measurement');\n    const deleteBtn = document.getElementById('btn-delete-measurement');\n    const vdsSelect = document.getElementById('vds-select');\n    const selectedFile = e.target.value;\n\n    // Save current selection to prevent reset bug\n    currentSelectedFile = selectedFile;\n\n    if (!selectedFile || selectedFile === '') {\n        if (downloadBtn) downloadBtn.disabled = true;\n        if (deleteBtn) deleteBtn.disabled = true;\n        vdsSelect.disabled = true;\n        vdsSelect.innerHTML = '<option value=\"\">Selecione um arquivo primeiro...</option>';\n        currentCSVData = [];\n        return;\n    }\n\n    if (downloadBtn) downloadBtn.disabled = false;\n    if (deleteBtn) deleteBtn.disabled = false;\n    vdsSelect.disabled = true;\n    vdsSelect.innerHTML = '<option value=\"\">Carregando dados...</option>';\n\n    // Load CSV Data\n    try {\n        const response = await fetch(`/api/files/download?file=${encodeURIComponent(selectedFile)}&t=${Date.now()}`);\n        if (!response.ok) throw new Error('Falha ao baixar arquivo');\n\n        const csvText = await response.text();\n        parseCSV(csvText);\n\n        // Update curve selector label based on sweep mode\n        const curveLabel = document.getElementById('curve-select-label');\n        if (curveLabel) {\n            if (currentSweepMode === 'VDS') {\n                curveLabel.textContent = 'Selecionar Curva VGS:';\n            } else {\n                curveLabel.textContent = 'Selecionar Curva VDS:';\n            }\n        }\n\n        // Populate curve Select with values from CSV (no 'all' option)\n        vdsSelect.innerHTML = '';\n        uniqueVDSValues.forEach((val, idx) => {\n            const option = document.createElement('option');\n            option.value = val;\n            if (currentSweepMode === 'VDS') {\n                option.textContent = `VGS = ${val.toFixed(3)} V`;\n            } else {\n                option.textContent = `VDS = ${val.toFixed(3)} V`;\n            }\n            vdsSelect.appendChild(option);\n        });\n\n        // Select first value by default\n        if (uniqueVDSValues.length > 0) {\n            vdsSelect.value = uniqueVDSValues[0];\n        }\n\n\n        vdsSelect.disabled = false;\n        updatePlotsMultiCurve(); // Use multi-curve plot function\n\n    } catch (error) {\n        console.error(\"Error loading CSV:\", error);\n        vdsSelect.innerHTML = '<option value=\"\">Erro ao carregar</option>';\n        showToast(\"Erro ao carregar arquivo de dados.\", \"error\");\n    }\n});\n\n\n// Initialize Metric Selector\n(function initMetricSelector() {\n    const controls = document.querySelector('.viz-controls');\n    if (controls && !document.getElementById('plot-type-select')) {\n        const select = document.createElement('select');\n        select.id = 'plot-type-select';\n        select.className = 'control-input';\n        select.innerHTML = `\n            <option value=\"ids\">Corrente (Ids)</option>\n            <option value=\"gm\">Transcondut\u00e2ncia (Gm)</option>\n            <option value=\"ss\">Subthreshold Swing (SS)</option>\n            <option value=\"vsh\">Tens\u00e3o Shunt (Vsh)</option>\n        `;\n        select.addEventListener('change', updatePlots);\n\n        // Insert before existing file select or append\n        controls.appendChild(select);\n        console.log(\"Metric selector injected\");\n    }\n})();\n\n// CSV Parser\n// CSV Parser\n// CSV Parser\nfunction parseCSV(csvText) {\n    console.log(`[DEBUG] Parsing CSV: ${csvText.length} bytes`);\n    if (csvText.length < 10) {\n        console.warn(\"[DEBUG] CSV too short/empty\");\n        logErrorAndAlert(\"Erro: Arquivo vazio ou inv\u00e1lido recebido.\");\n        return;\n    }\n\n    currentCSVData = [];\n    uniqueVDSValues = [];\n\n    const lines = csvText.trim().split('\\n');\n    let dataStartIndex = -1;\n    const analysisMap = {};\n\n    console.log(`[DEBUG] Total lines: ${lines.length}`);\n\n    // 1. Scan for header and metadata first\n    for (let i = 0; i < lines.length; i++) { // Scan all lines, header might be anywhere\n        const line = lines[i].trim();\n\n        // Detect column header line (timestamp,vds...)\n        if (line.includes('timestamp,vds') || line.includes('time,vds')) {\n            dataStartIndex = i + 1;\n            console.log(`[DEBUG] Found header at line ${i}: ${line}`);\n        }\n\n        // DETECT SWEEP MODE from header: \"# Sweep Mode: VGS\" or \"# Sweep Mode: VDS\"\n        if (line.startsWith('# Sweep Mode:')) {\n            const modeMatch = line.match(/# Sweep Mode:\\s*(VGS|VDS)/i);\n            if (modeMatch) {\n                currentSweepMode = modeMatch[1].toUpperCase();\n                console.log(`[DEBUG] Detected sweep mode: ${currentSweepMode}`);\n            }\n        }\n\n        // Parse Analysis Metadata: \"# VDS=0.50V: Vt=1.200V, SS=85.00 mV/dec, MaxGm=1.200e-03 S\"\n        if (line.startsWith('# VDS=')) {\n            try {\n                const vdsMatch = line.match(/VDS=([\\d\\.]+)V/);\n                const vtMatch = line.match(/Vt=([\\d\\.]+)V/);\n                const ssMatch = line.match(/SS=([0-9\\.]+)\\s?mV\\/dec/); // flexible space\n                const gmMatch = line.match(/MaxGm=([0-9\\.eE\\-\\+]+)\\s?S/);\n\n                if (vdsMatch) {\n                    const vdsVal = parseFloat(vdsMatch[1]);\n                    const vdsKey = Math.round(vdsVal * 1000) / 1000;\n                    analysisMap[vdsKey] = {\n                        vt: vtMatch ? parseFloat(vtMatch[1]) : 0,\n                        ss: ssMatch ? parseFloat(ssMatch[1]) : 0,\n                        max_gm: gmMatch ? parseFloat(gmMatch[1]) : 0\n                    };\n                    // console.log(`[DEBUG] Meta VDS=${vdsKey}`, analysisMap[vdsKey]);\n                }\n            } catch (e) {\n                console.warn(\"Mdata parse err:\", line);\n            }\n        }\n    }\n\n    // Fallback: If no header found, guess\n    if (dataStartIndex === -1) {\n        console.warn(\"[DEBUG] No header found. Guessing start index...\");\n        for (let i = 0; i < lines.length; i++) {\n            // First line that is NOT a comment and has commas is likely data\n            if (!lines[i].trim().startsWith('#') && lines[i].includes(',')) {\n                dataStartIndex = i;\n                console.log(`[DEBUG] Guessed start index: ${i}`);\n                break;\n            }\n        }\n        if (dataStartIndex === -1) dataStartIndex = 0;\n    }\n\n    const vdsSet = new Set();\n    let rowErrorCount = 0;\n\n    for (let i = dataStartIndex; i < lines.length; i++) {\n        const parts = lines[i].split(',');\n        if (parts.length < 5) {\n            // console.warn(`[DEBUG] Skipping short line ${i}: ${lines[i]}`);\n            continue;\n        }\n\n        // Enhanced Format: timestamp,vds,vgs,vsh,ids,gm\n        // Legacy Format: timestamp,vds,vgs,vsh,ids,gm,vt,ss\n\n        const vds = parseFloat(parts[1]);\n        const vgs = parseFloat(parts[2]);\n        const vsh = parseFloat(parts[3]);\n        const ids = parseFloat(parts[4]);\n        const gm = parseFloat(parts[5]);\n\n        // Legacy fallback\n        let vt = (parts.length > 6) ? parseFloat(parts[6]) : 0;\n        let ss = (parts.length > 7) ? parseFloat(parts[7]) : 0;\n\n        if (!isNaN(vds) && !isNaN(vgs)) {\n            const vdsRounded = Math.round(vds * 1000) / 1000;\n            vdsSet.add(vdsRounded);\n\n            // If we have metadata from header, override Vt/SS\n            if (analysisMap[vdsRounded]) {\n                vt = analysisMap[vdsRounded].vt;\n                ss = analysisMap[vdsRounded].ss;\n            }\n\n            currentCSVData.push({\n                vds: vdsRounded,\n                vgs: vgs,\n                vsh: vsh,\n                ids: isNaN(ids) ? 0 : ids,\n                gm: isNaN(gm) ? 0 : gm, // Will be recalculated if 0\n                vt: vt,\n                ss: ss,\n                max_gm: analysisMap[vdsRounded] ? analysisMap[vdsRounded].max_gm : 0\n            });\n        } else {\n            rowErrorCount++;\n        }\n    }\n\n    // Sort VDS values\n    uniqueVDSValues = Array.from(vdsSet).sort((a, b) => a - b);\n\n    // Recalculate Gm if missing (since backend streaming doesn't include it per point)\n    calculateGmForData(currentCSVData, currentSweepMode);\n    calculateSSForData(currentCSVData); // Recalculate SS for frontend visualization\n\n    console.log(`[DEBUG] Parsed ${currentCSVData.length} valid points. Unique VDS:`, uniqueVDSValues);\n\n    if (currentCSVData.length === 0) {\n        console.error(\"[DEBUG] No valid data points found!\");\n        logErrorAndAlert(\"Erro: Nenhum dado v\u00e1lido encontrado no arquivo CSV.\");\n    }\n}\n\n// Helper to show errors in UI and Alert\nfunction logErrorAndAlert(msg) {\n    showToast(msg, 'error');\n    console.error('[CSV ERROR] ' + msg);\n    const logContent = document.getElementById('log-content');\n    if (logContent) {\n        const entry = document.createElement('div');\n        entry.className = 'log-entry log-error';\n        entry.style.color = '#ff4444';\n        entry.textContent = '[ERRO] ' + msg;\n        logContent.insertBefore(entry, logContent.firstChild);\n    }\n}\n\n// Helper to calculate Gm (dIds/dVgs) if missing or 0\nfunction calculateGmForData(data, sweepMode) {\n    if (!data || data.length < 2) return;\n\n    // Group by curve (VDS in VGS mode, VGS in VDS mode)\n    const curves = {};\n    data.forEach(d => {\n        const key = sweepMode === 'VDS' ? d.vgs : d.vds;\n        if (!curves[key]) curves[key] = [];\n        curves[key].push(d);\n    });\n\n    // Calculate Gm for each curve\n    Object.keys(curves).forEach(k => {\n        const curve = curves[k];\n        // Sort by X-axis (VGS in VGS mode, VDS in VDS mode)\n        curve.sort((a, b) => (sweepMode === 'VDS' ? a.vds - b.vds : a.vgs - b.vgs));\n\n        for (let i = 1; i < curve.length - 1; i++) {\n            // Central difference\n            const prev = curve[i - 1];\n            const next = curve[i + 1];\n\n            const dx = sweepMode === 'VDS' ? (next.vds - prev.vds) : (next.vgs - prev.vgs);\n            const dy = next.ids - prev.ids;\n\n            if (Math.abs(dx) > 1e-6) {\n                curve[i].gm = dy / dx;\n            }\n        }\n    });\n}\n\n// Helper to calculate SS (d Vgs / d log10(Ids))\nfunction calculateSSForData(data) {\n    if (!data || data.length < 5) return;\n\n    // Group by curve (assume VGS mode for SS calculation usually)\n    const curves = {};\n\n    data.forEach(d => {\n        const key = d.vds;\n        if (!curves[key]) curves[key] = [];\n        curves[key].push(d);\n    });\n\n    Object.keys(curves).forEach(k => {\n        const curve = curves[k];\n        curve.sort((a, b) => a.vgs - b.vgs);\n\n        let bestSS = 0;\n\n        for (let i = 1; i < curve.length - 1; i++) {\n            const currentIds = Math.abs(curve[i].ids);\n\n            // Allow wider range for calculation, filter later\n            if (currentIds > 1e-12) {\n                const prev = curve[i - 1];\n                const next = curve[i + 1];\n\n                const dVgs = next.vgs - prev.vgs;\n                const dLogIds = Math.log10(Math.abs(next.ids)) - Math.log10(Math.abs(prev.ids));\n\n                if (Math.abs(dVgs) > 1e-6 && Math.abs(dLogIds) > 1e-6) {\n                    const slope = dLogIds / dVgs; // decades per volt\n                    if (slope > 0.01) {\n                        const localSS = (1 / slope) * 1000; // mV/dec\n                        curve[i].ss_instant = localSS; // Store for plotting\n\n                        // Find min valid SS (steepest slope) in subthreshold region\n                        // Filter out noise: SS should be reasonable (e.g. > 20 mV/dec)\n                        if (currentIds < 1e-4) {\n                            if ((bestSS === 0 || localSS < bestSS) && localSS > 20) {\n                                bestSS = localSS;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        // Assign calculated min SS to all points\n        if (bestSS > 0) {\n            curve.forEach(p => p.ss = bestSS);\n        }\n    });\n}\n\n\n// Multi-curve plot function that respects toggle buttons\nfunction updatePlotsMultiCurve() {\n    const vdsSelect = document.getElementById('vds-select');\n    const selectedVDS = vdsSelect ? vdsSelect.value : null;\n\n    if (currentCSVData.length === 0) return;\n\n    const traces = [];\n    const colors = {\n        ids: '#2196F3',  // Blue\n        gm: '#FF9800',   // Orange\n        ss: '#F44336',   // Red\n        vt: '#4CAF50'    // Green\n    };\n\n    // Get data for selected curve value\n    const curveVal = parseFloat(selectedVDS) || (uniqueVDSValues.length > 0 ? uniqueVDSValues[0] : 0);\n\n    let plotData;\n    if (currentSweepMode === 'VDS') {\n        plotData = currentCSVData.filter(d => Math.abs(d.vgs - curveVal) < 0.001);\n        plotData.sort((a, b) => a.vds - b.vds);\n    } else {\n        plotData = currentCSVData.filter(d => Math.abs(d.vds - curveVal) < 0.001);\n        plotData.sort((a, b) => a.vgs - b.vgs);\n    }\n\n    if (plotData.length === 0) return;\n\n    const xData = currentSweepMode === 'VDS' ? plotData.map(d => d.vds) : plotData.map(d => d.vgs);\n\n    // Disable incompatible toggles in VDS mode\n    const toggleGm = document.getElementById('toggle-gm');\n    const toggleSs = document.getElementById('toggle-ss');\n    const toggleVt = document.getElementById('toggle-vt');\n\n    if (currentSweepMode === 'VDS') {\n        if (toggleGm) { toggleGm.disabled = true; toggleGm.style.opacity = \"0.3\"; toggleGm.style.pointerEvents = \"none\"; }\n        if (toggleSs) { toggleSs.disabled = true; toggleSs.style.opacity = \"0.3\"; toggleSs.style.pointerEvents = \"none\"; }\n        if (toggleVt) { toggleVt.disabled = true; toggleVt.style.opacity = \"0.3\"; toggleVt.style.pointerEvents = \"none\"; }\n        visibleCurves.gm = false;\n        visibleCurves.ss = false;\n        visibleCurves.vt = false;\n        toggleGm?.classList.remove('active');\n        toggleSs?.classList.remove('active');\n        toggleVt?.classList.remove('active');\n    } else {\n        if (toggleGm) { toggleGm.disabled = false; toggleGm.style.opacity = \"1\"; toggleGm.style.pointerEvents = \"auto\"; }\n        if (toggleSs) { toggleSs.disabled = false; toggleSs.style.opacity = \"1\"; toggleSs.style.pointerEvents = \"auto\"; }\n        if (toggleVt) { toggleVt.disabled = false; toggleVt.style.opacity = \"1\"; toggleVt.style.pointerEvents = \"auto\"; }\n    }\n\n    // Trace 1: Ids\n    if (visibleCurves.ids) {\n        traces.push({\n            x: xData,\n            y: plotData.map(d => d.ids),\n            mode: 'lines+markers',\n            type: 'scatter',\n            name: 'Ids (A)',\n            yaxis: 'y',\n            line: { color: colors.ids, shape: 'spline' },\n            marker: { size: 4 }\n        });\n    }\n\n    // Trace 2: Gm\n    if (visibleCurves.gm) {\n        traces.push({\n            x: xData,\n            y: plotData.map(d => d.gm),\n            mode: 'lines+markers',\n            type: 'scatter',\n            name: 'Gm (S)',\n            yaxis: 'y2',\n            line: { color: colors.gm, shape: 'spline' },\n            marker: { size: 4 }\n        });\n    }\n\n    // Trace 3: SS (Instantaneous)\n    if (visibleCurves.ss) {\n        // Filter out undefined SS points\n        const validSS = plotData.map((d, i) => ({ x: xData[i], y: d.ss_instant }));\n        const xSS = validSS.filter(p => p.y && p.y < 5000).map(p => p.x); // Filter huge spikes\n        const ySS = validSS.filter(p => p.y && p.y < 5000).map(p => p.y);\n\n        if (ySS.length > 0) {\n            traces.push({\n                x: xSS,\n                y: ySS,\n                mode: 'lines+markers',\n                type: 'scatter',\n                name: 'SS (mV/dec)',\n                yaxis: 'y3', // Separate axis for SS\n                line: { color: colors.ss, shape: 'spline', dash: 'dot' },\n                marker: { size: 3 }\n            });\n        }\n    }\n\n    // Vt and SS are now scalar values per curve, so we visualize them differently\n    const vtValue = plotData.length > 0 ? plotData[0].vt : 0;\n    const ssValue = plotData.length > 0 ? plotData[0].ss : 0;\n    const maxGmValue = plotData.length > 0 ? plotData[0].max_gm : 0;\n\n    // Count active secondary axes (only Gm is a trace now)\n    const secondaryAxes = [visibleCurves.gm].filter(v => v).length;\n\n    // Calculate right margin\n    const rightMargin = 60 + (secondaryAxes * 50);\n    const xDomainEnd = secondaryAxes > 0 ? 1 - (secondaryAxes * 0.08) : 1;\n\n    // Construct Title with Analysis Results - use dynamic label based on sweep mode\n    const curveLabel = currentSweepMode === 'VDS' ? 'VGS' : 'VDS';\n    const curveValue = parseFloat(selectedVDS || uniqueVDSValues[0] || 0).toFixed(3);\n    let titleText = `Curvas MOSFET (${curveLabel} = ${curveValue} V)`;\n    titleText += `<br><span style=\"font-size: 12px; color: #ccc;\">`;\n    titleText += `Vt: <b>${vtValue.toFixed(3)} V</b> | `;\n    titleText += `SS: <b>${ssValue.toFixed(3)} mV/dec</b> | `;\n    titleText += `MaxGm: <b>${maxGmValue.toExponential(2)} S</b>`;\n    titleText += `</span>`;\n\n    // X-axis label depends on sweep mode\n    const xAxisLabel = currentSweepMode === 'VDS' ? 'VDS (V)' : 'VGS (V)';\n\n    const layout = {\n        title: {\n            text: titleText,\n            font: { color: '#ffffff' }\n        },\n        paper_bgcolor: 'rgba(0,0,0,0)',\n        plot_bgcolor: 'rgba(255,255,255,0.02)',\n        font: { color: '#bdbdbd' },\n\n        xaxis: {\n            title: xAxisLabel,\n            domain: [0, xDomainEnd],\n            gridcolor: '#333',\n            zerolinecolor: '#666'\n        },\n        yaxis: {\n            title: 'Ids (A)',\n            titlefont: { color: colors.ids },\n            tickfont: { color: colors.ids },\n            side: 'left',\n            gridcolor: '#333'\n        },\n        yaxis2: {\n            title: 'Gm (S)',\n            titlefont: { color: colors.gm },\n            tickfont: { color: colors.gm },\n            anchor: 'free',\n            overlaying: 'y',\n            side: 'right',\n            position: xDomainEnd,\n            showgrid: false\n        },\n        yaxis3: {\n            title: 'SS (mV/dec)',\n            titlefont: { color: colors.ss },\n            tickfont: { color: colors.ss },\n            anchor: 'free',\n            overlaying: 'y',\n            side: 'right',\n            position: xDomainEnd + 0.08, // Offset to right of Gm\n            showgrid: false,\n            // Only show if SS visible\n            visible: visibleCurves.ss\n        },\n        margin: { t: 80, r: rightMargin, l: 60, b: 60 },\n        showlegend: true,\n        legend: { x: 0, y: 1.1, orientation: 'h', font: { color: '#e0e0e0' } },\n\n        shapes: [],\n        annotations: []\n    };\n\n    // Add Vt Line if visible\n    if (visibleCurves.vt && vtValue > 0) {\n        layout.shapes.push({\n            type: 'line',\n            x0: vtValue,\n            x1: vtValue,\n            y0: 0,\n            y1: 1,\n            xref: 'x',\n            yref: 'paper',\n            line: {\n                color: colors.vt,\n                width: 2,\n                dash: 'dash'\n            }\n        });\n        layout.annotations.push({\n            x: vtValue,\n            y: 0,\n            xref: 'x',\n            yref: 'paper',\n            text: `Vt`,\n            showarrow: false,\n            yshift: 10,\n            font: { color: colors.vt, size: 12 }\n        });\n    }\n    let plotDiv = document.getElementById('plot-container');\n    if (!plotDiv) {\n        console.warn(\"No chart container found (plot-container)\");\n        return;\n    }\n\n    if (window.Plotly) {\n        Plotly.newPlot(plotDiv, traces, layout, { responsive: true });\n    } else {\n        plotDiv.textContent = \"Erro: Biblioteca Plotly n\u00e3o carregada.\";\n    }\n\n    // Update metrics cards\n    updateMetrics(plotData);\n}\n\n// Update metric cards with calculated values\n// Update metric cards with calculated values\nfunction updateMetrics(plotData) {\n    const vtEl = document.getElementById('metric-vt');\n    const gmEl = document.getElementById('metric-gm');\n    const ssEl = document.getElementById('metric-ss');\n\n    if (currentSweepMode === 'VDS') {\n        const msg = \"N\u00e3o cont\u00e9m em Curva VDS\";\n        if (vtEl) {\n            vtEl.textContent = msg;\n            vtEl.style.fontSize = \"14px\"; // Adjust font size for longer text\n        }\n        if (gmEl) {\n            gmEl.textContent = msg;\n            gmEl.style.fontSize = \"14px\";\n        }\n        if (ssEl) {\n            ssEl.textContent = msg;\n            ssEl.style.fontSize = \"14px\";\n        }\n        return;\n    }\n\n    if (!plotData || plotData.length === 0) return;\n\n    // Reset font size\n    if (vtEl) vtEl.style.fontSize = \"\";\n    if (gmEl) gmEl.style.fontSize = \"\";\n    if (ssEl) ssEl.style.fontSize = \"\";\n\n    // Find max Gm and corresponding Vt\n    let maxGm = 0;\n    let vtAtMaxGm = 0;\n    let avgSS = 0;\n    let ssCount = 0;\n\n    plotData.forEach(d => {\n        if (d.gm > maxGm) {\n            maxGm = d.gm;\n            vtAtMaxGm = d.vt;\n        }\n        if (d.ss > 0 && d.ss < 1000) { // Filter unreasonable SS values\n            avgSS += d.ss;\n            ssCount++;\n        }\n    });\n\n    avgSS = ssCount > 0 ? avgSS / ssCount : 0;\n\n    if (vtEl) vtEl.textContent = `${vtAtMaxGm.toFixed(3)} V`;\n    if (gmEl) gmEl.textContent = `${(maxGm * 1000).toFixed(3)} mS`;\n    if (ssEl) ssEl.textContent = `${avgSS.toFixed(3)} mV/dec`;\n}\n\n// Listen for VDS changes\ndocument.getElementById('vds-select')?.addEventListener('change', updatePlotsMultiCurve);\n\n\n// Fix #10: Download measurement button - now downloads the SELECTED file\ndocument.getElementById('btn-download-measurement')?.addEventListener('click', async () => {\n    const selectedValue = document.getElementById('file-select').value;\n\n    if (!selectedValue || selectedValue === '') {\n        alert('\u26a0\ufe0f Selecione uma medida primeiro');\n        return;\n    }\n\n    try {\n        const response = await fetch(`/api/files/download?file=${encodeURIComponent(selectedValue)}`);\n\n        if (!response.ok) {\n            throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n        }\n\n        const contentDisposition = response.headers.get('Content-Disposition');\n        let filename = selectedValue;\n        if (contentDisposition) {\n            const match = contentDisposition.match(/filename=\"?([^\"]+)\"?/);\n            if (match) filename = match[1];\n        }\n\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = filename;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n\n        console.log(`Downloaded: ${filename}`);\n    } catch (error) {\n        alert(`\u274c Erro ao baixar CSV: ${error.message}`);\n        console.error('Download error:', error);\n    }\n});\n\n// Floating Logs Window Controls\nconst logsWindow = document.getElementById('floating-logs-window');\nconst logsHeader = document.getElementById('logs-window-header');\nlet isDragging = false;\nlet currentX, currentY, initialX, initialY;\n\n// Open logs window\ndocument.getElementById('btn-open-logs')?.addEventListener('click', () => {\n    logsWindow.style.display = 'flex';\n});\n\n// Close logs window\ndocument.getElementById('btn-close-logs')?.addEventListener('click', () => {\n    logsWindow.style.display = 'none';\n});\n\n// Make window draggable\nlogsHeader?.addEventListener('mousedown', (e) => {\n    if (e.target.closest('.floating-window-controls')) return;\n\n    isDragging = true;\n    initialX = e.clientX - logsWindow.offsetLeft;\n    initialY = e.clientY - logsWindow.offsetTop;\n    logsWindow.style.transform = 'none';\n});\n\ndocument.addEventListener('mousemove', (e) => {\n    if (!isDragging) return;\n\n    e.preventDefault();\n    currentX = e.clientX - initialX;\n    currentY = e.clientY - initialY;\n\n    logsWindow.style.left = `${currentX}px`;\n    logsWindow.style.top = `${currentY}px`;\n});\n\ndocument.addEventListener('mouseup', () => {\n    isDragging = false;\n});\n\n// Clear logs button (both floating and inline)\ndocument.getElementById('btn-clear-logs-float')?.addEventListener('click', () => {\n    document.getElementById('logs-container').innerHTML = '';\n});\n\n// Helper function to escape HTML and prevent XSS\nfunction escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n}\n\n// Fetch and display logs from ESP32\nasync function updateLogs() {\n    try {\n        const response = await fetch('/api/logs');\n        const logs = await response.json();\n\n        const logsContainer = document.getElementById('logs-container');\n        if (!logsContainer) return;\n\n        logsContainer.innerHTML = '';\n\n        logs.forEach(log => {\n            const logEntry = document.createElement('div');\n            logEntry.className = 'log-entry';\n\n            let levelClass = '';\n            let levelLabel = '';\n            switch (log.level) {\n                case 'error':\n                    levelClass = 'log-error';\n                    levelLabel = '[ERROR]';\n                    break;\n                case 'warn':\n                    levelClass = 'log-warn';\n                    levelLabel = '[WARN]';\n                    break;\n                case 'info':\n                    levelClass = 'log-info';\n                    levelLabel = '[INFO]';\n                    break;\n                case 'debug':\n                    levelClass = 'log-debug';\n                    levelLabel = '[DEBUG]';\n                    break;\n            }\n\n            logEntry.classList.add(levelClass);\n\n            const time = new Date(log.timestamp).toLocaleTimeString('pt-BR');\n\n            const timeSpan = document.createElement('span');\n            timeSpan.className = 'log-time';\n            timeSpan.textContent = time;\n\n            const levelSpan = document.createElement('span');\n            levelSpan.className = 'log-level';\n            levelSpan.textContent = levelLabel;\n\n            const messageSpan = document.createElement('span');\n            messageSpan.className = 'log-message';\n            messageSpan.textContent = log.message;\n\n            logEntry.appendChild(timeSpan);\n            logEntry.appendChild(levelSpan);\n            logEntry.appendChild(messageSpan);\n\n            logsContainer.appendChild(logEntry);\n        });\n    } catch (error) {\n        console.error('Error fetching logs:', error);\n    }\n}\n\n// Clear logs button handler\ndocument.getElementById('btn-clear-logs')?.addEventListener('click', async () => {\n    try {\n        await fetch('/api/logs/clear', { method: 'POST' });\n        updateLogs(); // Refresh display\n    } catch (error) {\n        console.error('Error clearing logs:', error);\n    }\n});\n\n// Start real-time monitoring\nupdateSystemInfo();\nsetInterval(updateSystemInfo, 1000);\n\nloadMeasurementList();\nsetInterval(loadMeasurementList, 10000);\n\nupdateLogs();\nsetInterval(updateLogs, 2000);\n\n// =============================================================================\n// Scroll-to-change functionality for select elements\n// Allows changing select options by scrolling with mouse wheel while hovering\n// =============================================================================\nfunction enableScrollOnSelect(selectElement) {\n    if (!selectElement) return;\n\n    selectElement.addEventListener('wheel', (e) => {\n        // Only act if element is not disabled\n        if (selectElement.disabled) return;\n\n        // Prevent page scroll\n        e.preventDefault();\n\n        const options = selectElement.options;\n        const currentIndex = selectElement.selectedIndex;\n\n        // Determine scroll direction\n        const direction = e.deltaY > 0 ? 1 : -1;\n\n        // Calculate new index with bounds checking\n        let newIndex = currentIndex + direction;\n\n        // Skip empty/placeholder options (value === \"\")\n        while (newIndex >= 0 && newIndex < options.length && options[newIndex].value === \"\") {\n            newIndex += direction;\n        }\n\n        // Clamp to valid range\n        if (newIndex < 0) newIndex = 0;\n        if (newIndex >= options.length) newIndex = options.length - 1;\n\n        // Skip if landing on placeholder\n        if (options[newIndex].value === \"\" && currentIndex !== newIndex) {\n            return;\n        }\n\n        // Only update if changed\n        if (newIndex !== currentIndex && options[newIndex].value !== \"\") {\n            selectElement.selectedIndex = newIndex;\n\n            // Dispatch change event to trigger any listeners\n            selectElement.dispatchEvent(new Event('change', { bubbles: true }));\n        }\n    }, { passive: false });\n\n    // Visual feedback on hover\n    selectElement.addEventListener('mouseenter', () => {\n        selectElement.style.cursor = 'ns-resize';\n    });\n\n    selectElement.addEventListener('mouseleave', () => {\n        selectElement.style.cursor = '';\n    });\n}\n\n// Apply to all select-field elements\ndocument.querySelectorAll('.select-field').forEach(select => {\n    enableScrollOnSelect(select);\n});\n\n// Also apply to dynamically created selects (MutationObserver)\nconst selectObserver = new MutationObserver((mutations) => {\n    mutations.forEach((mutation) => {\n        mutation.addedNodes.forEach((node) => {\n            if (node.nodeType === 1) { // Element node\n                if (node.classList?.contains('select-field')) {\n                    enableScrollOnSelect(node);\n                }\n                // Check children\n                node.querySelectorAll?.('.select-field').forEach(select => {\n                    enableScrollOnSelect(select);\n                });\n            }\n        });\n    });\n});\n\nselectObserver.observe(document.body, { childList: true, subtree: true });\n\nconsole.log('MOSFET Characterization Dashboard initialized (Multi-Page Architecture)');\n\n// Feature: Real-time Filename Validation\ndocument.getElementById('filename')?.addEventListener('input', (e) => {\n    const input = e.target;\n    const infoText = input.nextElementSibling; // helper-text\n    const validRegex = /^[a-zA-Z0-9_\\-\\.]+$/;\n\n    if (input.value && !validRegex.test(input.value)) {\n        input.style.borderColor = \"#F44336\"; // Red\n        if (infoText) {\n            infoText.style.color = \"#F44336\";\n            infoText.textContent = \"Nome inv\u00e1lido! Use apenas letras, n\u00fameros, _ . ou -\";\n        }\n    } else {\n        input.style.borderColor = \"\"; // Reset\n        if (infoText) {\n            infoText.style.color = \"\";\n            infoText.textContent = \"Arquivo com timestamps, VDS, VGS, Vsh, Ids, Gm, par\u00e2metros\"; // Restore original text or keep empty if dynamic\n        }\n    }\n});\n\n// Feature: Delete Single Measurement Logic from Visualization Tab\ndocument.getElementById('btn-delete-measurement')?.addEventListener('click', async () => {\n    const selectedValue = document.getElementById('file-select').value;\n    if (!selectedValue) return;\n\n    if (!confirm(`Tem certeza que deseja deletar o arquivo \"${selectedValue}\"?\\nEsta a\u00e7\u00e3o \u00e9 irrevers\u00edvel.`)) {\n        return;\n    }\n\n    try {\n        const response = await fetch(`/api/files/delete?file=${encodeURIComponent(selectedValue)}`, { method: 'POST' });\n        if (!response.ok) throw new Error(\"Falha ao deletar arquivo\");\n\n        showToast(`Arquivo \"${selectedValue}\" deletado com sucesso.`, 'success');\n\n        // Reset plots\n        currentCSVData = [];\n        const plotDiv = document.getElementById('plot-container');\n        if (plotDiv) Plotly.purge(plotDiv);\n\n        // Reset selection UI\n        const downloadBtn = document.getElementById('btn-download-measurement');\n        const deleteBtn = document.getElementById('btn-delete-measurement');\n        const vdsSelect = document.getElementById('vds-select');\n        const fileSelect = document.getElementById('file-select');\n\n        if (downloadBtn) downloadBtn.disabled = true;\n        if (deleteBtn) deleteBtn.disabled = true;\n        if (vdsSelect) {\n            vdsSelect.innerHTML = '<option value=\"\">Aguardando arquivo...</option>';\n            vdsSelect.disabled = true;\n        }\n        if (fileSelect) fileSelect.value = \"\";\n\n        // Clear global selection\n        currentSelectedFile = \"\";\n\n        // Reload File List\n        loadMeasurementList();\n\n    } catch (error) {\n        logErrorAndAlert(\"Erro ao deletar arquivo\", error);\n    }\n});\n\n// Feature: Delete All Logic from Main Page\ndocument.getElementById('btn-delete-all')?.addEventListener('click', async () => {\n    // 1st Confirmation\n    if (!confirm(\"\u26a0\ufe0f ATEN\u00c7\u00c3O \u26a0\ufe0f\\n\\nTem certeza que deseja DELETAR TODOS os arquivos de medi\u00e7\u00e3o?\\n\\nEsta a\u00e7\u00e3o apagar\u00e1 todo o hist\u00f3rico de medidas salvas no ESP32.\")) {\n        return;\n    }\n\n    // 2nd Confirmation (Irreversible)\n    if (!confirm(\"\u26d4 CONFIRMA\u00c7\u00c3O FINAL \u26d4\\n\\nEsta a\u00e7\u00e3o \u00e9 IRREVERS\u00cdVEL.\\nTodos os dados ser\u00e3o perdidos permanentemente.\\n\\nDeseja realmente continuar e apagar TUDO?\")) {\n        return;\n    }\n\n    try {\n        const response = await fetch('/api/files/delete-all', { method: 'POST' });\n        if (!response.ok) throw new Error(\"Falha ao deletar todos os arquivos\");\n\n        showToast(\"Todos os arquivos foram deletados com sucesso.\", 'success');\n\n        // Reset UI\n        currentCSVData = [];\n        loadMeasurementList();\n\n    } catch (error) {\n        logErrorAndAlert(\"Erro ao limpar armazenamento\", error);\n    }\n});\nconsole.log('Scroll-to-change enabled on select elements');\n\n";
}
